<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matematika Kuis</title>
    <link rel="icon" type="image/x-icon" href="assets/iconnew.png" />
    <style>
        :root {
            --primary: #4a6bff;
            --secondary: #f5f7ff;
            --accent: #ff6b6b;
            --text: #333;
            --light-text: #666;
            --background: #fff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --dark-bg: #1a1a2e;
            --dark-secondary: #16213e;
            --dark-text: #f5f7ff;
            --success: #6bce70;
            --warning: #f0ad4e;
            --danger: #d9534f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--secondary);
            color: var(--text);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background-color: var(--background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .dark-mode header {
            background-color: var(--dark-secondary);
            color: var(--dark-text);
        }

        h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .difficulty-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .difficulty-btn:hover {
            transform: translateY(-3px);
        }

        .easy {
            background-color: #6bce70;
            color: white;
        }

        .medium {
            background-color: #f0ad4e;
            color: white;
        }

        .hard {
            background-color: #d9534f;
            color: white;
        }

        .extreme {
            background-color: #5d3a9b;
            color: white;
        }

        .settings-panel {
            background-color: var(--background);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .dark-mode .settings-panel {
            background-color: var(--dark-secondary);
        }

        .settings-title {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .settings-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .quiz-container {
            display: none;
            background-color: var(--background);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .dark-mode .quiz-container {
            background-color: var(--dark-secondary);
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .dark-mode .quiz-header {
            border-bottom-color: #444;
        }

        .level-info {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .score-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .score {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .question-container {
            margin-bottom: 30px;
        }

        .question {
            font-size: 1.3rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .answer-field {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            margin-bottom: 15px;
            transition: all 0.3s;
            background-color: var(--background);
            color: var(--text);
        }

        .dark-mode .answer-field {
            background-color: #16213e;
            border-color: #444;
            color: var(--dark-text);
        }

        .answer-field:focus {
            border-color: var(--primary);
            outline: none;
        }

        .answer-field.correct {
            border-color: var(--success);
            animation: pulseCorrect 0.5s;
        }

        .answer-field.incorrect {
            border-color: var(--danger);
            animation: shake 0.5s;
        }

        @keyframes pulseCorrect {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .answer-options {
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .option-btn {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            background-color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .dark-mode .option-btn {
            background-color: #16213e;
            border-color: #444;
            color: var(--dark-text);
        }

        .option-btn:hover {
            border-color: var(--primary);
            background-color: var(--secondary);
        }

        .dark-mode .option-btn:hover {
            background-color: #1a1a2e;
        }

        .quiz-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .hint-btn {
            background-color: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--light-text);
            transition: color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dark-mode .hint-btn {
            color: #aaa;
        }

        .hint-btn:hover {
            color: var(--primary);
        }

        .submit-btn {
            padding: 12px 25px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .submit-btn:hover {
            background-color: #3a5bed;
        }
        
        .clear-btn {
            background-color: #6c757d;
        }
        .clear-btn:hover {
            background-color: #5a6268;
        }

        .scratch-pad {
            margin-top: 30px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            height: 200px;
            width: 100%;
            background-color: white;
            position: relative;
        }

        .dark-mode .scratch-pad {
            border-color: #444;
            background-color: #16213e;
        }

        .scratch-texture {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.1;
            background-size: 40px 40px;
            background-image: linear-gradient(to right, grey 1px, transparent 1px),
                              linear-gradient(to bottom, grey 1px, transparent 1px);
        }

        .stats-container {
            background-color: var(--background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: none;
            transition: all 0.3s ease;
        }

        .dark-mode .stats-container {
            background-color: var(--dark-secondary);
        }

        .stats-title {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background-color: var(--secondary);
            padding: 15px;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
        }

        .dark-mode .stat-item {
            background-color: #1a1a2e;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--light-text);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .hint-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .hint-modal.show {
            display: flex;
            opacity: 1;
        }

        .hint-content {
            background-color: var(--background);
            padding: 25px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            transform: scale(0.9);
            opacity: 0;
            animation: modalFadeIn 0.3s forwards;
        }

        .dark-mode .hint-content {
            background-color: var(--dark-secondary);
        }

        .hint-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .hint-title {
            color: var(--primary);
            font-size: 1.3rem;
        }

        .close-hint {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
        }

        .hint-text {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .hint-points {
            color: var(--accent);
            font-weight: bold;
        }

        .result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .result-modal.show {
            display: flex;
            opacity: 1;
        }

        .result-content {
            background-color: var(--background);
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            transform: scale(0.9);
            opacity: 0;
            animation: modalFadeIn 0.3s forwards;
        }

        .dark-mode .result-content {
            background-color: var(--dark-secondary);
        }

        .result-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .correct {
            color: #6bce70;
        }

        .incorrect {
            color: #d9534f;
        }

        .result-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .result-message {
            margin-bottom: 20px;
            color: var(--light-text);
            line-height: 1.5;
        }

        .result-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .next-btn {
            background-color: var(--primary);
            color: white;
        }

        .next-btn:hover {
            background-color: #3a5bed;
        }

        .home-btn {
            background-color: #eee;
            color: var(--text);
        }

        .dark-mode .home-btn {
            background-color: #444;
            color: var(--dark-text);
        }

        .home-btn:hover {
            background-color: #ddd;
        }

        .dark-mode .home-btn:hover {
            background-color: #555;
        }

        /* New styles for additional features */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: transform 0.3s;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .timer-container {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 1.1rem;
        }

        .timer {
            font-weight: bold;
            color: var(--primary);
        }

        .streak-container {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 15px;
        }

        .streak-count {
            font-weight: bold;
            color: #ff9500;
        }

        .leaderboard-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background-color: #5d3a9b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: transform 0.3s;
        }

        .leaderboard-btn:hover {
            transform: scale(1.1);
        }

        .daily-challenge-btn {
            position: fixed;
            bottom: 140px;
            right: 20px;
            background-color: #6bce70;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: transform 0.3s;
        }

        .daily-challenge-btn:hover {
            transform: scale(1.1);
        }

        .coin-shop-btn {
            position: fixed;
            bottom: 200px;
            right: 20px;
            background-color: #ffd700;
            color: #333;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: transform 0.3s;
        }

        .coin-shop-btn:hover {
            transform: scale(1.1);
        }

        .leaderboard-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .leaderboard-modal.show {
            display: flex;
            opacity: 1;
        }

        .leaderboard-content {
            background-color: var(--background);
            padding: 25px;
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 90%;
            box-shadow: var(--shadow);
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            opacity: 0;
            animation: modalFadeIn 0.3s forwards;
        }

        .dark-mode .leaderboard-content {
            background-color: var(--dark-secondary);
        }

        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .leaderboard-title {
            color: var(--primary);
            font-size: 1.5rem;
        }

        .close-leaderboard {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th, 
        .leaderboard-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .dark-mode .leaderboard-table th,
        .dark-mode .leaderboard-table td {
            border-bottom-color: #444;
        }

        .leaderboard-table th {
            background-color: var(--secondary);
            font-weight: bold;
        }

        .dark-mode .leaderboard-table th {
            background-color: #1a1a2e;
        }

        .leaderboard-table tr:nth-child(even) {
            background-color: var(--secondary);
        }

        .dark-mode .leaderboard-table tr:nth-child(even) {
            background-color: #1a1a2e;
        }

        .user-rank {
            font-weight: bold;
            color: var(--primary);
        }

        .share-btn {
            background-color: #4a6bff;
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .share-btn:hover {
            background-color: #3a5bed;
        }

        .daily-challenge-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .daily-challenge-modal.show {
            display: flex;
            opacity: 1;
        }

        .daily-challenge-content {
            background-color: var(--background);
            padding: 25px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow);
            transform: scale(0.9);
            opacity: 0;
            animation: modalFadeIn 0.3s forwards;
        }

        .dark-mode .daily-challenge-content {
            background-color: var(--dark-secondary);
        }

        .daily-challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .daily-challenge-title {
            color: var(--primary);
            font-size: 1.5rem;
        }

        .close-daily-challenge {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
        }

        .daily-challenge-badge {
            display: inline-block;
            background-color: #6bce70;
            color: white;
            padding: 5px 10px;
            border-radius: var(--border-radius);
            font-weight: bold;
            margin-bottom: 15px;
        }

        .progress-container {
            width: 100%;
            background-color: #eee;
            border-radius: var(--border-radius);
            margin: 15px 0;
            height: 20px;
        }

        .dark-mode .progress-container {
            background-color: #444;
        }

        .progress-bar {
            height: 100%;
            border-radius: var(--border-radius);
            background-color: var(--primary);
            width: 0%;
            transition: width 0.5s ease;
        }

        .fun-fact {
            background-color: var(--secondary);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            font-style: italic;
            position: relative;
            overflow: hidden;
            min-height: 60px;
            transition: all 0.3s ease;
        }

        .dark-mode .fun-fact {
            background-color: #1a1a2e;
        }

        .fun-fact-content {
            position: relative;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fun-fact strong {
            display: block;
            margin-bottom: 5px;
            color: var(--primary);
        }

        .fun-fact::before {
            content: "💡";
            position: absolute;
            left: 10px;
            top: 10px;
            opacity: 0.2;
            font-size: 2rem;
            z-index: 0;
        }

        .fun-fact:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .fun-fact:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .streak-fire {
            color: #ff9500;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* New Features Styles */
        .achievement-popup {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--primary);
            color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1000;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        .game-mode-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .game-mode-btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            background-color: #6c757d;
            color: white;
        }

        .game-mode-btn:hover {
            transform: translateY(-3px);
        }

        .game-mode-btn.active {
            background-color: var(--primary);
        }

        .coin-display {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 1.1rem;
            margin-left: 15px;
        }

        .coin-icon {
            color: #ffd700;
        }

        .skill-progress {
            width: 100%;
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }

        .dark-mode .skill-progress {
            background-color: #444;
        }

        .skill-progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.5s ease;
        }

        .skill-item {
            margin-bottom: 15px;
        }

        .skill-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        /* Coin Shop Styles */
        .coin-shop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .coin-shop-modal.show {
            display: flex;
            opacity: 1;
        }

        .coin-shop-content {
            background-color: var(--background);
            padding: 25px;
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 90%;
            box-shadow: var(--shadow);
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            opacity: 0;
            animation: modalFadeIn 0.3s forwards;
        }

        .dark-mode .coin-shop-content {
            background-color: var(--dark-secondary);
        }

        .coin-shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .coin-shop-title {
            color: var(--primary);
            font-size: 1.5rem;
        }

        .close-coin-shop {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
        }

        .coin-shop-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .coin-shop-tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .coin-shop-tab.active {
            border-bottom-color: var(--primary);
            font-weight: bold;
        }

        .coin-shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .coin-shop-item {
            background-color: var(--secondary);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .dark-mode .coin-shop-item {
            background-color: #1a1a2e;
        }

        .coin-shop-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .coin-shop-item-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .coin-shop-item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .coin-shop-item-price {
            color: #ffd700;
            font-weight: bold;
        }

        .coin-shop-item-owned {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .coin-shop-item-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Power-ups */
        .power-ups-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .power-up-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .power-up-btn:hover {
            background-color: #3a5bed;
        }

        .power-up-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Count Animation */
        .count-up {
            transition: color 0.3s;
            display: inline-block;
        }

        .count-up.animate {
            animation: countPop 0.5s;
            color: #ffd700;
        }

        @keyframes countPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Modal Animation */
        @keyframes modalFadeIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Story Problem Styles */
        .story-problem {
            background-color: var(--secondary);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }

        .dark-mode .story-problem {
            background-color: #1a1a2e;
        }

        /* Scratch Pad Textures */
        .texture-grid {
            background-size: 20px 20px;
            background-image: linear-gradient(to right, rgba(0,0,0,0.1) 1px, transparent 1px),
                              linear-gradient(to bottom, rgba(0,0,0,0.1) 1px, transparent 1px);
        }

        .texture-dots {
            background-size: 10px 10px;
            background-image: radial-gradient(circle, rgba(0,0,0,0.1) 1px, transparent 1px);
        }

        .texture-lined {
            background-size: 100% 24px;
            background-image: linear-gradient(to bottom, rgba(0,0,0,0.1) 1px, transparent 1px);
        }

        /* Theme Preview */
        .theme-preview {
            width: 100%;
            height: 60px;
            border-radius: var(--border-radius);
            margin-top: 10px;
            border: 1px solid #ddd;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .difficulty-selector {
                flex-direction: column;
                align-items: center;
            }

            .difficulty-btn {
                width: 100%;
            }

            .answer-options {
                grid-template-columns: 1fr;
            }

            .quiz-controls {
                flex-direction: column;
                gap: 15px;
            }
            .action-buttons {
                width: 100%;
                justify-content: space-between;
            }
            .hint-btn {
                order: -1;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .theme-toggle, 
            .leaderboard-btn,
            .daily-challenge-btn,
            .coin-shop-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .leaderboard-btn {
                bottom: 70px;
            }

            .daily-challenge-btn {
                bottom: 120px;
            }

            .coin-shop-btn {
                bottom: 170px;
            }

            .achievement-popup {
                width: calc(100% - 40px);
                left: 20px;
            }

            .coin-shop-items {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 480px) {
            .coin-shop-items {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Matematika Kuis</h1>
            <p>Uji kemampuan matematika Anda dengan berbagai tingkat kesulitan!</p>
        </header>

        <div class="settings-panel">
            <h2 class="settings-title">Pengaturan</h2>
            <div class="settings-options">
                <label>
                    <span>Gunakan Opsi Jawaban:</span>
                    <label class="switch">
                        <input type="checkbox" id="useOptionsToggle">
                        <span class="slider"></span>
                    </label>
                </label>
                <label>
                    <span>Mode Gelap:</span>
                    <label class="switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </label>
            </div>
        </div>

        <div class="game-mode-selector" id="gameModeSelector">
            <button class="game-mode-btn active" data-mode="normal">Mode Normal</button>
            <button class="game-mode-btn" data-mode="speedrun">Speed Run</button>
        </div>

        <div class="difficulty-selector">
            <button class="difficulty-btn easy" data-difficulty="easy">Mudah</button>
            <button class="difficulty-btn medium" data-difficulty="medium">Menengah</button>
            <button class="difficulty-btn hard" data-difficulty="hard">Sulit</button>
            <button class="difficulty-btn extreme" data-difficulty="extreme">Ekstrem</button>
        </div>

        <div class="quiz-container" id="quizContainer">
            <div class="quiz-header">
                <div class="level-info">
                    Level <span id="currentLevel">1</span>/20 - 
                    <span id="difficultyDisplay">Mudah</span>
                    <div class="streak-container">
                        <span class="streak-fire">🔥</span>
                        <span class="streak-count" id="streakCount">0</span>
                    </div>
                    <div class="coin-display">
                        <span class="coin-icon">🪙</span>
                        <span id="coinCount">0</span>
                    </div>
                </div>
                <div class="score-container">
                    <span>Poin:</span>
                    <span class="score" id="currentScore">0</span>
                    <div class="timer-container">
                        <span>⏱️</span>
                        <span class="timer" id="timer">0</span>
                    </div>
                </div>
            </div>

            <div class="question-container">
                <div class="question" id="questionText"></div>
                
                <input type="text" class="answer-field" id="answerInput" placeholder="Masukkan jawaban Anda...">
                
                <div class="answer-options" id="answerOptions">
                </div>

                <div class="power-ups-container" id="powerUpsContainer">
                    </div>
            </div>

            <div class="quiz-controls">
                <button class="hint-btn" id="hintBtn">
                    <span>💡</span> Tips (-5 poin)
                </button>
                <div class="action-buttons">
                    <button class="submit-btn clear-btn" id="clearCanvasBtn">Bersihkan</button>
                    <button class="submit-btn" id="submitBtn">Submit</button>
                </div>
            </div>

            <div class="scratch-pad" id="scratchPad">
                <div class="scratch-texture" id="scratchTexture"></div>
            </div>
        </div>

        <div class="stats-container" id="statsContainer">
            <h2 class="stats-title">Statistik Permainan</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Waktu per Level</div>
                    <div class="stat-value" id="timePerLevel">0 detik</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Percobaan Gagal</div>
                    <div class="stat-value" id="failedAttempts">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Kecepatan</div>
                    <div class="stat-value" id="speedStat">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Tips Digunakan</div>
                    <div class="stat-value" id="hintsUsed">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Streak Terbaik</div>
                    <div class="stat-value" id="bestStreak">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Level Tertinggi</div>
                    <div class="stat-value" id="highestLevel">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total Koin</div>
                    <div class="stat-value" id="totalCoins">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Achievement</div>
                    <div class="stat-value" id="achievementCount">0/8</div>
                </div>
            </div>

            <div class="skill-item">
                <div class="skill-label">
                    <span>Aljabar</span>
                    <span id="algebraPercent">0%</span>
                </div>
                <div class="skill-progress">
                    <div class="skill-progress-bar" id="algebraProgress"></div>
                </div>
            </div>

            <div class="skill-item">
                <div class="skill-label">
                    <span>Geometri</span>
                    <span id="geometryPercent">0%</span>
                </div>
                <div class="skill-progress">
                    <div class="skill-progress-bar" id="geometryProgress"></div>
                </div>
            </div>

            <div class="skill-item">
                <div class="skill-label">
                    <span>Aritmatika</span>
                    <span id="arithmeticPercent">0%</span>
                </div>
                <div class="skill-progress">
                    <div class="skill-progress-bar" id="arithmeticProgress"></div>
                </div>
            </div>

            <button class="share-btn" id="shareBtn">
                <span>📤</span> Bagikan Hasil
            </button>
        </div>

        <div class="fun-fact" id="funFact">
            <div class="fun-fact-content">
                <strong>Fakta Menarik:</strong> Tahukah Anda bahwa angka 0.999... (angka 9 berulang tak terbatas) sebenarnya sama dengan 1?
            </div>
        </div>
    </div>

    <div class="hint-modal" id="hintModal">
        <div class="hint-content">
            <div class="hint-header">
                <h3 class="hint-title">Tips Penyelesaian</h3>
                <button class="close-hint" id="closeHint">&times;</button>
            </div>
            <div class="hint-text" id="hintText"></div>
            <p>Anda akan kehilangan <span class="hint-points">5 poin</span> untuk melihat tips ini.</p>
        </div>
    </div>

    <div class="result-modal" id="resultModal">
        <div class="result-content">
            <div class="result-icon correct" id="resultIcon">✓</div>
            <h3 class="result-title" id="resultTitle">Jawaban Benar!</h3>
            <p class="result-message" id="resultMessage"></p>
            <div class="result-actions">
                <button class="modal-btn home-btn" id="homeBtn">Beranda</button>
                <button class="modal-btn next-btn" id="nextBtn">Level Berikutnya</button>
            </div>
        </div>
    </div>

    <div class="leaderboard-modal" id="leaderboardModal">
        <div class="leaderboard-content">
            <div class="leaderboard-header">
                <h3 class="leaderboard-title">Papan Peringkat</h3>
                <button class="close-leaderboard" id="closeLeaderboard">&times;</button>
            </div>
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>Peringkat</th>
                        <th>Nama</th>
                        <th>Skor</th>
                        <th>Level</th>
                        <th>Koin</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="daily-challenge-modal" id="dailyChallengeModal">
        <div class="daily-challenge-content">
            <div class="daily-challenge-header">
                <h3 class="daily-challenge-title">Tantangan Harian</h3>
                <button class="close-daily-challenge" id="closeDailyChallenge">&times;</button>
            </div>
            <div class="daily-challenge-badge">Hari Ini: Aljabar Dasar</div>
            <p>Selesaikan 5 soal aljabar untuk mendapatkan poin bonus!</p>
            <div class="progress-container">
                <div class="progress-bar" id="challengeProgress" style="width: 0%"></div>
            </div>
            <p>Progress: <span id="challengeProgressText">0</span>/5</p>
            <div class="fun-fact">
                <strong>Fakta Menarik:</strong> Kata "aljabar" berasal dari bahasa Arab "al-jabr" yang berarti "penyatuan bagian yang rusak".
            </div>
        </div>
    </div>

    <div class="coin-shop-modal" id="coinShopModal">
        <div class="coin-shop-content">
            <div class="coin-shop-header">
                <h3 class="coin-shop-title">Toko Koin <span class="coin-icon">🪙</span> <span id="shopCoinCount">0</span></h3>
                <button class="close-coin-shop" id="closeCoinShop">&times;</button>
            </div>
            <div class="coin-shop-tabs">
                <div class="coin-shop-tab active" data-tab="powerups">Power-ups</div>
                <div class="coin-shop-tab" data-tab="themes">Tema</div>
                <div class="coin-shop-tab" data-tab="textures">Tekstur</div>
            </div>
            <div class="coin-shop-items" id="powerupsTab">
                </div>
            <div class="coin-shop-items" id="themesTab" style="display: none;">
                </div>
            <div class="coin-shop-items" id="texturesTab" style="display: none;">
                </div>
        </div>
    </div>

    <button class="theme-toggle" id="themeToggle">🌓</button>
    <button class="leaderboard-btn" id="leaderboardBtn">🏆</button>
    <button class="daily-challenge-btn" id="dailyChallengeBtn">📅</button>
    <button class="coin-shop-btn" id="coinShopBtn">🛒</button>

    <script>
        // Variabel global
        let currentDifficulty = '';
        let currentLevel = 1;
        let currentScore = 0;
        let useOptions = false;
        let hintsUsed = 0;
        let failedAttempts = 0;
        let levelStartTime = 0;
        let levelTimes = [];
        let currentQuestion = {};
        let canvas;
        let ctx;
        let timerInterval;
        let currentStreak = 0;
        let bestStreak = 0;
        let highestLevel = 0;
        let dailyChallengeProgress = 0;
        let dailyChallengeCompleted = false;
        let darkMode = false;
        let gameMode = 'normal';
        let coins = 0;
        let totalQuestionsAnswered = 0;
        let algebraCorrect = 0;
        let geometryCorrect = 0;
        let arithmeticCorrect = 0;
        let speedRunTime = 0;
        let speedRunInterval;
        let factInterval;
        let usedQuestions = new Set(); // Stores 'difficulty-index' to ensure unique questions per session
        let activePowerUps = [];
        let ownedItems = {
            powerups: {},
            themes: {},
            textures: {}
        };
        let currentTheme = 'default';
        let currentTexture = 'grid';

        // Data achievement
        const achievements = [
            { id: 1, name: "Pemula", desc: "Selesaikan level 5", earned: false, reward: 10 },
            { id: 2, name: "Ahli Hitung", desc: "Jawab 10 soal benar berturut-turut", earned: false, reward: 20 },
            { id: 3, name: "Master Aljabar", desc: "Jawab 5 soal aljabar dengan benar", earned: false, reward: 15 },
            { id: 4, name: "Speed Runner", desc: "Selesaikan level dalam waktu <30 detik", earned: false, reward: 25 },
            { id: 5, name: "Penjelajah", desc: "Coba semua tingkat kesulitan", earned: false, reward: 30 },
            { id: 6, name: "Kolektor Koin", desc: "Kumpulkan 100 koin", earned: false, reward: 50 },
            { id: 7, name: "Tak Terhentikan", desc: "Selesaikan 20 level", earned: false, reward: 40 },
            { id: 8, name: "Tanpa Bantuan", desc: "Selesaikan level tanpa menggunakan hint", earned: false, reward: 20 }
        ];

        // Data leaderboard dummy
        let leaderboardData = [
            { name: "Anda", score: 0, level: 0, coins: 0 },
            { name: "Matematikus", score: 450, level: 20, coins: 120 },
            { name: "Pecinta Angka", score: 380, level: 18, coins: 95 },
            { name: "Ahli Aljabar", score: 320, level: 16, coins: 80 },
            { name: "Raja Geometri", score: 290, level: 15, coins: 75 }
        ];

        // Power-ups data
        const powerUps = [
            { id: 'removeTwo', name: 'Hilangkan 2 Opsi', icon: '❌', price: 30, description: 'Hilangkan 2 opsi jawaban yang salah', uses: 3 },
            { id: 'showAnswer', name: 'Lihat Jawaban', icon: '👁️', price: 50, description: 'Tunjukkan jawaban yang benar', uses: 1 },
            { id: 'timeFreeze', name: 'Bekukan Waktu', icon: '⏸️', price: 40, description: 'Hentikan timer selama 10 detik', uses: 2 },
            { id: 'doublePoints', name: 'Poin Ganda', icon: '✖️2', price: 60, description: 'Dapatkan poin ganda untuk jawaban benar berikutnya', uses: 1 }
        ];

        // Theme data
        const themes = [
            { id: 'default', name: 'Standar', icon: '🎨', price: 0, description: 'Tema standar biru', colors: { primary: '#4a6bff', secondary: '#f5f7ff', accent: '#ff6b6b' } },
            { id: 'dark', name: 'Gelap', icon: '🌑', price: 20, description: 'Tema gelap untuk mata', colors: { primary: '#6bce70', secondary: '#1a1a2e', accent: '#ff9500' } },
            { id: 'sunset', name: 'Matahari Terbenam', icon: '🌇', price: 30, description: 'Nuansa oranye dan ungu', colors: { primary: '#ff7e5f', secondary: '#feb47b', accent: '#6a3093' } },
            { id: 'ocean', name: 'Lautan', icon: '🌊', price: 25, description: 'Nuansa biru laut', colors: { primary: '#1e88e5', secondary: '#bbdefb', accent: '#ff5722' } },
            { id: 'forest', name: 'Hutan', icon: '🌲', price: 35, description: 'Nuansa hijau alami', colors: { primary: '#2e7d32', secondary: '#c8e6c9', accent: '#ff8f00' } }
        ];

        // Texture data
        const textures = [
            { id: 'grid', name: 'Kotak-kotak', icon: '🔲', price: 0, description: 'Tekstur kotak-kotak standar', class: 'texture-grid' },
            { id: 'dots', name: 'Titik-titik', icon: '🔵', price: 15, description: 'Tekstur titik-titik', class: 'texture-dots' },
            { id: 'lined', name: 'Garis', icon: '📝', price: 20, description: 'Tekstur bergaris', class: 'texture-lined' },
            { id: 'blank', name: 'Polos', icon: '⬜', price: 10, description: 'Tanpa tekstur', class: '' }
        ];

        // Fakta matematika acak
        const mathFacts = [
            // --- Fakta Angka & Teori Bilangan ---
            "Konstanta Kaprekar: Pilih angka 4 digit dengan setidaknya dua digit berbeda, urutkan menurun dan menaik, kurangi hasilnya. Ulangi prosesnya, dan Anda akan selalu berakhir di angka 6174.",
            "Bilangan Vampir adalah bilangan yang 'dapat dihidupkan kembali' oleh dua 'taring' (faktor) yang diambil dari digitnya sendiri. Contoh: 2187 = 27 × 81.",
            "Dalam sekelompok 23 orang, peluang dua orang memiliki tanggal ulang tahun yang sama lebih dari 50%. Ini dikenal sebagai Paradoks Ulang Tahun.",
            "Angka 7 adalah angka yang paling mungkin muncul saat Anda melempar dua dadu (peluang 1/6).",
            "Hukum Benford menyatakan bahwa dalam banyak kumpulan data di dunia nyata, angka 1 cenderung muncul sebagai digit pertama sekitar 30% dari waktu.",
            "Bilangan Armstrong (atau Narsisistik) adalah bilangan yang sama dengan jumlah digit-digitnya yang dipangkatkan dengan jumlah digit. Contoh: 153 = 1³ + 5³ + 3³.",
            "Tidak ada satu pun bilangan prima yang berakhiran 5, kecuali angka 5 itu sendiri.",
            "Jumlah dari semua bilangan dari 1 hingga 100 (yaitu 1+2+...+100) adalah 5050.",
            "Teorema Terakhir Fermat, yang menyatakan tidak ada bilangan bulat positif a, b, dan c yang dapat memenuhi persamaan aⁿ + bⁿ = cⁿ untuk n > 2, baru terbukti setelah 358 tahun.",
            "Persamaan Euler, e^(iπ) + 1 = 0, dianggap sebagai salah satu persamaan terindah karena menghubungkan lima konstanta matematika paling fundamental.",
            "Ada 'bilangan aneh' (weird numbers), yaitu bilangan yang berlimpah tetapi tidak semi-sempurna. Angka 70 adalah yang terkecil.",
            "Setiap bilangan bulat ganjil dapat ditulis sebagai selisih dari dua bilangan kuadrat sempurna.",
            "Bilangan 'sociable' adalah generalisasi dari bilangan akrab dan sempurna, di mana jumlah pembaginya membentuk siklus. Siklus terpanjang yang diketahui memiliki 28 anggota.",
            "Jumlah dari kebalikan semua bilangan kuadrat (1/1² + 1/2² + 1/3² + ...) secara mengejutkan konvergen ke π²/6.",
            "Meskipun ada tak terhingga bilangan prima, 'celah' di antara mereka bisa menjadi sangat besar secara acak.",
            "Angka 'googolplex' adalah 10 pangkat googol (10^10^100), sebuah angka yang begitu besar sehingga tidak mungkin untuk menuliskannya di alam semesta yang teramati.",
            "Bilangan Palindromik adalah bilangan yang dibaca sama dari depan maupun belakang, seperti 12321.",
            "Nol (0) adalah satu-satunya bilangan yang memiliki sifat aditif (x+0=x) dan multiplikatif (x*0=0).",
            "Angka 13 dianggap sial di banyak budaya (triskaidekaphobia) sebagian karena ada 13 orang pada Perjamuan Terakhir.",
            "Sistem bilangan Babilionia Kuno menggunakan basis 60, yang merupakan alasan kita memiliki 60 detik dalam satu menit dan 360 derajat dalam satu lingkaran.",

            // --- Fakta Geometri & Topologi ---
            "Bentuk penutup lubang got (manhole) biasanya bulat karena itu adalah satu-satunya bentuk yang tidak bisa jatuh ke dalam lubang itu sendiri dari sudut mana pun.",
            "Sebuah Pita Möbius adalah permukaan dengan hanya satu sisi dan satu tepi. Jika Anda berjalan di sepanjang permukaannya, Anda akan kembali ke titik awal di sisi yang 'berlawanan'.",
            "Teorema Empat Warna menyatakan bahwa Anda hanya memerlukan empat warna untuk mewarnai peta apa pun sehingga tidak ada dua wilayah yang berdekatan memiliki warna yang sama.",
            "Masalah Jembatan Königsberg adalah teka-teki terkenal yang melahirkan bidang matematika baru yang disebut Teori Graf.",
            "Fraktal adalah pola tak berujung yang kompleks dan berulang pada skala yang berbeda. Contohnya termasuk kepingan salju dan pakis.",
            "Botol Klein adalah objek 4-dimensi yang tidak memiliki 'dalam' atau 'luar' yang dapat dibedakan.",
            "Dalam geometri non-Euklides, jumlah sudut dalam sebuah segitiga bisa lebih atau kurang dari 180 derajat.",
            "Turunan dari rumus volume bola (4/3πr³) terhadap jari-jarinya (r) adalah rumus luas permukaannya (4πr²).",
            "Ada lebih banyak persimpangan dalam simpul tali sepatu Anda daripada yang Anda kira; studi tentang ini disebut Teori Simpul.",
            "Anda tidak dapat menyisir rambut di bola berbulu tanpa menciptakan setidaknya satu 'pusaran' (cowlick). Ini adalah ilustrasi dari Teorema Bola Berbulu.",
            "Bentuk heksagon adalah cara paling efisien untuk mengisi bidang datar dengan bentuk yang sama, itulah sebabnya sarang lebah berbentuk heksagon.",
            "Golden Ratio (sekitar 1.618) sering muncul di alam, seni, dan arsitektur, dari Parthenon hingga cangkang nautilus.",
            "Sebuah 'tesseract' adalah analogi empat dimensi dari sebuah kubus.",
            "Geometri fraktal digunakan untuk membuat grafis komputer yang realistis untuk pemandangan alam seperti pegunungan dan pantai.",
            "Lingkaran memiliki rasio keliling terhadap diameter yang konstan (π), tetapi bentuk lain tidak.",
            "Luas segitiga dengan simpul pada koordinat bilangan bulat selalu merupakan kelipatan dari 1/2.",
            "Objek dengan dimensi fraktal dapat memiliki panjang tak terhingga dalam area yang terbatas.",
            "Pola Voronoi, yang membagi ruang menjadi wilayah berdasarkan kedekatan titik, ditemukan pada kulit jerapah dan sayap capung.",
            "Proyeksi stereografis memungkinkan pemetaan permukaan bola ke bidang datar, yang penting dalam kartografi dan matematika kompleks.",
            "Topologi sering disebut 'geometri lembaran karet' karena mempelajari sifat-sifat bentuk yang tidak berubah di bawah peregangan atau pembengkokan.",

            // --- Fakta Probabilitas & Logika ---
            "Paradoks Monty Hall menunjukkan bahwa pilihan intuitif dalam probabilitas seringkali salah. Peluang menang meningkat jika Anda mengubah pilihan Anda.",
            "Teorema Monyet Tak Terhingga menyatakan bahwa monyet yang mengetik secara acak di mesin tik untuk waktu tak terbatas pada akhirnya hampir pasti akan menghasilkan karya lengkap William Shakespeare.",
            "Paradoks Banach-Tarski secara kontroversial menyatakan bahwa sebuah bola dapat dipecah menjadi sejumlah bagian terbatas dan disusun kembali menjadi dua bola yang identik dengan aslinya.",
            "Teorema Ketidaklengkapan Gödel menunjukkan bahwa dalam sistem matematika formal apa pun, akan selalu ada pernyataan yang benar tetapi tidak dapat dibuktikan dalam sistem itu sendiri.",
            "Hukum Bilangan Besar yang Sesungguhnya menyatakan bahwa dengan ukuran sampel yang cukup besar, hal-hal yang paling aneh dan tidak mungkin pun bisa terjadi.",
            "Dalam permainan 'Rock, Paper, Scissors', strategi terbaik secara matematis adalah bermain secara acak.",
            "Peluang Anda memenangkan lotre utama seringkali lebih rendah daripada peluang Anda tersambar petir dalam hidup Anda.",
            "Sebuah setumpuk 52 kartu memiliki 52! (52 faktorial) kemungkinan urutan, sebuah angka yang lebih besar dari jumlah atom di Bumi.",
            "Rantai Markov adalah model matematika yang menggambarkan urutan peristiwa di mana probabilitas setiap peristiwa hanya bergantung pada keadaan peristiwa sebelumnya.",
            "Paradoks Simpson terjadi ketika sebuah tren muncul dalam beberapa kelompok data yang berbeda tetapi menghilang atau berbalik ketika kelompok-kelompok ini digabungkan.",
            "Jika Anda mengocok setumpuk kartu dengan benar, kemungkinan besar urutan kartu yang Anda dapatkan belum pernah ada sebelumnya dalam sejarah dunia.",
            "Peluang dua orang di kelas dengan 30 siswa tidak memiliki hari ulang tahun yang sama sangatlah kecil, hanya sekitar 29%.",
            "Sebuah 'langkah acak' (random walk) adalah jalur yang terdiri dari serangkaian langkah acak, sebuah konsep kunci dalam fisika dan pasar saham.",
            "Masalah Penjatahan Sekretaris adalah teka-teki probabilitas untuk menemukan strategi optimal untuk memilih kandidat terbaik dari sekelompok pelamar.",
            "Meskipun kelihatannya berlawanan dengan intuisi, rata-rata jumlah teman dari teman Anda hampir selalu lebih besar dari jumlah teman Anda sendiri (Paradoks Persahabatan).",

            // --- Fakta Sejarah & Lain-lain ---
            "Tanda sama dengan (=) diciptakan oleh matematikawan Robert Recorde pada tahun 1557 karena ia 'bosan menulis 'is equal to' berulang kali'.",
            "Kata 'aljabar' berasal dari bahasa Arab 'al-jabr', yang berarti 'penyatuan kembali bagian-bagian yang rusak', dari judul buku matematikawan Persia, Al-Khwarizmi.",
            "Kata 'algoritma' adalah latinisasi dari nama Al-Khwarizmi.",
            "Sophie Germain adalah seorang matematikawan wanita yang menggunakan nama samaran pria, 'Monsieur Le Blanc', untuk dapat berpartisipasi dalam komunitas matematika yang didominasi pria.",
            "Simbol tak terhingga (∞) disebut 'lemniscate'.",
            "Kata 'calculus' berasal dari bahasa Latin untuk 'kerikil kecil', yang digunakan untuk menghitung pada zaman kuno.",
            "Pythagoras, yang terkenal dengan teoremanya, juga memimpin sebuah kultus yang memuja angka dan percaya bahwa makan kacang adalah dosa.",
            "Sistem penulisan angka Romawi tidak memiliki konsep angka nol.",
            "René Descartes konon mendapatkan ide untuk sistem koordinat Kartesius saat melihat seekor lalat merayap di langit-langit kamarnya.",
            "Évariste Galois mengembangkan dasar-dasar teori grup dan teori Galois malam sebelum ia tewas dalam duel pada usia 20 tahun.",
            "Jari-jari kita dapat digunakan untuk sistem bilangan berbasis 10 (desimal), tetapi juga dapat digunakan untuk sistem berbasis 12 (duodesimal) dengan menggunakan ibu jari untuk menghitung ruas jari lainnya.",
            "Istilah 'hundred' berasal dari kata Norse kuno 'hundrath', yang sebenarnya berarti 120 (10 x 12).",
            "Matematika adalah satu-satunya 'sains' yang tidak memerlukan eksperimen untuk membuktikan kebenarannya; hanya logika dan pembuktian.",
            "Banyak arsitektur kuno, seperti Piramida Giza, dibangun dengan prinsip-prinsip matematika yang sangat canggih.",
            "Tanda plus (+) dan minus (-) pertama kali muncul dalam cetakan di Jerman pada akhir abad ke-15.",
            "Di Taiwan, angka 4 sering dihindari di gedung-gedung (seperti lantai 4) karena pengucapannya mirip dengan kata 'mati'.",
            "Dalam bahasa Inggris, 'forty' adalah satu-satunya angka yang hurufnya diurutkan secara alfabetis.",
            "Emmy Noether adalah seorang matematikawan revolusioner yang karyanya dalam aljabar abstrak menjadi dasar bagi banyak fisika modern.",
            "Sistem matriks dalam matematika dikembangkan secara luas oleh Arthur Cayley pada abad ke-19.",
            "John Napier, penemu logaritma, juga merancang berbagai 'tulang' (Napier's Bones) untuk mempermudah perkalian.",
            "Ada sekitar 1.771.47 cara berbeda untuk mengikat dasi, menurut ahli matematika Swedia.",
            "Jika sebuah pizza memiliki jari-jari 'z' dan ketebalan 'a', volumenya adalah Pi × z × z × a.",
            "Angka 1 diikuti oleh 100 angka nol disebut 'googol'.",
            "Notasi modern untuk π baru digunakan secara luas setelah diperkenalkan oleh Leonhard Euler pada tahun 1737.",
            "Matematika sering disebut sebagai 'Ratu Ilmu Pengetahuan' oleh Carl Friedrich Gauss.",
            "Kata 'trigonometri' berasal dari bahasa Yunani yang berarti 'pengukuran segitiga'.",
            "Orang Babilonia memecahkan persamaan kuadrat lebih dari 3000 tahun yang lalu.",
            "Hypatia dari Alexandria adalah salah satu matematikawan wanita pertama yang tercatat dalam sejarah.",
            "Konsep fungsi (y = f(x)) merupakan perkembangan penting dalam sejarah matematika yang memungkinkan pemodelan hubungan antar variabel.",
            "Bilangan imajiner (i, akar kuadrat dari -1) awalnya dianggap 'tidak mungkin' tetapi sekarang sangat penting dalam bidang teknik dan fisika.",
            "Sistem desimal modern (basis 10) berasal dari sistem angka Hindu-Arab.",
            "Teori Permainan (Game Theory) adalah cabang matematika yang digunakan dalam ekonomi, ilmu politik, dan biologi untuk memodelkan pengambilan keputusan strategis.",
            "Dalam bahasa Prancis, angka 90 disebut 'quatre-vingt-dix' yang secara harfnis 'empat-dua puluh-sepuluh' (4 x 20 + 10).",
            "Selembar kertas yang sangat besar secara teoretis bisa dilipat hingga ke bulan, jika Anda bisa melipatnya 42 kali.",
            "Ada lebih banyak cara untuk mengatur catur di papan daripada jumlah elektron di alam semesta yang teramati (Nomor Shannon)."
        ];

        // Elemen DOM
        const quizContainer = document.getElementById('quizContainer');
        const difficultyDisplay = document.getElementById('difficultyDisplay');
        const currentLevelDisplay = document.getElementById('currentLevel');
        const currentScoreDisplay = document.getElementById('currentScore');
        const questionText = document.getElementById('questionText');
        const answerInput = document.getElementById('answerInput');
        const answerOptions = document.getElementById('answerOptions');
        const submitBtn = document.getElementById('submitBtn');
        const hintBtn = document.getElementById('hintBtn');
        const hintModal = document.getElementById('hintModal');
        const hintText = document.getElementById('hintText');
        const closeHint = document.getElementById('closeHint');
        const resultModal = document.getElementById('resultModal');
        const resultIcon = document.getElementById('resultIcon');
        const resultTitle = document.getElementById('resultTitle');
        const resultMessage = document.getElementById('resultMessage');
        const homeBtn = document.getElementById('homeBtn');
        const nextBtn = document.getElementById('nextBtn');
        const statsContainer = document.getElementById('statsContainer');
        const timePerLevelDisplay = document.getElementById('timePerLevel');
        const failedAttemptsDisplay = document.getElementById('failedAttempts');
        const speedStatDisplay = document.getElementById('speedStat');
        const hintsUsedDisplay = document.getElementById('hintsUsed');
        const scratchPad = document.getElementById('scratchPad');
        const scratchTexture = document.getElementById('scratchTexture');
        const useOptionsToggle = document.getElementById('useOptionsToggle');
        const clearCanvasBtn = document.getElementById('clearCanvasBtn');
        const themeToggle = document.getElementById('themeToggle');
        const timerDisplay = document.getElementById('timer');
        const streakCount = document.getElementById('streakCount');
        const bestStreakDisplay = document.getElementById('bestStreak');
        const highestLevelDisplay = document.getElementById('highestLevel');
        const leaderboardBtn = document.getElementById('leaderboardBtn');
        const leaderboardModal = document.getElementById('leaderboardModal');
        const leaderboardBody = document.getElementById('leaderboardBody');
        const closeLeaderboard = document.getElementById('closeLeaderboard');
        const dailyChallengeBtn = document.getElementById('dailyChallengeBtn');
        const dailyChallengeModal = document.getElementById('dailyChallengeModal');
        const closeDailyChallenge = document.getElementById('closeDailyChallenge');
        const challengeProgress = document.getElementById('challengeProgress');
        const challengeProgressText = document.getElementById('challengeProgressText');
        const funFact = document.getElementById('funFact');
        const shareBtn = document.getElementById('shareBtn');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const gameModeSelector = document.getElementById('gameModeSelector');
        const coinCount = document.getElementById('coinCount');
        const totalCoinsDisplay = document.getElementById('totalCoins');
        const achievementCount = document.getElementById('achievementCount');
        const algebraProgress = document.getElementById('algebraProgress');
        const geometryProgress = document.getElementById('geometryProgress');
        const arithmeticProgress = document.getElementById('arithmeticProgress');
        const algebraPercent = document.getElementById('algebraPercent');
        const geometryPercent = document.getElementById('geometryPercent');
        const arithmeticPercent = document.getElementById('arithmeticPercent');
        const coinShopBtn = document.getElementById('coinShopBtn');
        const coinShopModal = document.getElementById('coinShopModal');
        const closeCoinShop = document.getElementById('closeCoinShop');
        const shopCoinCount = document.getElementById('shopCoinCount');
        const powerUpsContainer = document.getElementById('powerUpsContainer');
        const powerupsTab = document.getElementById('powerupsTab');
        const themesTab = document.getElementById('themesTab');
        const texturesTab = document.getElementById('texturesTab');
        const coinShopTabs = document.querySelectorAll('.coin-shop-tab');

        // Event Listeners
        document.querySelectorAll('.difficulty-btn').forEach(btn => {
            btn.addEventListener('click', startQuiz);
        });

        document.querySelectorAll('.game-mode-btn').forEach(btn => {
            btn.addEventListener('click', changeGameMode);
        });

        submitBtn.addEventListener('click', checkAnswer);
        hintBtn.addEventListener('click', showHint);
        closeHint.addEventListener('click', () => hintModal.classList.remove('show'));
        homeBtn.addEventListener('click', goHome);
        nextBtn.addEventListener('click', nextLevel);
        useOptionsToggle.addEventListener('change', toggleAnswerOptions);
        clearCanvasBtn.addEventListener('click', clearCanvas);
        themeToggle.addEventListener('click', toggleTheme);
        leaderboardBtn.addEventListener('click', showLeaderboard);
        closeLeaderboard.addEventListener('click', () => leaderboardModal.classList.remove('show'));
        dailyChallengeBtn.addEventListener('click', showDailyChallenge);
        closeDailyChallenge.addEventListener('click', () => dailyChallengeModal.classList.remove('show'));
        shareBtn.addEventListener('click', shareResults);
        darkModeToggle.addEventListener('change', toggleDarkMode);
        coinShopBtn.addEventListener('click', showCoinShop);
        closeCoinShop.addEventListener('click', () => coinShopModal.classList.remove('show'));
        
        coinShopTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                coinShopTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const tabId = tab.dataset.tab;
                document.querySelectorAll('.coin-shop-items').forEach(content => {
                    content.style.display = 'none';
                });
                document.getElementById(`${tabId}Tab`).style.display = 'grid';
            });
        });

        // Load saved data from localStorage
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('mathQuizData');
            if (savedData) {
                const data = JSON.parse(savedData);
                bestStreak = data.bestStreak || 0;
                highestLevel = data.highestLevel || 0;
                dailyChallengeProgress = data.dailyChallengeProgress || 0;
                dailyChallengeCompleted = data.dailyChallengeCompleted || false;
                darkMode = data.darkMode || false;
                coins = data.coins || 0;
                totalQuestionsAnswered = data.totalQuestionsAnswered || 0;
                algebraCorrect = data.algebraCorrect || 0;
                geometryCorrect = data.geometryCorrect || 0;
                arithmeticCorrect = data.arithmeticCorrect || 0;
                currentTheme = data.currentTheme || 'default';
                currentTexture = data.currentTexture || 'grid';
                ownedItems = data.ownedItems || {
                    powerups: {},
                    themes: { default: 1 },
                    textures: { grid: 1 }
                };
                
                achievements.forEach(ach => {
                    const savedAch = data.achievements?.find(a => a.id === ach.id);
                    if (savedAch) ach.earned = savedAch.earned;
                });
                
                if (darkMode) {
                    document.body.classList.add('dark-mode');
                    darkModeToggle.checked = true;
                }
                
                applyTheme(currentTheme);
                applyTexture(currentTexture);
            }
            
            updateStats();
            updateCoinDisplay();
            updateAchievementCount();
            updateSkillProgress();
            initCoinShop();
        }

        // Save data to localStorage
        function saveToLocalStorage() {
            const data = {
                bestStreak,
                highestLevel,
                dailyChallengeProgress,
                dailyChallengeCompleted,
                darkMode,
                coins,
                totalQuestionsAnswered,
                algebraCorrect,
                geometryCorrect,
                arithmeticCorrect,
                currentTheme,
                currentTexture,
                ownedItems,
                achievements: achievements.filter(a => a.earned)
            };
            localStorage.setItem('mathQuizData', JSON.stringify(data));
        }

        // Initialize coin shop
        function initCoinShop() {
            // Add power-ups to shop
            powerupsTab.innerHTML = '';
            powerUps.forEach(powerup => {
                const owned = ownedItems.powerups[powerup.id] || 0;
                const canAfford = coins >= powerup.price;
                
                const item = document.createElement('div');
                item.className = `coin-shop-item ${canAfford ? '' : 'coin-shop-item-disabled'}`;
                item.innerHTML = `
                    <div class="coin-shop-item-icon">${powerup.icon}</div>
                    <div class="coin-shop-item-name">${powerup.name}</div>
                    <div class="coin-shop-item-price">${powerup.price} 🪙</div>
                    <small>${powerup.description}</small>
                    ${owned > 0 ? `<div class="coin-shop-item-owned">${owned}</div>` : ''}
                `;
                
                if (canAfford) {
                    item.addEventListener('click', () => purchaseItem('powerups', powerup));
                }
                
                powerupsTab.appendChild(item);
            });
            
            // Add themes to shop
            themesTab.innerHTML = '';
            themes.forEach(theme => {
                const owned = ownedItems.themes[theme.id] || 0;
                const canAfford = coins >= theme.price || theme.price === 0;
                const isCurrent = currentTheme === theme.id;
                
                const item = document.createElement('div');
                item.className = `coin-shop-item ${canAfford ? '' : 'coin-shop-item-disabled'} ${isCurrent ? 'active' : ''}`;
                item.innerHTML = `
                    <div class="coin-shop-item-icon">${theme.icon}</div>
                    <div class="coin-shop-item-name">${theme.name}</div>
                    <div class="coin-shop-item-price">${theme.price} 🪙</div>
                    <small>${theme.description}</small>
                    <div class="theme-preview" style="background: linear-gradient(to right, ${theme.colors.primary}, ${theme.colors.secondary});"></div>
                    ${owned > 0 ? `<div class="coin-shop-item-owned">${owned}</div>` : ''}
                    ${isCurrent ? '<div class="coin-shop-item-owned">✓</div>' : ''}
                `;
                
                if (canAfford) {
                    item.addEventListener('click', () => purchaseItem('themes', theme));
                }
                
                themesTab.appendChild(item);
            });
            
            // Add textures to shop
            texturesTab.innerHTML = '';
            textures.forEach(texture => {
                const owned = ownedItems.textures[texture.id] || 0;
                const canAfford = coins >= texture.price || texture.price === 0;
                const isCurrent = currentTexture === texture.id;
                
                const item = document.createElement('div');
                item.className = `coin-shop-item ${canAfford ? '' : 'coin-shop-item-disabled'} ${isCurrent ? 'active' : ''}`;
                item.innerHTML = `
                    <div class="coin-shop-item-icon">${texture.icon}</div>
                    <div class="coin-shop-item-name">${texture.name}</div>
                    <div class="coin-shop-item-price">${texture.price} 🪙</div>
                    <small>${texture.description}</small>
                    ${owned > 0 ? `<div class="coin-shop-item-owned">${owned}</div>` : ''}
                    ${isCurrent ? '<div class="coin-shop-item-owned">✓</div>' : ''}
                `;
                
                if (canAfford) {
                    item.addEventListener('click', () => purchaseItem('textures', texture));
                }
                
                texturesTab.appendChild(item);
            });
            
            shopCoinCount.textContent = coins;
        }

        // Purchase item from coin shop
        function purchaseItem(category, item) {
            if (coins < item.price) return;
            
            coins -= item.price;
            if (category === 'powerups') {
                 ownedItems[category][item.id] = (ownedItems[category][item.id] || 0) + item.uses; // Add uses directly
            } else {
                 ownedItems[category][item.id] = 1; // For themes/textures, just mark as owned
            }
            
            if (category === 'themes') {
                currentTheme = item.id;
                applyTheme(item.id);
            } else if (category === 'textures') {
                currentTexture = item.id;
                applyTexture(item.id);
            }
            
            updateCoinDisplay();
            saveToLocalStorage();
            initCoinShop();
            
            // Show purchase confirmation
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `<h3>Pembelian Berhasil!</h3><p>Anda mendapatkan ${item.name}</p>`;
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 2000);
        }

        // Apply selected theme
        function applyTheme(themeId) {
            const theme = themes.find(t => t.id === themeId);
            if (!theme) return;
            
            document.documentElement.style.setProperty('--primary', theme.colors.primary);
            document.documentElement.style.setProperty('--secondary', theme.colors.secondary);
            document.documentElement.style.setProperty('--accent', theme.colors.accent);
        }

        // Apply selected texture
        function applyTexture(textureId) {
            const texture = textures.find(t => t.id === textureId);
            if (!texture) return;
            
            scratchTexture.className = 'scratch-texture ' + texture.class;
        }

        // Add power-up to active power-ups
        function addPowerUp(powerupId) {
            const powerup = powerUps.find(p => p.id === powerupId);
            if (!powerup) return;
            
            if (!ownedItems.powerups[powerupId]) {
                ownedItems.powerups[powerupId] = powerup.uses; // Store total uses
            } else {
                ownedItems.powerups[powerupId] += powerup.uses;
            }
            
            updatePowerUps();
        }

        // Update power-ups display
        function updatePowerUps() {
            powerUpsContainer.innerHTML = '';
            
            Object.keys(ownedItems.powerups).forEach(powerupId => {
                const powerup = powerUps.find(p => p.id === powerupId);
                if (!powerup) return;
                
                const uses = ownedItems.powerups[powerupId];
                if (uses <= 0) return;
                
                const btn = document.createElement('button');
                btn.className = 'power-up-btn';
                btn.innerHTML = `${powerup.icon} ${powerup.name} (${uses})`;
                btn.title = powerup.description;
                btn.addEventListener('click', () => usePowerUp(powerupId));
                
                powerUpsContainer.appendChild(btn);
            });
        }

        // Use power-up
        function usePowerUp(powerupId) {
            const powerup = powerUps.find(p => p.id === powerupId);
            if (!powerup || ownedItems.powerups[powerupId] <= 0) return;
            
            ownedItems.powerups[powerupId]--;
            
            switch(powerupId) {
                case 'removeTwo':
                    removeTwoOptions();
                    break;
                case 'showAnswer':
                    showAnswer();
                    break;
                case 'timeFreeze':
                    timeFreeze();
                    break;
                case 'doublePoints':
                    activePowerUps.push('doublePoints'); // Add to active power-ups for current question
                    break;
            }
            
            updatePowerUps();
            saveToLocalStorage();
            
            // Show message
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `<h3>Power-up Digunakan!</h3><p>${powerup.name} telah diaktifkan.</p>`;
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 2000);
        }

        // Remove two incorrect options
        function removeTwoOptions() {
            if (!useOptions || !currentQuestion.options) return;
            
            const correctAnswer = currentQuestion.answer.toString();
            let incorrectOptions = Array.from(document.querySelectorAll('.option-btn'))
                .filter(btn => btn.dataset.value !== correctAnswer && btn.style.opacity !== '0.3'); // Ensure not already removed
            
            if (incorrectOptions.length < 2) return; // Not enough incorrect options to remove
            
            // Shuffle and pick 2 to remove
            incorrectOptions = shuffleArray(incorrectOptions);
            
            for (let i = 0; i < 2; i++) {
                if (incorrectOptions[i]) {
                    incorrectOptions[i].style.opacity = '0.3';
                    incorrectOptions[i].style.pointerEvents = 'none';
                }
            }
        }

        // Show correct answer
        function showAnswer() {
            const correctAnswer = currentQuestion.answer.toString();
            
            if (useOptions && currentQuestion.options) {
                const correctBtn = Array.from(document.querySelectorAll('.option-btn'))
                    .find(btn => btn.dataset.value === correctAnswer);
                
                if (correctBtn) {
                    correctBtn.style.borderColor = 'var(--success)';
                    correctBtn.style.backgroundColor = darkMode ? '#1a3a1a' : '#e6f7e6';
                }
            } else {
                answerInput.value = correctAnswer;
            }
        }

        // Freeze timer for 10 seconds
        function timeFreeze() {
            if (!timerInterval) return;
            
            clearInterval(timerInterval);
            
            // Resume timer after 10 seconds
            setTimeout(() => {
                startTimer();
            }, 10000);
        }

        // Show coin shop
        function showCoinShop() {
            shopCoinCount.textContent = coins;
            initCoinShop(); // Re-initialize to update owned status and affordability
            coinShopModal.classList.add('show');
        }

        // Initialize
        loadFromLocalStorage();
        showRandomMathFact();

        function showRandomMathFact() {
            const randomFact = mathFacts[Math.floor(Math.random() * mathFacts.length)];
            const factElement = document.getElementById('funFact');
            
            factElement.style.opacity = '0';
            factElement.style.transition = 'opacity 0.5s ease';
            
            setTimeout(() => {
                factElement.innerHTML = `<div class="fun-fact-content"><strong>Fakta Menarik:</strong> ${randomFact}</div>`;
                factElement.style.opacity = '1';
            }, 500);
            
            // Change fact every 3 seconds
            if (factInterval) clearInterval(factInterval);
            factInterval = setInterval(showRandomMathFact, 3000);
        }

        function clearCanvas() {
            if (ctx && canvas) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }
        
        function initCanvas() {
            scratchPad.innerHTML = '';
            canvas = document.createElement('canvas');
            canvas.width = scratchPad.offsetWidth;
            canvas.height = scratchPad.offsetHeight;
            scratchPad.appendChild(canvas);
            
            const textureDiv = document.createElement('div');
            textureDiv.className = 'scratch-texture ' + (textures.find(t => t.id === currentTexture)?.class || '');
            scratchPad.appendChild(textureDiv);
            
            ctx = canvas.getContext('2d');
            ctx.strokeStyle = darkMode ? 'var(--dark-text)' : 'var(--text)';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd);
            
            function startDrawing(e) {
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function draw(e) {
                if (!isDrawing) return;
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function stopDrawing() {
                isDrawing = false;
            }

            function getTouchPos(canvasDom, touchEvent) {
                const rect = canvasDom.getBoundingClientRect();
                return {
                    x: touchEvent.touches[0].clientX - rect.left,
                    y: touchEvent.touches[0].clientY - rect.top
                };
            }
            
            function handleTouchStart(e) {
                e.preventDefault();
                const touchPos = getTouchPos(canvas, e);
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touchPos.x,
                    clientY: touchPos.y
                });
                canvas.dispatchEvent(mouseEvent);
            }
            
            function handleTouchMove(e) {
                e.preventDefault();
                const touchPos = getTouchPos(canvas, e);
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touchPos.x,
                    clientY: touchPos.y
                });
                canvas.dispatchEvent(mouseEvent);
            }
            
            function handleTouchEnd(e) {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup', {});
                canvas.dispatchEvent(mouseEvent);
            }
        }

        function changeGameMode(e) {
            gameMode = e.target.dataset.mode;
            
            document.querySelectorAll('.game-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            e.target.classList.add('active');
            
            if (quizContainer.style.display === 'block') {
                startQuiz({ target: { dataset: { difficulty: currentDifficulty } } });
            }
        }

        function startQuiz(e) {
            currentDifficulty = e.target.dataset.difficulty;
            currentLevel = 1;
            currentScore = 0;
            hintsUsed = 0;
            failedAttempts = 0;
            levelTimes = [];
            currentStreak = 0;
            speedRunTime = 0;
            activePowerUps = []; // Clear active power-ups at start of new quiz
            usedQuestions.clear(); // Reset used questions for a new game session
            
            switch(currentDifficulty) {
                case 'easy':
                    difficultyDisplay.textContent = 'Mudah';
                    break;
                case 'medium':
                    difficultyDisplay.textContent = 'Menengah';
                    break;
                case 'hard':
                    difficultyDisplay.textContent = 'Sulit';
                    break;
                case 'extreme':
                    difficultyDisplay.textContent = 'Ekstrem';
                    break;
            }
            
            quizContainer.style.display = 'block';
            statsContainer.style.display = 'block';
            
            initCanvas();
            startTimer();
            startLevel();
            
            if (gameMode === 'speedrun') {
                clearInterval(speedRunInterval);
                speedRunTime = 0;
                speedRunInterval = setInterval(() => {
                    speedRunTime++;
                }, 1000);
            }
            
            updatePowerUps();
        }

        function startTimer() {
            let seconds = 0;
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                seconds++;
                timerDisplay.textContent = seconds;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            if (speedRunInterval) clearInterval(speedRunInterval);
        }

        function startLevel() {
            clearCanvas();
            
            currentLevelDisplay.textContent = currentLevel;
            animateCount(currentScoreDisplay, currentScore);
            streakCount.textContent = currentStreak;
            answerInput.value = '';
            answerInput.className = 'answer-field';
            
            currentQuestion = generateQuestion(currentDifficulty); // Pass difficulty
            questionText.textContent = currentQuestion.question;
            
            if (useOptions) {
                answerInput.style.display = 'none';
                answerOptions.style.display = 'grid';
                
                answerOptions.innerHTML = '';
                
                currentQuestion.options.forEach((option, index) => {
                    const optionBtn = document.createElement('button');
                    optionBtn.className = 'option-btn';
                    optionBtn.textContent = option;
                    optionBtn.dataset.value = option;
                    optionBtn.addEventListener('click', selectOption);
                    answerOptions.appendChild(optionBtn);
                });
            } else {
                answerInput.style.display = 'block';
                answerOptions.style.display = 'none';
            }
            
            levelStartTime = Date.now();
            updateStats();
        }

        function selectOption(e) {
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.style.borderColor = '#ddd';
                btn.style.backgroundColor = darkMode ? '#16213e' : 'white';
            });
            
            e.target.style.borderColor = 'var(--primary)';
            e.target.style.backgroundColor = darkMode ? '#1a1a2e' : 'var(--secondary)';
            
            answerInput.value = e.target.dataset.value;
        }

        function toggleAnswerOptions() {
            useOptions = useOptionsToggle.checked;
            
            if (quizContainer.style.display === 'block') {
                startLevel();
            }
        }

        function toggleTheme() {
            darkMode = !darkMode;
            document.body.classList.toggle('dark-mode');
            darkModeToggle.checked = darkMode;
            if (ctx) {
                ctx.strokeStyle = darkMode ? 'var(--dark-text)' : 'var(--text)';
            }
            saveToLocalStorage();
        }

        function toggleDarkMode() {
            darkMode = darkModeToggle.checked;
            document.body.classList.toggle('dark-mode', darkMode);
            if (ctx) {
                ctx.strokeStyle = darkMode ? 'var(--dark-text)' : 'var(--text)';
            }
            saveToLocalStorage();
        }

        function checkAnswer() {
            const userAnswer = answerInput.value.trim();
            
            if (!userAnswer) {
                answerInput.style.borderColor = 'var(--accent)';
                return;
            }
            
            const timeSpent = Math.floor((Date.now() - levelStartTime) / 1000);
            levelTimes.push(timeSpent);
            
            let isCorrect = false;

            if (!isNaN(userAnswer) && typeof currentQuestion.answer === 'number') {
                 isCorrect = Math.abs(parseFloat(userAnswer) - currentQuestion.answer) < 0.01;
            } else {
                 isCorrect = userAnswer.toLowerCase() === currentQuestion.answer.toString().toLowerCase();
            }
            
            // Visual feedback
            if (isCorrect) {
                answerInput.classList.add('correct');
            } else {
                answerInput.classList.add('incorrect');
            }
            
            setTimeout(() => showResult(isCorrect, timeSpent), 500);
        }

        function showResult(isCorrect, timeSpent) {
            totalQuestionsAnswered++;
            let message = '';

            if (isCorrect) {
                if (currentQuestion.category === 'algebra') algebraCorrect++;
                else if (currentQuestion.category === 'geometry') geometryCorrect++;
                else if (currentQuestion.category === 'arithmetic') arithmeticCorrect++;
                
                resultIcon.className = 'result-icon correct';
                resultIcon.textContent = '✓';
                resultTitle.textContent = 'Jawaban Benar!';
                
                let maxPoints = 10;
                if (currentDifficulty === 'medium') maxPoints = 15;
                else if (currentDifficulty === 'hard') maxPoints = 20;
                else if (currentDifficulty === 'extreme') maxPoints = 25;
                
                maxPoints += Math.floor(currentLevel / 4);
                const timePenalty = Math.floor(timeSpent / 4);
                let pointsEarned = Math.max(1, maxPoints - timePenalty);
                
                // Apply double points if active
                if (activePowerUps.includes('doublePoints')) {
                    pointsEarned *= 2;
                    activePowerUps = activePowerUps.filter(p => p !== 'doublePoints'); // Remove after one use
                    message += `<br><b>(Poin Ganda Aktif!)</b>`;
                }
                
                message = `Poin dasar: ${maxPoints}<br>Pengurangan waktu: -${timePenalty}`;

                if (currentStreak > 0 && currentStreak % 3 === 0) {
                    const streakBonus = Math.floor(currentStreak / 3) * 5;
                    pointsEarned += streakBonus;
                    message += `<br>Bonus streak: +${streakBonus}`;
                }
                
                if (gameMode === 'speedrun' && timeSpent < 10) {
                    const speedBonus = Math.floor((10 - timeSpent) * 2);
                    pointsEarned += speedBonus;
                    message += `<br>Bonus speed run: +${speedBonus}`;
                }

                message += `<br><b>Poin diperoleh: ${pointsEarned}</b>`;
                
                currentScore += pointsEarned;
                currentStreak++;
                if (currentStreak > bestStreak) {
                    bestStreak = currentStreak;
                }
                
                const coinsEarned = Math.floor(pointsEarned / 2);
                coins += coinsEarned;
                message += `<br><br>🪙 Koin diperoleh: +${coinsEarned}`;
                animateCount(coinCount, coins);
                animateCount(totalCoinsDisplay, coins);
                
                if (currentQuestion.isDailyChallenge) {
                    dailyChallengeProgress++;
                    if (dailyChallengeProgress >= 5 && !dailyChallengeCompleted) {
                        dailyChallengeCompleted = true;
                        currentScore += 50;
                        coins += 25;
                        message += `<br><br>🎉 Anda menyelesaikan Tantangan Harian! +50 poin dan 25 koin bonus!`;
                        animateCount(coinCount, coins);
                        animateCount(totalCoinsDisplay, coins);
                    }
                    saveToLocalStorage();
                }

                checkAchievements(isCorrect, timeSpent);

            } else {
                resultIcon.className = 'result-icon incorrect';
                resultIcon.textContent = '✗';
                resultTitle.textContent = 'Jawaban Salah!';
                
                message = `Jawaban yang benar adalah: <b>${currentQuestion.answer}</b>`;
                
                currentScore = Math.max(0, currentScore - 5);
                failedAttempts++;
                currentStreak = 0;
            }

            // Tambahkan pembahasan ke pesan, baik untuk jawaban benar maupun salah
            if (currentQuestion.explanation) {
                message += `<br><br><div style="text-align: left; border-top: 1px solid #ccc; padding-top: 10px; margin-top: 10px;"><b>Pembahasan:</b><br>${currentQuestion.explanation}</div>`;
            }

            resultMessage.innerHTML = message;
            
            if (currentLevel > highestLevel) {
                highestLevel = currentLevel;
            }
            
            animateCount(currentScoreDisplay, currentScore);
            streakCount.textContent = currentStreak;
            updateStats();
            saveToLocalStorage();
            resultModal.classList.add('show');
            stopTimer();
        }

        function animateCount(element, targetValue) {
            const current = parseInt(element.textContent) || 0;
            const duration = 500; // ms
            const startTime = performance.now();
            
            function updateCount(timestamp) {
                const elapsed = timestamp - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const value = Math.floor(current + (targetValue - current) * progress);
                
                element.textContent = value;
                element.classList.add('animate');
                
                if (progress < 1) {
                    requestAnimationFrame(updateCount);
                } else {
                    setTimeout(() => {
                        element.classList.remove('animate');
                    }, 300);
                }
            }
            
            requestAnimationFrame(updateCount);
        }

        function updateCoinDisplay() {
            coinCount.textContent = coins;
            totalCoinsDisplay.textContent = coins;
            if (shopCoinCount) shopCoinCount.textContent = coins;
        }

        function updateAchievementCount() {
            const earned = achievements.filter(a => a.earned).length;
            achievementCount.textContent = `${earned}/${achievements.length}`;
        }

        function updateSkillProgress() {
            const totalQuestions = algebraCorrect + geometryCorrect + arithmeticCorrect;
            const algebraTotal = totalQuestions > 0 ? Math.round((algebraCorrect / totalQuestions) * 100) : 0;
            const geometryTotal = totalQuestions > 0 ? Math.round((geometryCorrect / totalQuestions) * 100) : 0;
            const arithmeticTotal = totalQuestions > 0 ? Math.round((arithmeticCorrect / totalQuestions) * 100) : 0;
            
            algebraProgress.style.width = `${algebraTotal}%`;
            geometryProgress.style.width = `${geometryTotal}%`;
            arithmeticProgress.style.width = `${arithmeticTotal}%`;
            
            algebraPercent.textContent = `${algebraTotal}%`;
            geometryPercent.textContent = `${geometryTotal}%`;
            arithmeticPercent.textContent = `${arithmeticTotal}%`;
        }

        function checkAchievements(isCorrect, timeSpent) {
            if (currentLevel >= 5 && !achievements[0].earned) {
                achievements[0].earned = true;
                coins += achievements[0].reward;
                showAchievement(0);
            }
            
            if (currentStreak >= 10 && !achievements[1].earned) {
                achievements[1].earned = true;
                coins += achievements[1].reward;
                showAchievement(1);
            }
            
            if (currentQuestion.category === 'algebra' && algebraCorrect >= 5 && !achievements[2].earned) {
                achievements[2].earned = true;
                coins += achievements[2].reward;
                showAchievement(2);
            }
            
            if (gameMode === 'speedrun' && timeSpent < 30 && !achievements[3].earned) {
                achievements[3].earned = true;
                coins += achievements[3].reward;
                showAchievement(3);
            }
            
            // Check for 'Explorer' achievement: try all difficulties
            const playedDifficulties = new Set(leaderboardData.slice(1).map(entry => entry.difficultyPlayed).filter(d => d));
            if (!achievements[4].earned && playedDifficulties.size >= 4) { // Assuming 4 difficulties: easy, medium, hard, extreme
                achievements[4].earned = true;
                coins += achievements[4].reward;
                showAchievement(4);
            }


            if (coins >= 100 && !achievements[5].earned) {
                achievements[5].earned = true;
                coins += achievements[5].reward;
                showAchievement(5);
            }
            
            if (currentLevel >= 20 && !achievements[6].earned) {
                achievements[6].earned = true;
                coins += achievements[6].reward;
                showAchievement(6);
            }
            
            if (hintsUsed === 0 && !achievements[7].earned) {
                achievements[7].earned = true;
                coins += achievements[7].reward;
                showAchievement(7);
            }
            
            updateCoinDisplay();
            updateAchievementCount();
            saveToLocalStorage();
        }

        function showAchievement(index) {
            const achievement = achievements[index];
            const achievementHtml = `
                <div class="achievement-popup">
                    <h3>Achievement Unlocked!</h3>
                    <p>${achievement.name}</p>
                    <small>${achievement.desc}</small>
                    <small>+${achievement.reward} koin</small>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', achievementHtml);
            setTimeout(() => {
                document.querySelector('.achievement-popup').remove();
            }, 3000);
        }

        function showHint() {
            hintText.textContent = currentQuestion.hint;
            hintModal.classList.add('show');
            
            closeHint.onclick = function() {
                hintModal.classList.remove('show');
                
                if (!currentQuestion.hintUsed) {
                    currentScore = Math.max(0, currentScore - 5);
                    animateCount(currentScoreDisplay, currentScore);
                    hintsUsed++;
                    updateStats();
                    currentQuestion.hintUsed = true;
                }
            };
        }

        function nextLevel() {
            resultModal.classList.remove('show');
            
            if (currentLevel < 20) {
                currentLevel++;
                startLevel();
                startTimer();
                
                if (gameMode === 'speedrun') {
                    speedRunInterval = setInterval(() => {
                        speedRunTime++;
                    }, 1000);
                }
            } else {
                quizCompleted();
            }
        }

        function quizCompleted() {
            resultTitle.textContent = 'Kuis Selesai!';
            resultMessage.textContent = `Total poin Anda: ${currentScore}`;
            nextBtn.style.display = 'none';
            resultModal.classList.add('show');
            
            leaderboardData[0].score = currentScore;
            leaderboardData[0].level = currentLevel;
            leaderboardData[0].coins = coins;
            // For 'Explorer' achievement tracking
            leaderboardData[0].difficultyPlayed = currentDifficulty; 
            saveToLocalStorage();
        }

        function goHome() {
            resultModal.classList.remove('show');
            quizContainer.style.display = 'none';
            statsContainer.style.display = 'none';
            stopTimer();
        }

        function updateStats() {
            if (levelTimes.length > 0) {
                const lastLevelTime = levelTimes[levelTimes.length - 1];
                timePerLevelDisplay.textContent = `${lastLevelTime} detik`;
            }
            
            failedAttemptsDisplay.textContent = failedAttempts;
            
            hintsUsedDisplay.textContent = hintsUsed;
            
            bestStreakDisplay.textContent = bestStreak;
            highestLevelDisplay.textContent = highestLevel;
            
            if (levelTimes.length > 0) {
                const avgTime = Math.round(levelTimes.reduce((a, b) => a + b, 0) / levelTimes.length);
                speedStatDisplay.textContent = `${avgTime} detik/level`;
            } else {
                 speedStatDisplay.textContent = `-`;
            }
        }

        function showLeaderboard() {
            const sortedLeaderboard = [...leaderboardData].sort((a, b) => b.score - a.score);
            
            leaderboardBody.innerHTML = '';
            
            sortedLeaderboard.forEach((user, index) => {
                const row = document.createElement('tr');
                if (user.name === "Anda") {
                    row.classList.add('user-rank');
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.name}</td>
                    <td>${user.score}</td>
                    <td>${user.level}</td>
                    <td>${user.coins}</td>
                `;
                
                leaderboardBody.appendChild(row);
            });
            
            leaderboardModal.classList.add('show');
        }

        function showDailyChallenge() {
            challengeProgress.style.width = `${(dailyChallengeProgress / 5) * 100}%`;
            challengeProgressText.textContent = dailyChallengeProgress;
            dailyChallengeModal.classList.add('show');
        }

        function shareResults() {
            const shareText = `Saya baru saja mencoba Matematika Kuis dan mendapatkan ${currentScore} poin di level ${currentLevel} (${currentDifficulty})! Coba tantang saya di sini!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Hasil Matematika Kuis',
                    text: shareText,
                    url: window.location.href
                }).catch(err => {
                    console.log('Error sharing:', err);
                    fallbackShare(shareText);
                });
            } else {
                fallbackShare(shareText);
            }
        }

        function fallbackShare(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Teks hasil telah disalin ke clipboard! Anda bisa membagikannya di media sosial.');
            }).catch(err => {
                console.error('Could not copy text: ', err);
                prompt('Salin teks berikut untuk membagikan hasil Anda:', text);
            });
        }

        // --- SISTEM PEMBUATAN SOAL BARU ---

        const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const getGcd = (a, b) => b === 0 ? a : getGcd(b, a % b);
        const getLcm = (a, b) => (a * b) / getGcd(a, b);
        
        function getPrimeFactorization(num) {
            const factors = {};
            let divisor = 2;
            let n = num;
            while (n >= 2) {
                if (n % divisor === 0) {
                    factors[divisor] = (factors[divisor] || 0) + 1;
                    n /= divisor;
                } else {
                    divisor++;
                }
            }
            if (Object.keys(factors).length === 0) return `${num}`; // For prime numbers themselves
            return Object.entries(factors).map(([base, exp]) => exp > 1 ? `${base}^${exp}` : `${base}`).join(' × ');
        }

        function toFraction(decimal) {
            const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
            const tolerance = 1.0E-6;
            let h1 = 1, h2 = 0;
            let k1 = 0, k2 = 1;
            let b = decimal;
            do {
                let a = Math.floor(b);
                let aux = h1; h1 = a * h1 + h2; h2 = aux;
                aux = k1; k1 = a * k1 + k2; k2 = aux;
                b = 1 / (b - a);
            } while (Math.abs(b - Math.floor(b)) > tolerance);
            return `${h1}/${k1}`;
        }

        const easyQuestions = [
            // Penjumlahan dan pengurangan bilangan bulat
            () => { const a = randInt(10, 50), b = randInt(10, 50); return { question: `Berapakah hasil dari ${a} + ${b}?`, answer: a + b, hint: "Jumlahkan kedua angka tersebut.", category: 'arithmetic', explanation: `Penjumlahan sederhana: ${a} + ${b} = ${a + b}.` }; },
            () => { const a = randInt(50, 100), b = randInt(10, 40); return { question: `Berapakah hasil dari ${a} - ${b}?`, answer: a - b, hint: "Kurangkan bilangan kedua dari bilangan pertama.", category: 'arithmetic', explanation: `Pengurangan dasar: ${a} - ${b} = ${a - b}.` }; },
            // Perkalian dan pembagian bilangan bulat
            () => { const a = randInt(5, 15), b = randInt(2, 9); return { question: `Berapakah hasil dari ${a} × ${b}?`, answer: a * b, hint: "Kalikan kedua angka tersebut.", category: 'arithmetic', explanation: `Perkalian dasar: ${a} × ${b} = ${a * b}.` }; },
            () => { const b = randInt(2, 8), a = b * randInt(5, 15); return { question: `Berapakah hasil dari ${a} ÷ ${b}?`, answer: a / b, hint: "Bagi bilangan pertama dengan bilangan kedua.", category: 'arithmetic', explanation: `Pembagian dasar: ${a} ÷ ${b} = ${a / b}.` }; },
            // KPK dan FPB
            () => { const a = randInt(6, 12), b = randInt(8, 15); return { question: `FPB dari ${a} dan ${b} adalah?`, answer: getGcd(a, b), hint: "Cari bilangan terbesar yang dapat membagi kedua angka.", category: 'arithmetic', explanation: `Faktor Persekutuan Terbesar (FPB) dari ${a} dan ${b} adalah ${getGcd(a, b)}.` }; },
            () => { const a = randInt(4, 9), b = randInt(6, 12); return { question: `KPK dari ${a} dan ${b} adalah?`, answer: getLcm(a, b), hint: "Cari bilangan terkecil yang dapat dibagi oleh kedua angka.", category: 'arithmetic', explanation: `Kelipatan Persekutuan Terkecil (KPK) dari ${a} dan ${b} adalah ${getLcm(a, b)}.` }; },
            // Pecahan (penjumlahan dan pengurangan)
            () => { const den = randInt(4, 8) * 2; const num1 = randInt(1, den/2 - 1), num2 = randInt(1, den/2 - 1); return { question: `Berapakah hasil dari ${num1}/${den} + ${num2}/${den}? (format: a/b)`, answer: `${num1 + num2}/${den / getGcd(num1 + num2, den)}`, hint: "Jumlahkan pembilangnya, penyebut tetap sama. Sederhanakan jika perlu.", category: 'arithmetic', explanation: `Karena penyebutnya sama, cukup jumlahkan pembilangnya: ${num1} + ${num2} = ${num1 + num2}. Jadi, ${num1}/${den} + ${num2}/${den} = ${num1 + num2}/${den}. Sederhanakan pecahan jika memungkinkan.` }; },
            () => { const den = randInt(4, 8) * 2; const num1 = randInt(den/2 + 1, den -1), num2 = randInt(1, den/2 - 1); return { question: `Berapakah hasil dari ${num1}/${den} - ${num2}/${den}? (format: a/b)`, answer: `${num1 - num2}/${den / getGcd(num1 - num2, den)}`, hint: "Kurangkan pembilangnya, penyebut tetap sama. Sederhanakan jika perlu.", category: 'arithmetic', explanation: `Karena penyebutnya sama, cukup kurangkan pembilangnya: ${num1} - ${num2} = ${num1 - num2}. Jadi, ${num1}/${den} - ${num2}/${den} = ${num1 - num2}/${den}. Sederhanakan pecahan jika memungkinkan.` }; },
            // Desimal (konversi dan operasi dasar)
            () => { const num = randInt(1, 9), den = [2, 4, 5, 8, 10][randInt(0, 4)]; return { question: `Berapakah bentuk desimal dari ${num}/${den}? (bulatkan 2 desimal)`, answer: (num / den).toFixed(2), hint: "Bagi pembilang dengan penyebut.", category: 'arithmetic', explanation: `Untuk mengubah pecahan ke desimal, bagi pembilang (${num}) dengan penyebut (${den}). ${num} ÷ ${den} = ${(num/den).toFixed(2)}.` }; },
            () => { const d1 = randInt(1, 10) + randInt(1, 99) / 100; const d2 = randInt(1, 10) + randInt(1, 99) / 100; return { question: `Jumlah dari ${d1.toFixed(2)} dan ${d2.toFixed(2)} adalah?`, answer: (d1 + d2).toFixed(2), hint: "Jumlahkan bilangan desimal seperti bilangan bulat, sejajarkan koma.", category: 'arithmetic', explanation: `Jumlahkan ${d1.toFixed(2)} dan ${d2.toFixed(2)} dengan menyelaraskan titik desimal: ${d1.toFixed(2)} + ${d2.toFixed(2)} = ${(d1+d2).toFixed(2)}.` }; },
            // Persentase
            () => { const percent = randInt(10, 50), value = randInt(20, 100); return { question: `Berapakah ${percent}% dari ${value}?`, answer: (percent / 100 * value).toFixed(2), hint: "Ubah persentase menjadi desimal lalu kalikan.", category: 'arithmetic', explanation: `Untuk menghitung ${percent}% dari ${value}, ubah persentase menjadi desimal (${percent}/100 = ${percent/100}) lalu kalikan dengan ${value}: ${percent/100} × ${value} = ${(percent/100 * value).toFixed(2)}.` }; },
            // Waktu dan jam
            () => { const hours = randInt(1, 10), minutes = randInt(10, 50); return { question: `Jika sekarang pukul 08:30 dan Anda menambahkan ${hours} jam ${minutes} menit, jam berapa sekarang?`, answer: new Date(2000, 0, 1, 8 + hours, 30 + minutes).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }), hint: "Jumlahkan jam dan menit secara terpisah, ingat 60 menit = 1 jam.", category: 'arithmetic', explanation: `Tambahkan ${hours} jam ke 08:30 menjadi ${8+hours}:30. Lalu tambahkan ${minutes} menit ke 30 menit. Jika melebihi 60 menit, tambahkan 1 jam ke total jam dan kurangkan 60 dari menit.` }; },
            // Pengukuran panjang, berat, dan volume
            () => { const len1 = randInt(50, 150), len2 = randInt(20, 80); return { question: `Sebuah tali panjangnya ${len1} cm. Kemudian disambung lagi ${len2} cm. Berapa panjang total tali? (dalam meter)`, answer: ((len1 + len2) / 100).toFixed(2), hint: "Jumlahkan panjangnya, lalu ubah cm ke meter (100 cm = 1 meter).", category: 'arithmetic', explanation: `Total panjang tali dalam cm adalah ${len1} + ${len2} = ${len1 + len2} cm. Untuk mengubahnya ke meter, bagi dengan 100: ${len1 + len2} / 100 = ${((len1 + len2) / 100).toFixed(2)} meter.` }; },
            // Perbandingan sederhana
            () => { const ratio1 = randInt(1, 3), ratio2 = randInt(4, 7); const val = randInt(1, 5) * ratio1; return { question: `Jika perbandingan A:B adalah ${ratio1}:${ratio2}, dan nilai A adalah ${val}, berapakah nilai B?`, answer: val / ratio1 * ratio2, hint: "Tentukan berapa kali lipat A meningkat, lalu terapkan pada B.", category: 'arithmetic', explanation: `Jika A:B = ${ratio1}:${ratio2} dan A = ${val}, maka setiap 1 bagian A adalah ${val}/${ratio1} = ${val/ratio1}. Nilai B adalah ${ratio2} bagian, jadi ${ratio2} × ${val/ratio1} = ${val/ratio1 * ratio2}.` }; },
            // Sudut dan jenis-jenis sudut
            () => { const angle = randInt(10, 80); return { question: `Sudut yang besarnya ${angle}° disebut sudut...?`, answer: "lancip", hint: "Sudut kurang dari 90 derajat.", category: 'geometry', explanation: `Sudut dengan besar kurang dari 90° disebut sudut lancip.` }; },
            // Bangun datar dan keliling
            () => { const p = randInt(5, 10), l = randInt(3, 7); return { question: `Keliling persegi panjang dengan panjang ${p} cm dan lebar ${l} cm adalah? (cm)`, answer: 2 * (p + l), hint: "Keliling persegi panjang = 2 × (panjang + lebar).", category: 'geometry', explanation: `Keliling persegi panjang dihitung dengan 2 × (panjang + lebar). Jadi, 2 × (${p} + ${l}) = 2 × ${p+l} = ${2*(p+l)} cm.` }; },
            // Bangun datar dan luas
            () => { const s = randInt(4, 9); return { question: `Luas persegi dengan sisi ${s} cm adalah? (cm²)?`, answer: s * s, hint: "Luas persegi = sisi × sisi.", category: 'geometry', explanation: `Luas persegi dihitung dengan sisi × sisi. Jadi, ${s} × ${s} = ${s*s} cm².` }; },
            // Pola bilangan sederhana
            () => { const start = randInt(2, 10), diff = randInt(1, 5); const seq = [start, start + diff, start + 2 * diff]; return { question: `Berapakah bilangan selanjutnya dalam pola: ${seq.join(', ')}, ...?`, answer: start + 3 * diff, hint: "Tentukan selisih antar bilangan dan lanjutkan pola.", category: 'arithmetic', explanation: `Pola ini adalah barisan aritmatika dengan selisih ${diff}. Bilangan selanjutnya adalah ${seq[2]} + ${diff} = ${start + 3 * diff}.` }; },
            // Data dan diagram batang
            () => { const fruits = ['Apel', 'Jeruk', 'Mangga', 'Pisang']; const sales = [randInt(5, 15), randInt(5, 15), randInt(5, 15), randInt(5, 15)]; const maxSale = Math.max(...sales); const mostPopular = fruits[sales.indexOf(maxSale)]; return { question: `Dalam diagram batang, jika Apel terjual ${sales[0]}, Jeruk ${sales[1]}, Mangga ${sales[2]}, dan Pisang ${sales[3]}, buah apakah yang paling banyak terjual?`, answer: mostPopular, hint: "Cari nilai terbesar di antara data penjualan.", category: 'arithmetic', explanation: `Berdasarkan data penjualan: Apel (${sales[0]}), Jeruk (${sales[1]}), Mangga (${sales[2]}), Pisang (${sales[3]}). Buah yang paling banyak terjual adalah ${mostPopular} dengan ${maxSale} penjualan.` }; },
            // Operasi campuran
            () => { const a = randInt(5, 10), b = randInt(2, 5), c = randInt(1, 3); return { question: `Hitunglah: ${a} + ${b} × ${c}`, answer: a + b * c, hint: "Ingat urutan operasi: perkalian sebelum penjumlahan.", category: 'arithmetic', explanation: `Menurut urutan operasi (BODMAS/PEMDAS), perkalian dilakukan lebih dulu: ${b} × ${c} = ${b*c}. Kemudian, ${a} + ${b*c} = ${a + b*c}.` }; },
            // Konversi satuan
            () => { const kg = randInt(1, 5), g = randInt(100, 900); return { question: `Berapa gram dalam ${kg} kg dan ${g} gram?`, answer: kg * 1000 + g, hint: "1 kg = 1000 gram.", category: 'arithmetic', explanation: `${kg} kg sama dengan ${kg*1000} gram. Jadi, totalnya adalah ${kg*1000} + ${g} = ${kg*1000 + g} gram.` }; },
            // Soal cerita dasar
            () => { const totalStudents = randInt(20, 40), girls = randInt(10, 20); return { question: `Di sebuah kelas ada ${totalStudents} siswa. Jika ${girls} di antaranya adalah perempuan, berapa banyak siswa laki-laki?`, answer: totalStudents - girls, hint: "Kurangkan jumlah perempuan dari total siswa.", category: 'arithmetic', explanation: `Jumlah siswa laki-laki adalah total siswa dikurangi jumlah siswa perempuan: ${totalStudents} - ${girls} = ${totalStudents - girls} siswa laki-laki.` }; },
            // Bilangan negatif dasar
            () => { const a = randInt(1, 10), b = randInt(1, 10); return { question: `Berapa hasil dari ${a} - ${a + b}?`, answer: -b, hint: "Mengurangi bilangan yang lebih besar dari yang lebih kecil akan menghasilkan negatif.", category: 'arithmetic', explanation: `Mengurangi ${a + b} dari ${a} adalah sama dengan ${a} - ${a} - ${b} = -${b}.` }; },
            // Uang dan nilai kembalian
            () => { const price = randInt(5, 10) * 1000, paid = (randInt(1, 3) * 5 + 1) * 1000; return { question: `Jika harga barang Rp${price.toLocaleString('id-ID')} dan Anda membayar dengan uang Rp${paid.toLocaleString('id-ID')}, berapa kembaliannya?`, answer: paid - price, hint: "Kembalian = Uang dibayar - Harga barang.", category: 'arithmetic', explanation: `Kembalian yang Anda dapatkan adalah jumlah uang yang Anda bayar dikurangi harga barang: Rp${paid.toLocaleString('id-ID')} - Rp${price.toLocaleString('id-ID')} = Rp${(paid - price).toLocaleString('id-ID')}.` }; }
        ];

        const mediumQuestions = [
            // Operasi bilangan rasional (pecahan dan desimal)
            () => { const num1 = randInt(1, 5), den1 = randInt(2, 6); const num2 = randInt(1, 5), den2 = randInt(2, 6); const ans = (num1/den1) + (num2/den2); return { question: `Berapakah hasil dari ${num1}/${den1} + ${num2}/${den2}? (bulatkan 2 desimal)`, answer: ans.toFixed(2), hint: "Samakan penyebutnya terlebih dahulu sebelum menjumlahkan.", category: 'arithmetic', explanation: `Untuk menjumlahkan pecahan ${num1}/${den1} dan ${num2}/${den2}, cari KPK dari penyebut (${den1}, ${den2}). Ubah kedua pecahan ke penyebut yang sama, lalu jumlahkan pembilangnya. ${num1}/${den1} + ${num2}/${den2} = ${ans.toFixed(2)}.` }; },
            () => { const num = randInt(1, 10); const dec = (randInt(1, 99) / 100).toFixed(2); return { question: `Hasil dari ${num} × ${dec} adalah? (bulatkan 2 desimal)`, answer: (num * parseFloat(dec)).toFixed(2), hint: "Kalikan bilangan bulat dengan desimal.", category: 'arithmetic', explanation: `${num} dikalikan dengan ${dec} adalah ${num * parseFloat(dec)}. Pastikan untuk menghitung posisi desimal dengan benar.` }; },
            // Persamaan linear satu variabel
            () => { const x = randInt(2, 10), b = randInt(5, 15); const c = x + b; return { question: `Jika x + ${b} = ${c}, berapakah nilai x?`, answer: x, hint: "Pindahkan angka ke sisi lain untuk menemukan nilai x.", category: 'algebra', explanation: `Untuk mencari x, kurangi kedua sisi dengan ${b}: x + ${b} - ${b} = ${c} - ${b}, sehingga x = ${x}.` }; },
            () => { const x = randInt(2, 7), a = randInt(2, 5); const c = a * x; return { question: `Jika ${a}x = ${c}, berapakah nilai x?`, answer: x, hint: "Bagi kedua sisi dengan koefisien x.", category: 'algebra', explanation: `Untuk mencari x, bagi kedua sisi dengan ${a}: ${a}x / ${a} = ${c} / ${a}, sehingga x = ${x}.` }; },
            // Sistem koordinat kartesius
            () => { const x1 = randInt(-5, 5), y1 = randInt(-5, 5), x2 = randInt(-5, 5), y2 = randInt(-5, 5); return { question: `Berapakah jarak antara titik (${x1}, ${y1}) dan (${x2}, ${y2})? (bulatkan 2 desimal)`, answer: Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2)).toFixed(2), hint: "Gunakan rumus jarak: √((x2-x1)² + (y2-y1)²).", category: 'geometry', explanation: `Menggunakan rumus jarak antara dua titik: √((x2-x1)² + (y2-y1)²). Jadi, √((${x2}-${x1})² + (${y2}-${y1})²) = √(${Math.pow(x2-x1, 2)} + ${Math.pow(y2-y1, 2)}) = √${Math.pow(x2-x1, 2) + Math.pow(y2-y1, 2)} = ${Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2)).toFixed(2)}.` }; },
            // Perbandingan senilai dan berbalik nilai
            () => { const speed1 = randInt(40, 60), time1 = randInt(2, 5); const speed2 = randInt(70, 90); return { question: `Jika sebuah mobil menempuh jarak dalam ${time1} jam dengan kecepatan ${speed1} km/jam, berapa waktu yang dibutuhkan jika kecepatannya ${speed2} km/jam? (Perbandingan berbalik nilai, bulatkan 1 desimal)`, answer: ((speed1 * time1) / speed2).toFixed(1), hint: "Jarak = kecepatan × waktu. Jarak konstan.", category: 'arithmetic', explanation: `Ini adalah perbandingan berbalik nilai. Jarak total = ${speed1} km/jam × ${time1} jam = ${speed1 * time1} km. Dengan kecepatan ${speed2} km/jam, waktu yang dibutuhkan adalah ${speed1 * time1} / ${speed2} = ${((speed1 * time1) / speed2).toFixed(1)} jam.` }; },
            // Persentase dan diskon
            () => { const price = randInt(50, 150) * 1000; const discount = randInt(10, 30); return { question: `Harga sebuah baju Rp${price.toLocaleString('id-ID')}. Jika ada diskon ${discount}%, berapa harga baju setelah diskon?`, answer: price * (1 - discount / 100), hint: "Hitung jumlah diskon, lalu kurangkan dari harga awal.", category: 'arithmetic', explanation: `Jumlah diskon adalah ${discount}% dari Rp${price.toLocaleString('id-ID')} = Rp${(price * discount / 100).toLocaleString('id-ID')}. Harga setelah diskon = Rp${price.toLocaleString('id-ID')} - Rp${(price * discount / 100).toLocaleString('id-ID')} = Rp${(price * (1 - discount / 100)).toLocaleString('id-ID')}.` }; },
            // Teorema Pythagoras (dasar)
            () => { const a = randInt(3, 8), b = randInt(3, 8); return { question: `Dalam segitiga siku-siku, jika sisi siku-sikunya ${a} cm dan ${b} cm, berapakah panjang sisi miringnya? (bulatkan 2 desimal)`, answer: Math.sqrt(a * a + b * b).toFixed(2), hint: "Gunakan teorema Pythagoras: a² + b² = c².", category: 'geometry', explanation: `Menurut Teorema Pythagoras, c² = a² + b². Jadi, c = √(${a}² + ${b}²) = √(${a*a} + ${b*b}) = √${a*a + b*b} ≈ ${Math.sqrt(a*a + b*b).toFixed(2)} cm.` }; },
            // Luas dan volume bangun ruang
            () => { const r = randInt(2, 5); return { question: `Volume bola dengan jari-jari ${r} cm adalah? (Gunakan π = 3.14, bulatkan 2 desimal)`, answer: (4/3 * 3.14 * r * r * r).toFixed(2), hint: "Volume bola = 4/3 × π × r³.", category: 'geometry', explanation: `Volume bola = 4/3 × π × r³. Jadi, 4/3 × 3.14 × ${r}³ = ${((4/3 * 3.14 * r * r * r)).toFixed(2)} cm³.` }; },
            // Menentukan gradien garis
            () => { const x1 = randInt(-3, 3), y1 = randInt(-3, 3), x2 = randInt(-3, 3), y2 = randInt(-3, 3); const slope = (y2 - y1) / (x2 - x1); if (x1 === x2) return mediumQuestions[randInt(0, mediumQuestions.length - 1)](); // Avoid vertical line, redraw
                return { question: `Berapakah gradien garis yang melalui titik (${x1}, ${y1}) dan (${x2}, ${y2})? (bulatkan 2 desimal)`, answer: slope.toFixed(2), hint: "Gradien = (y2 - y1) / (x2 - x1).", category: 'algebra', explanation: `Gradien (m) dihitung dengan rumus (y2 - y1) / (x2 - x1). Jadi, (${y2} - ${y1}) / (${x2} - ${x1}) = ${y2-y1} / ${x2-x1} = ${slope.toFixed(2)}.` }; },
            // Soal cerita aljabar
            () => { const pricePerItem = randInt(5, 10) * 1000, totalPaid = randInt(2, 4) * pricePerItem + randInt(1, 3) * 1000; return { question: `Andi membeli beberapa pulpen seharga Rp${pricePerItem.toLocaleString('id-ID')} per buah. Jika total yang dibayar Rp${totalPaid.toLocaleString('id-ID')}, berapa pulpen yang dibeli Andi?`, answer: totalPaid / pricePerItem, hint: "Total harga dibagi harga per pulpen.", category: 'algebra', explanation: `Jumlah pulpen = Total yang dibayar / Harga per pulpen = Rp${totalPaid.toLocaleString('id-ID')} / Rp${pricePerItem.toLocaleString('id-ID')} = ${totalPaid / pricePerItem} pulpen.` }; },
            // Diagram lingkaran
            () => { const total = randInt(50, 100); const percentages = shuffleArray([20, 25, 30, 25]); const labels = ['A', 'B', 'C', 'D']; const item = labels[randInt(0, 3)]; const value = Math.round(total * percentages[labels.indexOf(item)] / 100); return { question: `Dalam sebuah diagram lingkaran, jika kategori '${item}' memiliki ${percentages[labels.indexOf(item)]}% dari total ${total} responden, berapa jumlah responden untuk kategori '${item}'?`, answer: value, hint: "Hitung persentase dari total.", category: 'arithmetic', explanation: `Jumlah responden untuk kategori '${item}' adalah ${percentages[labels.indexOf(item)]}% dari ${total}, yaitu (${percentages[labels.indexOf(item)]}/100) × ${total} = ${value} responden.` }; },
            // Peluang dasar (frekuensi relatif)
            () => { const total = randInt(20, 50), event = randInt(5, 15); return { question: `Dalam 50 percobaan, sebuah kejadian muncul sebanyak ${event} kali. Berapakah frekuensi relatif kejadian tersebut? (bulatkan 2 desimal)`, answer: (event / 50).toFixed(2), hint: "Frekuensi relatif = (Jumlah kemunculan kejadian) / (Total percobaan).", category: 'arithmetic', explanation: `Frekuensi relatif kejadian dihitung dengan membagi jumlah kemunculan kejadian (${event}) dengan total percobaan (50): ${event} / 50 = ${(event/50).toFixed(2)}.` }; },
            // Statistika: modus, median, mean
            () => { const data = shuffleArray([randInt(1, 10), randInt(1, 10), randInt(1, 10), randInt(1, 10), randInt(1, 10)].sort((a,b)=>a-b)); const mean = data.reduce((sum, val) => sum + val, 0) / data.length; return { question: `Berapakah rata-rata (mean) dari data: ${data.join(', ')}? (bulatkan 2 desimal)`, answer: mean.toFixed(2), hint: "Rata-rata = Jumlah semua data / Banyaknya data.", category: 'arithmetic', explanation: `Jumlah semua data adalah ${data.reduce((sum, val) => sum + val, 0)}. Banyaknya data adalah ${data.length}. Rata-rata = ${data.reduce((sum, val) => sum + val, 0)} / ${data.length} = ${mean.toFixed(2)}.` }; },
            // Sudut pada segitiga dan segiempat
            () => { const a = randInt(30, 60), b = randInt(70, 90); return { question: `Dalam sebuah segitiga, dua sudutnya adalah ${a}° dan ${b}°. Berapakah besar sudut ketiga? (°)?`, answer: 180 - a - b, hint: "Jumlah sudut dalam segitiga adalah 180 derajat.", category: 'geometry', explanation: `Jumlah semua sudut dalam segitiga adalah 180°. Jadi, sudut ketiga = 180° - ${a}° - ${b}° = ${180 - a - b}°.` }; },
            // Pola dan barisan aritmatika
            () => { const a1 = randInt(3, 15), d = randInt(2, 7); const n = randInt(5, 10); return { question: `Suku ke-${n} dari barisan aritmatika dengan suku pertama ${a1} dan beda ${d} adalah?`, answer: a1 + (n - 1) * d, hint: "Rumus suku ke-n aritmatika: Un = a + (n-1)d.", category: 'algebra', explanation: `Menggunakan rumus suku ke-n barisan aritmatika, Un = a + (n-1)d. Suku ke-${n} adalah ${a1} + (${n}-1) × ${d} = ${a1} + ${(n-1)*d} = ${a1 + (n-1)*d}.` }; },
            // Konversi waktu dan zona waktu
            () => { const time = randInt(8, 18), offset = randInt(1, 5); return { question: `Jika di Jakarta pukul ${time}:00 WIB, pukul berapa di London yang memiliki zona waktu WIB-7?`, answer: `${(time - 7 + 24) % 24}:00`, hint: "Kurangkan perbedaan zona waktu. Ingat siklus 24 jam.", category: 'arithmetic', explanation: `Jika London adalah WIB-7, maka waktu di London adalah ${time} - 7. Karena bisa menjadi negatif, tambahkan 24 jika hasilnya negatif: (${time} - 7 + 24) % 24 = ${((time - 7 + 24) % 24)}:00.` }; },
            // Pecahan campuran ke bentuk desimal
            () => { const whole = randInt(1, 5), num = randInt(1, 3), den = [2, 4, 5, 8][randInt(0, 3)]; return { question: `Berapakah bentuk desimal dari ${whole} ${num}/${den}? (bulatkan 2 desimal)`, answer: (whole + num / den).toFixed(2), hint: "Ubah pecahan biasa menjadi desimal, lalu tambahkan bilangan bulat.", category: 'arithmetic', explanation: `${whole} ${num}/${den} sama dengan ${whole} + (${num} ÷ ${den}) = ${whole} + ${(num/den).toFixed(2)} = ${(whole + num/den).toFixed(2)}.` }; }
        ];

        const hardQuestions = [
            // Fungsi dan grafik fungsi linear & kuadrat
            () => { const m = randInt(2, 5), c = randInt(1, 10), x_val = randInt(-5, 5); return { question: `Jika f(x) = ${m}x + ${c}, berapakah nilai f(${x_val})?`, answer: m * x_val + c, hint: "Ganti 'x' dengan nilai yang diberikan dan hitung.", category: 'algebra', explanation: `Untuk mencari f(${x_val}), substitusi x = ${x_val} ke dalam fungsi: f(${x_val}) = ${m}(${x_val}) + ${c} = ${m*x_val} + ${c} = ${m*x_val + c}.` }; },
            () => { const a = randInt(1, 3), b = randInt(1, 5), c = randInt(-5, 5); const x = randInt(-3, 3); return { question: `Jika f(x) = ${a}x² + ${b}x + ${c}, berapakah nilai f(${x})?`, answer: a * x * x + b * x + c, hint: "Ganti 'x' dengan nilai yang diberikan dan hitung.", category: 'algebra', explanation: `Untuk mencari f(${x}), substitusi x = ${x} ke dalam fungsi: f(${x}) = ${a}(${x})² + ${b}(${x}) + ${c} = ${a*x*x} + ${b*x} + ${c} = ${a*x*x + b*x + c}.` }; },
            // Persamaan dan pertidaksamaan kuadrat
            () => { const r1 = randInt(1, 5), r2 = randInt(-5, -1); const b = -(r1 + r2); const c = r1 * r2; return { question: `Selesaikan persamaan kuadrat: x² ${b < 0 ? b : '+' + b}x ${c < 0 ? c : '+' + c} = 0 (pisahkan jawaban dengan koma, contoh: 2,3)`, answer: `${Math.min(r1, r2)},${Math.max(r1, r2)}`, hint: "Faktorkan persamaan atau gunakan rumus kuadrat.", isDailyChallenge: true, category: 'algebra', explanation: `Persamaan x² ${b < 0 ? b : '+' + b}x ${c < 0 ? c : '+' + c} = 0 dapat difaktorkan menjadi (x - ${r1})(x - ${r2}) = 0. Jadi solusinya adalah x = ${r1} atau x = ${r2}.` }; },
            // Barisan dan deret (aritmatika & geometri)
            () => { const a1 = randInt(2, 10), r = randInt(2, 4); const n = randInt(3, 6); return { question: `Suku ke-${n} dari barisan geometri dengan suku pertama ${a1} dan rasio ${r} adalah?`, answer: a1 * Math.pow(r, n - 1), hint: "Rumus suku ke-n geometri: Un = a × r^(n-1).", category: 'algebra', explanation: `Menggunakan rumus suku ke-n barisan geometri, Un = a × r^(n-1). Suku ke-${n} adalah ${a1} × ${r}^(${n}-1) = ${a1} × ${Math.pow(r, n-1)} = ${a1 * Math.pow(r, n-1)}.` }; },
            () => { const a1 = randInt(1, 5), d = randInt(2, 5); const n = randInt(5, 10); const sum = n/2 * (2*a1 + (n-1)*d); return { question: `Jumlah ${n} suku pertama deret aritmatika dengan suku pertama ${a1} dan beda ${d} adalah?`, answer: sum, hint: "Rumus jumlah n suku aritmatika: Sn = n/2 × (2a + (n-1)d).", category: 'algebra', explanation: `Menggunakan rumus jumlah n suku deret aritmatika, Sn = n/2 × (2a + (n-1)d). Sn = ${n}/2 × (2×${a1} + (${n}-1)×${d}) = ${n/2} × (${2*a1} + ${(n-1)*d}) = ${sum}.` }; },
            // Logaritma dan eksponen dasar
            () => { const base = randInt(2, 5), exponent = randInt(2, 4); return { question: `Logaritma basis ${base} dari ${Math.pow(base, exponent)} adalah?`, answer: exponent, hint: "log_b(b^x) = x.", category: 'arithmetic', explanation: `logaritma basis ${base} dari ${Math.pow(base, exponent)} berarti mencari pangkat berapa ${base} harus dinaikkan untuk mendapatkan ${Math.pow(base, exponent)}. Jawabannya adalah ${exponent}.` }; },
            () => { const base = randInt(2, 5), exp1 = randInt(2, 4), exp2 = randInt(2, 4); return { question: `Sederhanakan: ${base}^${exp1} × ${base}^${exp2}`, answer: `${base}^${exp1 + exp2}`, hint: "Jika basis sama, jumlahkan pangkatnya.", category: 'algebra', explanation: `Menurut aturan eksponen, ketika basisnya sama, kita bisa menjumlahkan pangkatnya: ${base}^${exp1} × ${base}^${exp2} = ${base}^(${exp1} + ${exp2}) = ${base}^${exp1 + exp2}.` }; },
            // Matriks (operasi dasar & determinan)
            () => { const a = randInt(1, 5), b = randInt(1, 5), c = randInt(1, 5), d = randInt(1, 5); return { question: `Berapakah determinan dari matriks [[${a}, ${b}], [${c}, ${d}]]?`, answer: a * d - b * c, hint: "Determinan = (a×d) - (b×c).", category: 'algebra', explanation: `Determinan matriks 2x2 [[a,b],[c,d]] adalah (a×d) - (b×c). Jadi, (${a} × ${d}) - (${b} × ${c}) = ${a*d} - ${b*c} = ${a*d - b*c}.` }; },
            // Peluang dan kombinatorik dasar
            () => { const n = randInt(3, 6); return { question: `Berapakah nilai dari ${n} Faktorial (${n}!)?`, answer: (function factorial(k) { return k === 0 ? 1 : k * factorial(k - 1); })(n), hint: "n! = n × (n-1) × ... × 1.", category: 'arithmetic', explanation: `${n}! (n faktorial) adalah hasil perkalian semua bilangan bulat positif dari 1 hingga ${n}. Jadi, ${n}! = ${Array.from({length:n}, (_,i)=>i+1).join(' × ')} = ${(function factorial(k) { return k === 0 ? 1 : k * factorial(k - 1); })(n)}.` }; },
            () => { const n = randInt(3, 7), k = randInt(1, Math.floor(n/2)); return { question: `Berapa banyak cara memilih ${k} objek dari ${n} objek berbeda tanpa memperhatikan urutan? (C(${n}, ${k}))`, answer: (function combinations(n_val, k_val) { if (k_val < 0 || k_val > n_val) return 0; if (k_val === 0 || k_val === n_val) return 1; if (k_val > n_val / 2) k_val = n_val - k_val; let res = 1; for (let i = 1; i <= k_val; ++i) { res = res * (n_val - i + 1) / i; } return res; })(n, k), hint: "Gunakan rumus kombinasi C(n,k) = n! / (k!(n-k)!).", category: 'arithmetic', explanation: `Jumlah cara memilih ${k} objek dari ${n} objek tanpa memperhatikan urutan adalah kombinasi C(${n}, ${k}) = ${n}! / (${k}!((${n}-${k})!)) = ${(function combinations(n_val, k_val) { if (k_val < 0 || k_val > n_val) return 0; if (k_val === 0 || k_val === n_val) return 1; if (k_val > n_val / 2) k_val = n_val - k_val; let res = 1; for (let i = 1; i <= k_val; ++i) { res = res * (n_val - i + 1) / i; } return res; })(n, k)}.` }; },
            // Geometri koordinat (jarak titik ke garis) - simplified
            () => { const a = randInt(1, 5), b = randInt(1, 5), c = randInt(1, 10); const x0 = randInt(-3, 3), y0 = randInt(-3, 3); return { question: `Jarak titik (${x0}, ${y0}) ke garis ${a}x + ${b}y + ${c} = 0 adalah? (bulatkan 2 desimal)`, answer: (Math.abs(a * x0 + b * y0 + c) / Math.sqrt(a*a + b*b)).toFixed(2), hint: "Gunakan rumus jarak titik ke garis.", category: 'geometry', explanation: `Rumus jarak titik (x0, y0) ke garis Ax + By + C = 0 adalah |Ax0 + By0 + C| / √(A² + B²). Jadi, |${a}(${x0}) + ${b}(${y0}) + ${c}| / √(${a}² + ${b}²) = |${a*x0 + b*y0 + c}| / √${a*a + b*b} = ${(Math.abs(a * x0 + b * y0 + c) / Math.sqrt(a*a + b*b)).toFixed(2)}.` }; },
            // Trigonometri sudut istimewa
            () => { const angle = [0, 30, 45, 60, 90][randInt(0, 4)]; return { question: `Berapakah nilai dari sin(${angle}°)? (bulatkan 2 desimal)`, answer: Math.sin(angle * Math.PI / 180).toFixed(2), hint: "Ingat nilai sin dari sudut-sudut istimewa.", category: 'geometry', explanation: `Nilai sin(${angle}°) adalah ${Math.sin(angle * Math.PI / 180).toFixed(2)}. Sebagai contoh, sin(30°) = 0.5.` }; },
            () => { const angle = [0, 30, 45, 60, 90][randInt(0, 4)]; return { question: `Berapakah nilai dari cos(${angle}°)? (bulatkan 2 desimal)`, answer: Math.cos(angle * Math.PI / 180).toFixed(2), hint: "Ingat nilai cos dari sudut-sudut istimewa.", category: 'geometry', explanation: `Nilai cos(${angle}°) adalah ${Math.cos(angle * Math.PI / 180).toFixed(2)}. Sebagai contoh, cos(60°) = 0.5.` }; },
            // Turunan dan penerapannya (kemiringan)
            () => { const a = randInt(2, 5), b = randInt(1, 5); return { question: `Turunan pertama dari f(x) = ${a}x² + ${b}x adalah? (format: 4x+2)`, answer: `${2 * a}x+${b}`, hint: "Gunakan aturan turunan pangkat: d/dx(cx^n) = n*cx^(n-1).", category: 'algebra', explanation: `Turunan dari ${a}x² adalah 2 × ${a}x¹ = ${2*a}x. Turunan dari ${b}x adalah ${b}. Jadi, turunan pertamanya adalah ${2*a}x + ${b}.` }; },
            // Limit fungsi aljabar
            () => { const val = randInt(1, 5); return { question: `Berapakah nilai lim (x→${val}) dari (x² - ${val*val}) / (x - ${val})?`, answer: 2 * val, hint: "Faktorkan pembilang lalu sederhanakan.", category: 'algebra', explanation: `Faktorkan pembilang menjadi (x - ${val})(x + ${val}). Persamaan menjadi (x - ${val})(x + ${val}) / (x - ${val}). Setelah disederhanakan menjadi x + ${val}. Ketika x mendekati ${val}, hasilnya adalah ${val} + ${val} = ${2*val}.` }; },
            // Fungsi komposisi dan invers
            () => { const a = randInt(2, 5), b = randInt(1, 10), x_val = randInt(-3, 3); return { question: `Jika f(x) = ${a}x + ${b} dan g(x) = x - ${x_val}, berapakah nilai (f ∘ g)(x)? (format: 2x+1)`, answer: `${a}x + ${b - a * x_val}`, hint: "Substitusi g(x) ke dalam f(x).", category: 'algebra', explanation: `(f ∘ g)(x) berarti f(g(x)). Ganti g(x) = x - ${x_val} ke dalam f(x) = ${a}x + ${b}. Jadi, f(x - ${x_val}) = ${a}(x - ${x_val}) + ${b} = ${a}x - ${a*x_val} + ${b} = ${a}x + ${b - a*x_val}.` }; },
            // Statistika: distribusi data
            () => { const data = shuffleArray([1, 2, 2, 3, 3, 3, 4, 4, 5, 5, 5, 5, 6, 6, 7]).slice(0, randInt(8, 12)); const mode = data.sort((a,b)=>data.filter(v=>v===a).length-data.filter(v=>v===b).length).pop(); return { question: `Berapakah modus dari data: ${data.join(', ')}?`, answer: mode, hint: "Modus adalah nilai yang paling sering muncul.", category: 'arithmetic', explanation: `Modus adalah angka yang paling sering muncul dalam sebuah kumpulan data. Dalam data ${data.join(', ')}, angka ${mode} muncul paling sering.` }; }
        ];

        const extremeQuestions = [
            // Teori bilangan (prima, modulo, kongruensi)
            () => { const n = randInt(10, 20), divisor = randInt(2, 7); return { question: `Berapakah sisa pembagian (modulo) ${n} dibagi ${divisor}? (${n} mod ${divisor})`, answer: n % divisor, hint: "Sisa pembagian.", category: 'arithmetic', explanation: `${n} mod ${divisor} adalah sisa ketika ${n} dibagi dengan ${divisor}. ${n} = ${Math.floor(n/divisor)} × ${divisor} + ${n % divisor}. Jadi, sisanya adalah ${n % divisor}.` }; },
            // Kombinatorika lanjutan (inclusion-exclusion) - simplified
            () => { const a = randInt(10, 20), b = randInt(10, 20), intersection = randInt(2, 8); return { question: `Dalam sebuah kelas, ${a} siswa suka matematika, ${b} siswa suka sains, dan ${intersection} siswa suka keduanya. Berapa total siswa yang suka matematika ATAU sains?`, answer: a + b - intersection, hint: "Total = A + B - (A iris B).", category: 'arithmetic', explanation: `Gunakan prinsip inklusi-eksklusi: |A U B| = |A| + |B| - |A ∩ B|. Jadi, ${a} + ${b} - ${intersection} = ${a + b - intersection} siswa.` }; },
            // Pembuktian matematika dasar - conceptual
            () => { return { question: `Manakah pernyataan yang BENAR tentang bilangan prima?`, answer: "Bilangan prima memiliki tepat dua faktor.", hint: "Definisi bilangan prima.", category: 'arithmetic', options: ["Bilangan prima memiliki tepat dua faktor.", "Semua bilangan ganjil adalah prima.", "Bilangan prima selalu genap.", "Bilangan prima tidak bisa dibagi 1."], explanation: `Definisi bilangan prima adalah bilangan asli lebih dari 1 yang hanya memiliki dua faktor positif berbeda, yaitu 1 dan dirinya sendiri.` }; },
            // Logika proposisional dan kuantor - conceptual
            () => { return { question: `Jika P adalah "Hari ini hujan" dan Q adalah "Saya membawa payung", apa arti dari P → Q?`, answer: "Jika hari ini hujan, maka saya membawa payung.", hint: "P → Q berarti 'Jika P maka Q'.", category: 'algebra', options: ["Hari ini hujan dan saya membawa payung.", "Jika hari ini hujan, maka saya membawa payung.", "Hari ini tidak hujan atau saya membawa payung.", "Saya membawa payung jika dan hanya jika hari ini hujan."], explanation: `Pernyataan P → Q dalam logika berarti "Jika P maka Q". Jadi, "Jika hari ini hujan, maka saya membawa payung".` }; },
            // Fungsi rekursif - simple sequence
            () => { const a0 = randInt(1, 5); return { question: `Jika a_n = a_(n-1) + 2 dan a_0 = ${a0}, berapakah a_3?`, answer: a0 + 2 * 3, hint: "Hitung suku-suku secara berurutan: a1, a2, a3.", category: 'algebra', explanation: `a_0 = ${a0}. a_1 = a_0 + 2 = ${a0+2}. a_2 = a_1 + 2 = ${a0+4}. a_3 = a_2 + 2 = ${a0+6}.` }; },
            // Persamaan fungsional - basic
            () => { const k = randInt(2, 5); return { question: `Jika f(x + 1) = f(x) + ${k} dan f(0) = 1, berapakah f(3)?`, answer: 1 + k * 3, hint: "Temukan pola pertambahan nilai fungsi.", category: 'algebra', explanation: `f(0) = 1. f(1) = f(0) + ${k} = 1 + ${k}. f(2) = f(1) + ${k} = 1 + 2${k}. f(3) = f(2) + ${k} = 1 + 3${k} = ${1 + k*3}.` }; },
            // Geometri sintetis dan pembuktian - conceptual
            () => { return { question: `Sebuah teorema geometri menyatakan bahwa jumlah sudut dalam segitiga adalah 180°. Apakah ini berlaku untuk segitiga pada permukaan bola?`, answer: "Tidak", hint: "Geometri non-Euklides.", category: 'geometry', options: ["Ya", "Tidak", "Tergantung ukuran segitiga", "Hanya jika segitiga itu siku-siku"], explanation: `Tidak. Teorema jumlah sudut 180° berlaku dalam geometri Euclidean (bidang datar). Pada permukaan bola, jumlah sudut dalam segitiga selalu lebih besar dari 180°. Ini adalah bagian dari geometri non-Euclidean.` }; },
            // Strategi permainan matematika (game theory sederhana)
            () => { return { question: `Dalam permainan Nim (2 tumpukan, ambil 1 atau 2 korek api), jika Anda memiliki 2 tumpukan masing-masing 3 dan 3 korek api, apakah langkah pertama terbaik untuk menang jika Anda memulai?`, answer: "Ambil 1 korek api dari salah satu tumpukan", hint: "Bertujuan mencapai posisi kalah untuk lawan.", category: 'arithmetic', options: ["Ambil 1 korek api dari salah satu tumpukan", "Ambil 2 korek api dari salah satu tumpukan", "Ambil semua korek api dari satu tumpukan", "Tidak ada langkah pasti untuk menang"], explanation: `Posisi (3,3) adalah posisi menang bagi pemain yang memulai. Dengan mengambil 1 korek api dari salah satu tumpukan, Anda akan meninggalkan lawan dalam posisi (2,3) atau (3,2), yang merupakan posisi kalah (bagi lawan).` }; },
            // Penerapan trigonometri dalam geometri
            () => { const side = randInt(5, 10); const angleDeg = 60; const angleRad = angleDeg * Math.PI / 180; return { question: `Sebuah tangga sepanjang ${side} meter bersandar pada dinding membentuk sudut ${angleDeg}° dengan tanah. Berapakah tinggi dinding yang dicapai tangga? (bulatkan 2 desimal)`, answer: (side * Math.sin(angleRad)).toFixed(2), hint: "Gunakan fungsi sinus: sin(sudut) = tinggi/sisi miring.", category: 'geometry', explanation: `Ini membentuk segitiga siku-siku. Tinggi dinding (depan sudut) = panjang tangga (sisi miring) × sin(sudut). Jadi, ${side} × sin(${angleDeg}°) = ${side} × ${Math.sin(angleRad).toFixed(2)} = ${(side * Math.sin(angleRad)).toFixed(2)} meter.` }; },
            // Soal logika cerita panjang - simplified
            () => { return { question: `Ani, Budi, dan Cici punya hobi berbeda: membaca, melukis, dan memasak. Ani tidak suka memasak. Budi tidak suka membaca. Siapa yang suka melukis jika yang suka memasak adalah laki-laki?`, answer: "Ani", hint: "Gunakan eliminasi. Yang suka memasak adalah laki-laki, jadi bukan Ani atau Cici.", category: 'algebra', options: ["Ani", "Budi", "Cici", "Tidak dapat ditentukan"], explanation: `Jika yang suka memasak adalah laki-laki, maka yang suka memasak adalah Budi (karena Ani dan Cici adalah perempuan). Ani tidak suka memasak, dan Budi suka memasak (dari eliminasi). Jadi, Cici suka membaca, dan Ani suka melukis.` }; },
            // Permutasi dan kombinasi ekstrem - harder combinatorics
            () => { const n = randInt(4, 7); return { question: `Berapa banyak cara menyusun ${n} buku yang berbeda pada sebuah rak?`, answer: (function factorial(k) { return k === 0 ? 1 : k * factorial(k - 1); })(n), hint: "Ini adalah soal permutasi (n!).", category: 'arithmetic', explanation: `Jumlah cara menyusun ${n} buku yang berbeda adalah ${n}! (n faktorial). ${n}! = ${Array.from({length:n}, (_,i)=>i+1).join(' × ')} = ${(function factorial(k) { return k === 0 ? 1 : k * factorial(k - 1); })(n)}.` }; },
            // Teorema dasar peluang - conditional probability simplified
            () => { const total = randInt(20, 30); const a = randInt(5, 10); const b = randInt(5, 10); const intersection = randInt(1, Math.min(a, b) - 1); return { question: `Dalam survei terhadap ${total} orang, ${a} suka kopi dan ${b} suka teh. Jika ${intersection} orang suka keduanya, berapa peluang seseorang suka kopi MENGINGAT mereka suka teh? (bulatkan 2 desimal)`, answer: (intersection / b).toFixed(2), hint: "P(A|B) = P(A ∩ B) / P(B).", category: 'arithmetic', explanation: `Peluang seseorang suka kopi MENGINGAT mereka suka teh adalah P(Kopi|Teh) = P(Kopi ∩ Teh) / P(Teh). Jumlah orang yang suka keduanya adalah ${intersection}. Jumlah orang yang suka teh adalah ${b}. Jadi, peluangnya adalah ${intersection}/${b} = ${(intersection/b).toFixed(2)}.` }; }
        ];

        function generateQuestion(difficulty) {
            let questionBank;
            switch(difficulty) {
                case 'easy': questionBank = easyQuestions; break;
                case 'medium': questionBank = mediumQuestions; break;
                case 'hard': questionBank = hardQuestions; break;
                case 'extreme': questionBank = extremeQuestions; break;
                default: questionBank = easyQuestions;
            }

            // Filter out already used questions for the current difficulty
            let availableIndices = Array.from({length: questionBank.length}, (_, i) => i)
                .filter(i => !usedQuestions.has(`${difficulty}-${i}`));

            // If all questions for this difficulty have been used, reset the pool for this difficulty
            if (availableIndices.length === 0) {
                for (let i = 0; i < questionBank.length; i++) {
                    usedQuestions.delete(`${difficulty}-${i}`);
                }
                availableIndices = Array.from({length: questionBank.length}, (_, i) => i);
            }

            const randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
            usedQuestions.add(`${difficulty}-${randomIndex}`);
            
            const questionGenerator = questionBank[randomIndex];
            const generated = questionGenerator();
            
            // Re-engineer the explanation if it's a function (for dynamic content)
            if (typeof generated.explanation === 'function') {
                const q = generated.question;
                const a = generated.answer;
                // Extract numbers (integers or decimals) from question for dynamic explanation if needed
                const numbersInQuestion = (q.match(/-?\d+(\.\d+)?/g) || []).map(Number);
                generated.explanation = generated.explanation(q, a, numbersInQuestion);
            }

            if (useOptions) {
                generated.options = generateOptions(generated.answer, generated.category);
            }

            return generated;
        }

        function generateOptions(correctAnswer, category) {
            const options = [correctAnswer];
            const answerType = typeof correctAnswer;

            // Generate deceptive numerical options
            if (answerType === 'number') {
                const num = parseFloat(correctAnswer);
                let range = Math.max(1, Math.abs(num * 0.1)); // Smaller range for more deceptive options
                if (num === 0) range = 1; // Handle 0 specifically to avoid 0 range

                while (options.length < 4) {
                    let option;
                    let typeOfDeception = randInt(1, 3); // 1: simple offset, 2: slightly larger/smaller, 3: common mistake
                    
                    if (typeOfDeception === 1) {
                        option = (Math.random() > 0.5) ? num + randInt(1, 2) * range / 2 : num - randInt(1, 2) * range / 2;
                    } else if (typeOfDeception === 2) {
                        option = (Math.random() > 0.5) ? num + randInt(1, 3) * range : num - randInt(1, 3) * range;
                    } else { // common mistake type
                        // Specific common mistakes based on category
                        if (category === 'arithmetic') {
                            if (num % 2 === 0 && num > 0) { // e.g., for division questions, options might be off by 1
                                option = num + (Math.random() > 0.5 ? 1 : -1);
                            } else {
                                option = num * (Math.random() > 0.5 ? 2 : 0.5); // multiplication/division errors
                            }
                        } else if (category === 'geometry' && num > 0) { // e.g., area vs perimeter, or small calculation error
                            option = num + (Math.random() > 0.5 ? 0.01 : -0.01); // slight precision error
                        } else if (category === 'algebra' && num !== 0) { // e.g., sign errors
                            option = -num;
                        } else {
                            option = (Math.random() > 0.5) ? num + randInt(1, 2) * range : num - randInt(1, 2) * range;
                        }
                    }

                    // Ensure numerical answers are rounded appropriately if the correct answer is
                    if (Number.isInteger(num)) {
                        option = Math.round(option);
                    } else {
                        const decimalPlaces = correctAnswer.toString().split('.')[1]?.length || 0;
                        option = parseFloat(option.toFixed(decimalPlaces));
                    }
                    
                    // Ensure options are distinct and not equal to the correct answer
                    if (!options.includes(option) && Math.abs(option - num) > 0.001) { // Use tolerance for float comparison
                        options.push(option);
                    }
                }
            } 
            // Generate deceptive text options
            else { 
                const correctStr = correctAnswer.toString().toLowerCase();
                let similarOptions = new Set();
                
                // Add variations: typo, slight modification, opposite, related term
                similarOptions.add(correctStr.split('').reverse().join('')); // Reversed string
                similarOptions.add(correctStr.substring(0, correctStr.length - 1) + String.fromCharCode(correctStr.charCodeAt(correctStr.length - 1) + 1)); // Last char + 1
                similarOptions.add(correctStr.substring(0, correctStr.length - 1) + String.fromCharCode(correctStr.charCodeAt(correctStr.length - 1) - 1)); // Last char - 1
                
                if (correctStr === "lancip") similarOptions.add("tumpul");
                if (correctStr === "tumpul") similarOptions.add("lancip");
                if (correctStr === "benar") similarOptions.add("salah");
                if (correctStr === "tidak") similarOptions.add("ya");
                if (correctStr === "matematika") similarOptions.add("fisika");

                // If correct answer is a specific name/term, add other names/terms from the question/context
                if (correctStr === "ani") similarOptions.add("budi"); similarOptions.add("cici");
                if (correctStr === "budi") similarOptions.add("ani"); similarOptions.add("cici");
                if (correctStr === "cici") similarOptions.add("ani"); similarOptions.add("budi");


                // Add these to options, ensuring uniqueness and not adding the correct answer itself
                similarOptions.forEach(opt => {
                    if (options.length < 4 && opt.toLowerCase() !== correctStr) {
                        options.push(opt);
                    }
                });

                // Fill remaining spots with random, somewhat plausible but incorrect terms
                while(options.length < 4) {
                    let randomTerm;
                    const randomType = randInt(1,3);
                    if (randomType === 1 && category === 'arithmetic') randomTerm = "pecahan";
                    else if (randomType === 2 && category === 'geometry') randomTerm = "lingkaran";
                    else if (randomType === 3 && category === 'algebra') randomTerm = "variabel";
                    else randomTerm = `Opsi ${options.length + 1}`; // Generic fallback

                    if (!options.includes(randomTerm) && randomTerm.toLowerCase() !== correctStr) {
                        options.push(randomTerm);
                    }
                }
            }
            return shuffleArray(options);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    </script>
</body>
</html>
