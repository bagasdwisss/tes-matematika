<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matematika Kuis</title>
    <link rel="icon" type="image/x-icon" href="assets/iconnew.png" />
    <style>
        :root {
            --primary: #4a6bff;
            --secondary: #f5f7ff;
            --accent: #ff6b6b;
            --text: #333;
            --light-text: #666;
            --background: #fff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --dark-bg: #1a1a2e;
            --dark-secondary: #16213e;
            --dark-text: #f5f7ff;
            --success: #6bce70;
            --warning: #f0ad4e;
            --danger: #d9534f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--secondary);
            color: var(--text);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background-color: var(--background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .dark-mode header {
            background-color: var(--dark-secondary);
            color: var(--dark-text);
        }

        h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .difficulty-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .difficulty-btn:hover {
            transform: translateY(-3px);
        }

        .easy {
            background-color: #6bce70;
            color: white;
        }

        .medium {
            background-color: #f0ad4e;
            color: white;
        }

        .hard {
            background-color: #d9534f;
            color: white;
        }

        .extreme {
            background-color: #5d3a9b;
            color: white;
        }

        .settings-panel {
            background-color: var(--background);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .dark-mode .settings-panel {
            background-color: var(--dark-secondary);
        }

        .settings-title {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .settings-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .quiz-container {
            display: none;
            background-color: var(--background);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .dark-mode .quiz-container {
            background-color: var(--dark-secondary);
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .dark-mode .quiz-header {
            border-bottom-color: #444;
        }

        .level-info {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .score-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .score {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .question-container {
            margin-bottom: 30px;
        }

        .question {
            font-size: 1.3rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .answer-field {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            margin-bottom: 15px;
            transition: all 0.3s;
            background-color: var(--background);
            color: var(--text);
        }

        .dark-mode .answer-field {
            background-color: #16213e;
            border-color: #444;
            color: var(--dark-text);
        }

        .answer-field:focus {
            border-color: var(--primary);
            outline: none;
        }

        .answer-field.correct {
            border-color: var(--success);
            animation: pulseCorrect 0.5s;
        }

        .answer-field.incorrect {
            border-color: var(--danger);
            animation: shake 0.5s;
        }

        @keyframes pulseCorrect {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .answer-options {
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .option-btn {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            background-color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .dark-mode .option-btn {
            background-color: #16213e;
            border-color: #444;
            color: var(--dark-text);
        }

        .option-btn:hover {
            border-color: var(--primary);
            background-color: var(--secondary);
        }

        .dark-mode .option-btn:hover {
            background-color: #1a1a2e;
        }

        .quiz-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .hint-btn {
            background-color: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--light-text);
            transition: color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dark-mode .hint-btn {
            color: #aaa;
        }

        .hint-btn:hover {
            color: var(--primary);
        }

        .submit-btn {
            padding: 12px 25px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .submit-btn:hover {
            background-color: #3a5bed;
        }
        
        .clear-btn {
            background-color: #6c757d;
        }
        .clear-btn:hover {
            background-color: #5a6268;
        }

        .scratch-pad {
            margin-top: 30px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            height: 200px;
            width: 100%;
            background-color: white;
            position: relative;
        }

        .dark-mode .scratch-pad {
            border-color: #444;
            background-color: #16213e;
        }

        .scratch-texture {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.1;
            background-size: 40px 40px;
            background-image: linear-gradient(to right, grey 1px, transparent 1px),
                              linear-gradient(to bottom, grey 1px, transparent 1px);
        }

        .stats-container {
            background-color: var(--background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: none;
            transition: all 0.3s ease;
        }

        .dark-mode .stats-container {
            background-color: var(--dark-secondary);
        }

        .stats-title {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background-color: var(--secondary);
            padding: 15px;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
        }

        .dark-mode .stat-item {
            background-color: #1a1a2e;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--light-text);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .hint-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .hint-modal.show {
            display: flex;
            opacity: 1;
        }

        .hint-content {
            background-color: var(--background);
            padding: 25px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            transform: scale(0.9);
            opacity: 0;
            animation: modalFadeIn 0.3s forwards;
        }

        .dark-mode .hint-content {
            background-color: var(--dark-secondary);
        }

        .hint-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .hint-title {
            color: var(--primary);
            font-size: 1.3rem;
        }

        .close-hint {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
        }

        .hint-text {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .hint-points {
            color: var(--accent);
            font-weight: bold;
        }

        .result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .result-modal.show {
            display: flex;
            opacity: 1;
        }

        .result-content {
            background-color: var(--background);
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            transform: scale(0.9);
            opacity: 0;
            animation: modalFadeIn 0.3s forwards;
        }

        .dark-mode .result-content {
            background-color: var(--dark-secondary);
        }

        .result-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .correct {
            color: #6bce70;
        }

        .incorrect {
            color: #d9534f;
        }

        .result-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .result-message {
            margin-bottom: 20px;
            color: var(--light-text);
            line-height: 1.5;
        }

        .result-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .next-btn {
            background-color: var(--primary);
            color: white;
        }

        .next-btn:hover {
            background-color: #3a5bed;
        }

        .home-btn {
            background-color: #eee;
            color: var(--text);
        }

        .dark-mode .home-btn {
            background-color: #444;
            color: var(--dark-text);
        }

        .home-btn:hover {
            background-color: #ddd;
        }

        .dark-mode .home-btn:hover {
            background-color: #555;
        }

        /* New styles for additional features */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: transform 0.3s;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .timer-container {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 1.1rem;
        }

        .timer {
            font-weight: bold;
            color: var(--primary);
        }

        .streak-container {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 15px;
        }

        .streak-count {
            font-weight: bold;
            color: #ff9500;
        }

        .leaderboard-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background-color: #5d3a9b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: transform 0.3s;
        }

        .leaderboard-btn:hover {
            transform: scale(1.1);
        }

        .daily-challenge-btn {
            position: fixed;
            bottom: 140px;
            right: 20px;
            background-color: #6bce70;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: transform 0.3s;
        }

        .daily-challenge-btn:hover {
            transform: scale(1.1);
        }

        .coin-shop-btn {
            position: fixed;
            bottom: 200px;
            right: 20px;
            background-color: #ffd700;
            color: #333;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: transform 0.3s;
        }

        .coin-shop-btn:hover {
            transform: scale(1.1);
        }

        .leaderboard-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .leaderboard-modal.show {
            display: flex;
            opacity: 1;
        }

        .leaderboard-content {
            background-color: var(--background);
            padding: 25px;
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 90%;
            box-shadow: var(--shadow);
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            opacity: 0;
            animation: modalFadeIn 0.3s forwards;
        }

        .dark-mode .leaderboard-content {
            background-color: var(--dark-secondary);
        }

        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .leaderboard-title {
            color: var(--primary);
            font-size: 1.5rem;
        }

        .close-leaderboard {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th, 
        .leaderboard-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .dark-mode .leaderboard-table th,
        .dark-mode .leaderboard-table td {
            border-bottom-color: #444;
        }

        .leaderboard-table th {
            background-color: var(--secondary);
            font-weight: bold;
        }

        .dark-mode .leaderboard-table th {
            background-color: #1a1a2e;
        }

        .leaderboard-table tr:nth-child(even) {
            background-color: var(--secondary);
        }

        .dark-mode .leaderboard-table tr:nth-child(even) {
            background-color: #1a1a2e;
        }

        .user-rank {
            font-weight: bold;
            color: var(--primary);
        }

        .share-btn {
            background-color: #4a6bff;
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .share-btn:hover {
            background-color: #3a5bed;
        }

        .daily-challenge-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .daily-challenge-modal.show {
            display: flex;
            opacity: 1;
        }

        .daily-challenge-content {
            background-color: var(--background);
            padding: 25px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow);
            transform: scale(0.9);
            opacity: 0;
            animation: modalFadeIn 0.3s forwards;
        }

        .dark-mode .daily-challenge-content {
            background-color: var(--dark-secondary);
        }

        .daily-challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .daily-challenge-title {
            color: var(--primary);
            font-size: 1.5rem;
        }

        .close-daily-challenge {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
        }

        .daily-challenge-badge {
            display: inline-block;
            background-color: #6bce70;
            color: white;
            padding: 5px 10px;
            border-radius: var(--border-radius);
            font-weight: bold;
            margin-bottom: 15px;
        }

        .progress-container {
            width: 100%;
            background-color: #eee;
            border-radius: var(--border-radius);
            margin: 15px 0;
            height: 20px;
        }

        .dark-mode .progress-container {
            background-color: #444;
        }

        .progress-bar {
            height: 100%;
            border-radius: var(--border-radius);
            background-color: var(--primary);
            width: 0%;
            transition: width 0.5s ease;
        }

        .fun-fact {
            background-color: var(--secondary);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            font-style: italic;
            position: relative;
            overflow: hidden;
            min-height: 60px;
            transition: all 0.3s ease;
        }

        .dark-mode .fun-fact {
            background-color: #1a1a2e;
        }

        .fun-fact-content {
            position: relative;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fun-fact strong {
            display: block;
            margin-bottom: 5px;
            color: var(--primary);
        }

        .fun-fact::before {
            content: "üí°";
            position: absolute;
            left: 10px;
            top: 10px;
            opacity: 0.2;
            font-size: 2rem;
            z-index: 0;
        }

        .fun-fact:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .fun-fact:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .streak-fire {
            color: #ff9500;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* New Features Styles */
        .achievement-popup {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--primary);
            color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1000;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        .game-mode-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .game-mode-btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            background-color: #6c757d;
            color: white;
        }

        .game-mode-btn:hover {
            transform: translateY(-3px);
        }

        .game-mode-btn.active {
            background-color: var(--primary);
        }

        .coin-display {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 1.1rem;
            margin-left: 15px;
        }

        .coin-icon {
            color: #ffd700;
        }

        .skill-progress {
            width: 100%;
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }

        .dark-mode .skill-progress {
            background-color: #444;
        }

        .skill-progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.5s ease;
        }

        .skill-item {
            margin-bottom: 15px;
        }

        .skill-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        /* Coin Shop Styles */
        .coin-shop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .coin-shop-modal.show {
            display: flex;
            opacity: 1;
        }

        .coin-shop-content {
            background-color: var(--background);
            padding: 25px;
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 90%;
            box-shadow: var(--shadow);
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            opacity: 0;
            animation: modalFadeIn 0.3s forwards;
        }

        .dark-mode .coin-shop-content {
            background-color: var(--dark-secondary);
        }

        .coin-shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .coin-shop-title {
            color: var(--primary);
            font-size: 1.5rem;
        }

        .close-coin-shop {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
        }

        .coin-shop-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .coin-shop-tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .coin-shop-tab.active {
            border-bottom-color: var(--primary);
            font-weight: bold;
        }

        .coin-shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .coin-shop-item {
            background-color: var(--secondary);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .dark-mode .coin-shop-item {
            background-color: #1a1a2e;
        }

        .coin-shop-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .coin-shop-item-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .coin-shop-item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .coin-shop-item-price {
            color: #ffd700;
            font-weight: bold;
        }

        .coin-shop-item-owned {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .coin-shop-item-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Power-ups */
        .power-ups-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .power-up-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .power-up-btn:hover {
            background-color: #3a5bed;
        }

        .power-up-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Count Animation */
        .count-up {
            transition: color 0.3s;
            display: inline-block;
        }

        .count-up.animate {
            animation: countPop 0.5s;
            color: #ffd700;
        }

        @keyframes countPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Modal Animation */
        @keyframes modalFadeIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Story Problem Styles */
        .story-problem {
            background-color: var(--secondary);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }

        .dark-mode .story-problem {
            background-color: #1a1a2e;
        }

        /* Scratch Pad Textures */
        .texture-grid {
            background-size: 20px 20px;
            background-image: linear-gradient(to right, rgba(0,0,0,0.1) 1px, transparent 1px),
                              linear-gradient(to bottom, rgba(0,0,0,0.1) 1px, transparent 1px);
        }

        .texture-dots {
            background-size: 10px 10px;
            background-image: radial-gradient(circle, rgba(0,0,0,0.1) 1px, transparent 1px);
        }

        .texture-lined {
            background-size: 100% 24px;
            background-image: linear-gradient(to bottom, rgba(0,0,0,0.1) 1px, transparent 1px);
        }

        /* Theme Preview */
        .theme-preview {
            width: 100%;
            height: 60px;
            border-radius: var(--border-radius);
            margin-top: 10px;
            border: 1px solid #ddd;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .difficulty-selector {
                flex-direction: column;
                align-items: center;
            }

            .difficulty-btn {
                width: 100%;
            }

            .answer-options {
                grid-template-columns: 1fr;
            }

            .quiz-controls {
                flex-direction: column;
                gap: 15px;
            }
            .action-buttons {
                width: 100%;
                justify-content: space-between;
            }
            .hint-btn {
                order: -1;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .theme-toggle, 
            .leaderboard-btn,
            .daily-challenge-btn,
            .coin-shop-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .leaderboard-btn {
                bottom: 70px;
            }

            .daily-challenge-btn {
                bottom: 120px;
            }

            .coin-shop-btn {
                bottom: 170px;
            }

            .achievement-popup {
                width: calc(100% - 40px);
                left: 20px;
            }

            .coin-shop-items {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 480px) {
            .coin-shop-items {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Matematika Kuis</h1>
            <p>Uji kemampuan matematika Anda dengan berbagai tingkat kesulitan!</p>
        </header>

        <div class="settings-panel">
            <h2 class="settings-title">Pengaturan</h2>
            <div class="settings-options">
                <label>
                    <span>Gunakan Opsi Jawaban:</span>
                    <label class="switch">
                        <input type="checkbox" id="useOptionsToggle">
                        <span class="slider"></span>
                    </label>
                </label>
                <label>
                    <span>Mode Gelap:</span>
                    <label class="switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </label>
            </div>
        </div>

        <div class="game-mode-selector" id="gameModeSelector">
            <button class="game-mode-btn active" data-mode="normal">Mode Normal</button>
            <button class="game-mode-btn" data-mode="speedrun">Speed Run</button>
        </div>

        <div class="difficulty-selector">
            <button class="difficulty-btn easy" data-difficulty="easy">Mudah</button>
            <button class="difficulty-btn medium" data-difficulty="medium">Menengah</button>
            <button class="difficulty-btn hard" data-difficulty="hard">Sulit</button>
            <button class="difficulty-btn extreme" data-difficulty="extreme">Ekstrem</button>
        </div>

        <div class="quiz-container" id="quizContainer">
            <div class="quiz-header">
                <div class="level-info">
                    Level <span id="currentLevel">1</span>/20 - 
                    <span id="difficultyDisplay">Mudah</span>
                    <div class="streak-container">
                        <span class="streak-fire">üî•</span>
                        <span class="streak-count" id="streakCount">0</span>
                    </div>
                    <div class="coin-display">
                        <span class="coin-icon">ü™ô</span>
                        <span id="coinCount">0</span>
                    </div>
                </div>
                <div class="score-container">
                    <span>Poin:</span>
                    <span class="score" id="currentScore">0</span>
                    <div class="timer-container">
                        <span>‚è±Ô∏è</span>
                        <span class="timer" id="timer">0</span>
                    </div>
                </div>
            </div>

            <div class="question-container">
                <div class="question" id="questionText"></div>
                
                <input type="text" class="answer-field" id="answerInput" placeholder="Masukkan jawaban Anda...">
                
                <div class="answer-options" id="answerOptions">
                </div>

                <div class="power-ups-container" id="powerUpsContainer">
                    <!-- Power-ups will be added here dynamically -->
                </div>
            </div>

            <div class="quiz-controls">
                <button class="hint-btn" id="hintBtn">
                    <span>üí°</span> Tips (-5 poin)
                </button>
                <div class="action-buttons">
                    <button class="submit-btn clear-btn" id="clearCanvasBtn">Bersihkan</button>
                    <button class="submit-btn" id="submitBtn">Submit</button>
                </div>
            </div>

            <div class="scratch-pad" id="scratchPad">
                <div class="scratch-texture" id="scratchTexture"></div>
            </div>
        </div>

        <div class="stats-container" id="statsContainer">
            <h2 class="stats-title">Statistik Permainan</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Waktu per Level</div>
                    <div class="stat-value" id="timePerLevel">0 detik</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Percobaan Gagal</div>
                    <div class="stat-value" id="failedAttempts">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Kecepatan</div>
                    <div class="stat-value" id="speedStat">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Tips Digunakan</div>
                    <div class="stat-value" id="hintsUsed">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Streak Terbaik</div>
                    <div class="stat-value" id="bestStreak">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Level Tertinggi</div>
                    <div class="stat-value" id="highestLevel">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total Koin</div>
                    <div class="stat-value" id="totalCoins">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Achievement</div>
                    <div class="stat-value" id="achievementCount">0/8</div>
                </div>
            </div>

            <div class="skill-item">
                <div class="skill-label">
                    <span>Aljabar</span>
                    <span id="algebraPercent">0%</span>
                </div>
                <div class="skill-progress">
                    <div class="skill-progress-bar" id="algebraProgress"></div>
                </div>
            </div>

            <div class="skill-item">
                <div class="skill-label">
                    <span>Geometri</span>
                    <span id="geometryPercent">0%</span>
                </div>
                <div class="skill-progress">
                    <div class="skill-progress-bar" id="geometryProgress"></div>
                </div>
            </div>

            <div class="skill-item">
                <div class="skill-label">
                    <span>Aritmatika</span>
                    <span id="arithmeticPercent">0%</span>
                </div>
                <div class="skill-progress">
                    <div class="skill-progress-bar" id="arithmeticProgress"></div>
                </div>
            </div>

            <button class="share-btn" id="shareBtn">
                <span>üì§</span> Bagikan Hasil
            </button>
        </div>

        <div class="fun-fact" id="funFact">
            <div class="fun-fact-content">
                <strong>Fakta Menarik:</strong> Tahukah Anda bahwa angka 0.999... (angka 9 berulang tak terbatas) sebenarnya sama dengan 1?
            </div>
        </div>
    </div>

    <div class="hint-modal" id="hintModal">
        <div class="hint-content">
            <div class="hint-header">
                <h3 class="hint-title">Tips Penyelesaian</h3>
                <button class="close-hint" id="closeHint">&times;</button>
            </div>
            <div class="hint-text" id="hintText"></div>
            <p>Anda akan kehilangan <span class="hint-points">5 poin</span> untuk melihat tips ini.</p>
        </div>
    </div>

    <div class="result-modal" id="resultModal">
        <div class="result-content">
            <div class="result-icon correct" id="resultIcon">‚úì</div>
            <h3 class="result-title" id="resultTitle">Jawaban Benar!</h3>
            <p class="result-message" id="resultMessage"></p>
            <div class="result-actions">
                <button class="modal-btn home-btn" id="homeBtn">Beranda</button>
                <button class="modal-btn next-btn" id="nextBtn">Level Berikutnya</button>
            </div>
        </div>
    </div>

    <div class="leaderboard-modal" id="leaderboardModal">
        <div class="leaderboard-content">
            <div class="leaderboard-header">
                <h3 class="leaderboard-title">Papan Peringkat</h3>
                <button class="close-leaderboard" id="closeLeaderboard">&times;</button>
            </div>
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>Peringkat</th>
                        <th>Nama</th>
                        <th>Skor</th>
                        <th>Level</th>
                        <th>Koin</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="daily-challenge-modal" id="dailyChallengeModal">
        <div class="daily-challenge-content">
            <div class="daily-challenge-header">
                <h3 class="daily-challenge-title">Tantangan Harian</h3>
                <button class="close-daily-challenge" id="closeDailyChallenge">&times;</button>
            </div>
            <div class="daily-challenge-badge">Hari Ini: Aljabar Dasar</div>
            <p>Selesaikan 5 soal aljabar untuk mendapatkan poin bonus!</p>
            <div class="progress-container">
                <div class="progress-bar" id="challengeProgress" style="width: 0%"></div>
            </div>
            <p>Progress: <span id="challengeProgressText">0</span>/5</p>
            <div class="fun-fact">
                <strong>Fakta Menarik:</strong> Kata "aljabar" berasal dari bahasa Arab "al-jabr" yang berarti "penyatuan bagian yang rusak".
            </div>
        </div>
    </div>

    <div class="coin-shop-modal" id="coinShopModal">
        <div class="coin-shop-content">
            <div class="coin-shop-header">
                <h3 class="coin-shop-title">Toko Koin <span class="coin-icon">ü™ô</span> <span id="shopCoinCount">0</span></h3>
                <button class="close-coin-shop" id="closeCoinShop">&times;</button>
            </div>
            <div class="coin-shop-tabs">
                <div class="coin-shop-tab active" data-tab="powerups">Power-ups</div>
                <div class="coin-shop-tab" data-tab="themes">Tema</div>
                <div class="coin-shop-tab" data-tab="textures">Tekstur</div>
            </div>
            <div class="coin-shop-items" id="powerupsTab">
                <!-- Power-ups items will be added here dynamically -->
            </div>
            <div class="coin-shop-items" id="themesTab" style="display: none;">
                <!-- Theme items will be added here dynamically -->
            </div>
            <div class="coin-shop-items" id="texturesTab" style="display: none;">
                <!-- Texture items will be added here dynamically -->
            </div>
        </div>
    </div>

    <button class="theme-toggle" id="themeToggle">üåì</button>
    <button class="leaderboard-btn" id="leaderboardBtn">üèÜ</button>
    <button class="daily-challenge-btn" id="dailyChallengeBtn">üìÖ</button>
    <button class="coin-shop-btn" id="coinShopBtn">üõí</button>

    <script>
        // Variabel global
        let currentDifficulty = '';
        let currentLevel = 1;
        let currentScore = 0;
        let useOptions = false;
        let hintsUsed = 0;
        let failedAttempts = 0;
        let levelStartTime = 0;
        let levelTimes = [];
        let currentQuestion = {};
        let canvas;
        let ctx;
        let timerInterval;
        let currentStreak = 0;
        let bestStreak = 0;
        let highestLevel = 0;
        let dailyChallengeProgress = 0;
        let dailyChallengeCompleted = false;
        let darkMode = false;
        let gameMode = 'normal';
        let coins = 0;
        let totalQuestionsAnswered = 0;
        let algebraCorrect = 0;
        let geometryCorrect = 0;
        let arithmeticCorrect = 0;
        let speedRunTime = 0;
        let speedRunInterval;
        let factInterval;
        let usedQuestions = new Set();
        let activePowerUps = [];
        let ownedItems = {
            powerups: {},
            themes: {},
            textures: {}
        };
        let currentTheme = 'default';
        let currentTexture = 'grid';

        // Data achievement
        const achievements = [
            { id: 1, name: "Pemula", desc: "Selesaikan level 5", earned: false, reward: 10 },
            { id: 2, name: "Ahli Hitung", desc: "Jawab 10 soal benar berturut-turut", earned: false, reward: 20 },
            { id: 3, name: "Master Aljabar", desc: "Jawab 5 soal aljabar dengan benar", earned: false, reward: 15 },
            { id: 4, name: "Speed Runner", desc: "Selesaikan level dalam waktu <30 detik", earned: false, reward: 25 },
            { id: 5, name: "Penjelajah", desc: "Coba semua tingkat kesulitan", earned: false, reward: 30 },
            { id: 6, name: "Kolektor Koin", desc: "Kumpulkan 100 koin", earned: false, reward: 50 },
            { id: 7, name: "Tak Terhentikan", desc: "Selesaikan 20 level", earned: false, reward: 40 },
            { id: 8, name: "Tanpa Bantuan", desc: "Selesaikan level tanpa menggunakan hint", earned: false, reward: 20 }
        ];

        // Data leaderboard dummy
        let leaderboardData = [
            { name: "Anda", score: 0, level: 0, coins: 0 },
            { name: "Matematikus", score: 450, level: 20, coins: 120 },
            { name: "Pecinta Angka", score: 380, level: 18, coins: 95 },
            { name: "Ahli Aljabar", score: 320, level: 16, coins: 80 },
            { name: "Raja Geometri", score: 290, level: 15, coins: 75 }
        ];

        // Power-ups data
        const powerUps = [
            { id: 'removeTwo', name: 'Hilangkan 2 Opsi', icon: '‚ùå', price: 30, description: 'Hilangkan 2 opsi jawaban yang salah', uses: 3 },
            { id: 'showAnswer', name: 'Lihat Jawaban', icon: 'üëÅÔ∏è', price: 50, description: 'Tunjukkan jawaban yang benar', uses: 1 },
            { id: 'timeFreeze', name: 'Bekukan Waktu', icon: '‚è∏Ô∏è', price: 40, description: 'Hentikan timer selama 10 detik', uses: 2 },
            { id: 'doublePoints', name: 'Poin Ganda', icon: '‚úñÔ∏è2', price: 60, description: 'Dapatkan poin ganda untuk jawaban benar berikutnya', uses: 1 }
        ];

        // Theme data
        const themes = [
            { id: 'default', name: 'Standar', icon: 'üé®', price: 0, description: 'Tema standar biru', colors: { primary: '#4a6bff', secondary: '#f5f7ff', accent: '#ff6b6b' } },
            { id: 'dark', name: 'Gelap', icon: 'üåë', price: 20, description: 'Tema gelap untuk mata', colors: { primary: '#6bce70', secondary: '#1a1a2e', accent: '#ff9500' } },
            { id: 'sunset', name: 'Matahari Terbenam', icon: 'üåá', price: 30, description: 'Nuansa oranye dan ungu', colors: { primary: '#ff7e5f', secondary: '#feb47b', accent: '#6a3093' } },
            { id: 'ocean', name: 'Lautan', icon: 'üåä', price: 25, description: 'Nuansa biru laut', colors: { primary: '#1e88e5', secondary: '#bbdefb', accent: '#ff5722' } },
            { id: 'forest', name: 'Hutan', icon: 'üå≤', price: 35, description: 'Nuansa hijau alami', colors: { primary: '#2e7d32', secondary: '#c8e6c9', accent: '#ff8f00' } }
        ];

        // Texture data
        const textures = [
            { id: 'grid', name: 'Kotak-kotak', icon: 'üî≤', price: 0, description: 'Tekstur kotak-kotak standar', class: 'texture-grid' },
            { id: 'dots', name: 'Titik-titik', icon: 'üîµ', price: 15, description: 'Tekstur titik-titik', class: 'texture-dots' },
            { id: 'lined', name: 'Garis', icon: 'üìù', price: 20, description: 'Tekstur bergaris', class: 'texture-lined' },
            { id: 'blank', name: 'Polos', icon: '‚¨ú', price: 10, description: 'Tanpa tekstur', class: '' }
        ];

        // Fakta matematika acak
        const mathFacts = [
            // --- Fakta Angka & Teori Bilangan ---
            "Konstanta Kaprekar: Pilih angka 4 digit dengan setidaknya dua digit berbeda, urutkan menurun dan menaik, kurangi hasilnya. Ulangi prosesnya, dan Anda akan selalu berakhir di angka 6174.",
            "Bilangan Vampir adalah bilangan yang 'dapat dihidupkan kembali' oleh dua 'taring' (faktor) yang diambil dari digitnya sendiri. Contoh: 2187 = 27 √ó 81.",
            "Dalam sekelompok 23 orang, peluang dua orang memiliki tanggal ulang tahun yang sama lebih dari 50%. Ini dikenal sebagai Paradoks Ulang Tahun.",
            "Angka 7 adalah angka yang paling mungkin muncul saat Anda melempar dua dadu (peluang 1/6).",
            "Hukum Benford menyatakan bahwa dalam banyak kumpulan data di dunia nyata, angka 1 cenderung muncul sebagai digit pertama sekitar 30% dari waktu.",
            "Bilangan Armstrong (atau Narsisistik) adalah bilangan yang sama dengan jumlah digit-digitnya yang dipangkatkan dengan jumlah digit. Contoh: 153 = 1¬≥ + 5¬≥ + 3¬≥.",
            "Tidak ada satu pun bilangan prima yang berakhiran 5, kecuali angka 5 itu sendiri.",
            "Jumlah dari semua bilangan dari 1 hingga 100 (yaitu 1+2+...+100) adalah 5050.",
            "Teorema Terakhir Fermat, yang menyatakan tidak ada bilangan bulat positif a, b, dan c yang dapat memenuhi persamaan a‚Åø + b‚Åø = c‚Åø untuk n > 2, baru terbukti setelah 358 tahun.",
            "Persamaan Euler, e^(iœÄ) + 1 = 0, dianggap sebagai salah satu persamaan terindah karena menghubungkan lima konstanta matematika paling fundamental.",
            "Ada 'bilangan aneh' (weird numbers), yaitu bilangan yang berlimpah tetapi tidak semi-sempurna. Angka 70 adalah yang terkecil.",
            "Setiap bilangan bulat ganjil dapat ditulis sebagai selisih dari dua bilangan kuadrat sempurna.",
            "Bilangan 'sociable' adalah generalisasi dari bilangan akrab dan sempurna, di mana jumlah pembaginya membentuk siklus. Siklus terpanjang yang diketahui memiliki 28 anggota.",
            "Jumlah dari kebalikan semua bilangan kuadrat (1/1¬≤ + 1/2¬≤ + 1/3¬≤ + ...) secara mengejutkan konvergen ke œÄ¬≤/6.",
            "Meskipun ada tak terhingga bilangan prima, 'celah' di antara mereka bisa menjadi sangat besar secara acak.",
            "Angka 'googolplex' adalah 10 pangkat googol (10^10^100), sebuah angka yang begitu besar sehingga tidak mungkin untuk menuliskannya di alam semesta yang teramati.",
            "Bilangan Palindromik adalah bilangan yang dibaca sama dari depan maupun belakang, seperti 12321.",
            "Nol (0) adalah satu-satunya bilangan yang memiliki sifat aditif (x+0=x) dan multiplikatif (x*0=0).",
            "Angka 13 dianggap sial di banyak budaya (triskaidekaphobia) sebagian karena ada 13 orang pada Perjamuan Terakhir.",
            "Sistem bilangan Babilionia Kuno menggunakan basis 60, yang merupakan alasan kita memiliki 60 detik dalam satu menit dan 360 derajat dalam satu lingkaran.",

            // --- Fakta Geometri & Topologi ---
            "Bentuk penutup lubang got (manhole) biasanya bulat karena itu adalah satu-satunya bentuk yang tidak bisa jatuh ke dalam lubang itu sendiri dari sudut mana pun.",
            "Sebuah Pita M√∂bius adalah permukaan dengan hanya satu sisi dan satu tepi. Jika Anda berjalan di sepanjang permukaannya, Anda akan kembali ke titik awal di sisi yang 'berlawanan'.",
            "Teorema Empat Warna menyatakan bahwa Anda hanya memerlukan empat warna untuk mewarnai peta apa pun sehingga tidak ada dua wilayah yang berdekatan memiliki warna yang sama.",
            "Masalah Jembatan K√∂nigsberg adalah teka-teki terkenal yang melahirkan bidang matematika baru yang disebut Teori Graf.",
            "Fraktal adalah pola tak berujung yang kompleks dan berulang pada skala yang berbeda. Contohnya termasuk kepingan salju dan pakis.",
            "Botol Klein adalah objek 4-dimensi yang tidak memiliki 'dalam' atau 'luar' yang dapat dibedakan.",
            "Dalam geometri non-Euklides, jumlah sudut dalam sebuah segitiga bisa lebih atau kurang dari 180 derajat.",
            "Turunan dari rumus volume bola (4/3œÄr¬≥) terhadap jari-jarinya (r) adalah rumus luas permukaannya (4œÄr¬≤).",
            "Ada lebih banyak persimpangan dalam simpul tali sepatu Anda daripada yang Anda kira; studi tentang ini disebut Teori Simpul.",
            "Anda tidak dapat menyisir rambut di bola berbulu tanpa menciptakan setidaknya satu 'pusaran' (cowlick). Ini adalah ilustrasi dari Teorema Bola Berbulu.",
            "Bentuk heksagon adalah cara paling efisien untuk mengisi bidang datar dengan bentuk yang sama, itulah sebabnya sarang lebah berbentuk heksagon.",
            "Golden Ratio (sekitar 1.618) sering muncul di alam, seni, dan arsitektur, dari Parthenon hingga cangkang nautilus.",
            "Sebuah 'tesseract' adalah analogi empat dimensi dari sebuah kubus.",
            "Geometri fraktal digunakan untuk membuat grafis komputer yang realistis untuk pemandangan alam seperti pegunungan dan pantai.",
            "Lingkaran memiliki rasio keliling terhadap diameter yang konstan (œÄ), tetapi bentuk lain tidak.",
            "Luas segitiga dengan simpul pada koordinat bilangan bulat selalu merupakan kelipatan dari 1/2.",
            "Objek dengan dimensi fraktal dapat memiliki panjang tak terhingga dalam area yang terbatas.",
            "Pola Voronoi, yang membagi ruang menjadi wilayah berdasarkan kedekatan titik, ditemukan pada kulit jerapah dan sayap capung.",
            "Proyeksi stereografis memungkinkan pemetaan permukaan bola ke bidang datar, yang penting dalam kartografi dan matematika kompleks.",
            "Topologi sering disebut 'geometri lembaran karet' karena mempelajari sifat-sifat bentuk yang tidak berubah di bawah peregangan atau pembengkokan.",

            // --- Fakta Probabilitas & Logika ---
            "Paradoks Monty Hall menunjukkan bahwa pilihan intuitif dalam probabilitas seringkali salah. Peluang menang meningkat jika Anda mengubah pilihan Anda.",
            "Teorema Monyet Tak Terhingga menyatakan bahwa monyet yang mengetik secara acak di mesin tik untuk waktu tak terbatas pada akhirnya hampir pasti akan menghasilkan karya lengkap William Shakespeare.",
            "Paradoks Banach-Tarski secara kontroversial menyatakan bahwa sebuah bola dapat dipecah menjadi sejumlah bagian terbatas dan disusun kembali menjadi dua bola yang identik dengan aslinya.",
            "Teorema Ketidaklengkapan G√∂del menunjukkan bahwa dalam sistem matematika formal apa pun, akan selalu ada pernyataan yang benar tetapi tidak dapat dibuktikan dalam sistem itu sendiri.",
            "Hukum Bilangan Besar yang Sesungguhnya menyatakan bahwa dengan ukuran sampel yang cukup besar, hal-hal yang paling aneh dan tidak mungkin pun bisa terjadi.",
            "Dalam permainan 'Rock, Paper, Scissors', strategi terbaik secara matematis adalah bermain secara acak.",
            "Peluang Anda memenangkan lotre utama seringkali lebih rendah daripada peluang Anda tersambar petir dalam hidup Anda.",
            "Sebuah setumpuk 52 kartu memiliki 52! (52 faktorial) kemungkinan urutan, sebuah angka yang lebih besar dari jumlah atom di Bumi.",
            "Rantai Markov adalah model matematika yang menggambarkan urutan peristiwa di mana probabilitas setiap peristiwa hanya bergantung pada keadaan peristiwa sebelumnya.",
            "Paradoks Simpson terjadi ketika sebuah tren muncul dalam beberapa kelompok data yang berbeda tetapi menghilang atau berbalik ketika kelompok-kelompok ini digabungkan.",
            "Jika Anda mengocok setumpuk kartu dengan benar, kemungkinan besar urutan kartu yang Anda dapatkan belum pernah ada sebelumnya dalam sejarah dunia.",
            "Peluang dua orang di kelas dengan 30 siswa tidak memiliki hari ulang tahun yang sama sangatlah kecil, hanya sekitar 29%.",
            "Sebuah 'langkah acak' (random walk) adalah jalur yang terdiri dari serangkaian langkah acak, sebuah konsep kunci dalam fisika dan pasar saham.",
            "Masalah Penjatahan Sekretaris adalah teka-teki probabilitas untuk menemukan strategi optimal untuk memilih kandidat terbaik dari sekelompok pelamar.",
            "Meskipun kelihatannya berlawanan dengan intuisi, rata-rata jumlah teman dari teman Anda hampir selalu lebih besar dari jumlah teman Anda sendiri (Paradoks Persahabatan).",

            // --- Fakta Sejarah & Lain-lain ---
            "Tanda sama dengan (=) diciptakan oleh matematikawan Robert Recorde pada tahun 1557 karena ia 'bosan menulis 'is equal to' berulang kali'.",
            "Kata 'aljabar' berasal dari bahasa Arab 'al-jabr', yang berarti 'penyatuan kembali bagian-bagian yang rusak', dari judul buku matematikawan Persia, Al-Khwarizmi.",
            "Kata 'algoritma' adalah latinisasi dari nama Al-Khwarizmi.",
            "Sophie Germain adalah seorang matematikawan wanita yang menggunakan nama samaran pria, 'Monsieur Le Blanc', untuk dapat berpartisipasi dalam komunitas matematika yang didominasi pria.",
            "Simbol tak terhingga (‚àû) disebut 'lemniscate'.",
            "Kata 'calculus' berasal dari bahasa Latin untuk 'kerikil kecil', yang digunakan untuk menghitung pada zaman kuno.",
            "Pythagoras, yang terkenal dengan teoremanya, juga memimpin sebuah kultus yang memuja angka dan percaya bahwa makan kacang adalah dosa.",
            "Sistem penulisan angka Romawi tidak memiliki konsep angka nol.",
            "Ren√© Descartes konon mendapatkan ide untuk sistem koordinat Kartesius saat melihat seekor lalat merayap di langit-langit kamarnya.",
            "√âvariste Galois mengembangkan dasar-dasar teori grup dan teori Galois malam sebelum ia tewas dalam duel pada usia 20 tahun.",
            "Jari-jari kita dapat digunakan untuk sistem bilangan berbasis 10 (desimal), tetapi juga dapat digunakan untuk sistem berbasis 12 (duodesimal) dengan menggunakan ibu jari untuk menghitung ruas jari lainnya.",
            "Istilah 'hundred' berasal dari kata Norse kuno 'hundrath', yang sebenarnya berarti 120 (10 x 12).",
            "Matematika adalah satu-satunya 'sains' yang tidak memerlukan eksperimen untuk membuktikan kebenarannya; hanya logika dan pembuktian.",
            "Banyak arsitektur kuno, seperti Piramida Giza, dibangun dengan prinsip-prinsip matematika yang sangat canggih.",
            "Tanda plus (+) dan minus (-) pertama kali muncul dalam cetakan di Jerman pada akhir abad ke-15.",
            "Di Taiwan, angka 4 sering dihindari di gedung-gedung (seperti lantai 4) karena pengucapannya mirip dengan kata 'mati'.",
            "Dalam bahasa Inggris, 'forty' adalah satu-satunya angka yang hurufnya diurutkan secara alfabetis.",
            "Emmy Noether adalah seorang matematikawan revolusioner yang karyanya dalam aljabar abstrak menjadi dasar bagi banyak fisika modern.",
            "Sistem matriks dalam matematika dikembangkan secara luas oleh Arthur Cayley pada abad ke-19.",
            "John Napier, penemu logaritma, juga merancang berbagai 'tulang' (Napier's Bones) untuk mempermudah perkalian.",
            "Ada sekitar 1.771.47 cara berbeda untuk mengikat dasi, menurut ahli matematika Swedia.",
            "Jika sebuah pizza memiliki jari-jari 'z' dan ketebalan 'a', volumenya adalah Pi √ó z √ó z √ó a.",
            "Angka 1 diikuti oleh 100 angka nol disebut 'googol'.",
            "Notasi modern untuk œÄ baru digunakan secara luas setelah diperkenalkan oleh Leonhard Euler pada tahun 1737.",
            "Matematika sering disebut sebagai 'Ratu Ilmu Pengetahuan' oleh Carl Friedrich Gauss.",
            "Kata 'trigonometri' berasal dari bahasa Yunani yang berarti 'pengukuran segitiga'.",
            "Orang Babilonia memecahkan persamaan kuadrat lebih dari 3000 tahun yang lalu.",
            "Hypatia dari Alexandria adalah salah satu matematikawan wanita pertama yang tercatat dalam sejarah.",
            "Konsep fungsi (y = f(x)) merupakan perkembangan penting dalam sejarah matematika yang memungkinkan pemodelan hubungan antar variabel.",
            "Bilangan imajiner (i, akar kuadrat dari -1) awalnya dianggap 'tidak mungkin' tetapi sekarang sangat penting dalam bidang teknik dan fisika.",
            "Sistem desimal modern (basis 10) berasal dari sistem angka Hindu-Arab.",
            "Teori Permainan (Game Theory) adalah cabang matematika yang digunakan dalam ekonomi, ilmu politik, dan biologi untuk memodelkan pengambilan keputusan strategis.",
            "Dalam bahasa Prancis, angka 90 disebut 'quatre-vingt-dix' yang secara harfiah berarti 'empat-dua puluh-sepuluh' (4 x 20 + 10).",
            "Selembar kertas yang sangat besar secara teoretis bisa dilipat hingga ke bulan, jika Anda bisa melipatnya 42 kali.",
            "Ada lebih banyak cara untuk mengatur catur di papan daripada jumlah elektron di alam semesta yang teramati (Nomor Shannon)."
        ];

        // Elemen DOM
        const quizContainer = document.getElementById('quizContainer');
        const difficultyDisplay = document.getElementById('difficultyDisplay');
        const currentLevelDisplay = document.getElementById('currentLevel');
        const currentScoreDisplay = document.getElementById('currentScore');
        const questionText = document.getElementById('questionText');
        const answerInput = document.getElementById('answerInput');
        const answerOptions = document.getElementById('answerOptions');
        const submitBtn = document.getElementById('submitBtn');
        const hintBtn = document.getElementById('hintBtn');
        const hintModal = document.getElementById('hintModal');
        const hintText = document.getElementById('hintText');
        const closeHint = document.getElementById('closeHint');
        const resultModal = document.getElementById('resultModal');
        const resultIcon = document.getElementById('resultIcon');
        const resultTitle = document.getElementById('resultTitle');
        const resultMessage = document.getElementById('resultMessage');
        const homeBtn = document.getElementById('homeBtn');
        const nextBtn = document.getElementById('nextBtn');
        const statsContainer = document.getElementById('statsContainer');
        const timePerLevelDisplay = document.getElementById('timePerLevel');
        const failedAttemptsDisplay = document.getElementById('failedAttempts');
        const speedStatDisplay = document.getElementById('speedStat');
        const hintsUsedDisplay = document.getElementById('hintsUsed');
        const scratchPad = document.getElementById('scratchPad');
        const scratchTexture = document.getElementById('scratchTexture');
        const useOptionsToggle = document.getElementById('useOptionsToggle');
        const clearCanvasBtn = document.getElementById('clearCanvasBtn');
        const themeToggle = document.getElementById('themeToggle');
        const timerDisplay = document.getElementById('timer');
        const streakCount = document.getElementById('streakCount');
        const bestStreakDisplay = document.getElementById('bestStreak');
        const highestLevelDisplay = document.getElementById('highestLevel');
        const leaderboardBtn = document.getElementById('leaderboardBtn');
        const leaderboardModal = document.getElementById('leaderboardModal');
        const leaderboardBody = document.getElementById('leaderboardBody');
        const closeLeaderboard = document.getElementById('closeLeaderboard');
        const dailyChallengeBtn = document.getElementById('dailyChallengeBtn');
        const dailyChallengeModal = document.getElementById('dailyChallengeModal');
        const closeDailyChallenge = document.getElementById('closeDailyChallenge');
        const challengeProgress = document.getElementById('challengeProgress');
        const challengeProgressText = document.getElementById('challengeProgressText');
        const funFact = document.getElementById('funFact');
        const shareBtn = document.getElementById('shareBtn');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const gameModeSelector = document.getElementById('gameModeSelector');
        const coinCount = document.getElementById('coinCount');
        const totalCoinsDisplay = document.getElementById('totalCoins');
        const achievementCount = document.getElementById('achievementCount');
        const algebraProgress = document.getElementById('algebraProgress');
        const geometryProgress = document.getElementById('geometryProgress');
        const arithmeticProgress = document.getElementById('arithmeticProgress');
        const algebraPercent = document.getElementById('algebraPercent');
        const geometryPercent = document.getElementById('geometryPercent');
        const arithmeticPercent = document.getElementById('arithmeticPercent');
        const coinShopBtn = document.getElementById('coinShopBtn');
        const coinShopModal = document.getElementById('coinShopModal');
        const closeCoinShop = document.getElementById('closeCoinShop');
        const shopCoinCount = document.getElementById('shopCoinCount');
        const powerUpsContainer = document.getElementById('powerUpsContainer');
        const powerupsTab = document.getElementById('powerupsTab');
        const themesTab = document.getElementById('themesTab');
        const texturesTab = document.getElementById('texturesTab');
        const coinShopTabs = document.querySelectorAll('.coin-shop-tab');

        // Event Listeners
        document.querySelectorAll('.difficulty-btn').forEach(btn => {
            btn.addEventListener('click', startQuiz);
        });

        document.querySelectorAll('.game-mode-btn').forEach(btn => {
            btn.addEventListener('click', changeGameMode);
        });

        submitBtn.addEventListener('click', checkAnswer);
        hintBtn.addEventListener('click', showHint);
        closeHint.addEventListener('click', () => hintModal.classList.remove('show'));
        homeBtn.addEventListener('click', goHome);
        nextBtn.addEventListener('click', nextLevel);
        useOptionsToggle.addEventListener('change', toggleAnswerOptions);
        clearCanvasBtn.addEventListener('click', clearCanvas);
        themeToggle.addEventListener('click', toggleTheme);
        leaderboardBtn.addEventListener('click', showLeaderboard);
        closeLeaderboard.addEventListener('click', () => leaderboardModal.classList.remove('show'));
        dailyChallengeBtn.addEventListener('click', showDailyChallenge);
        closeDailyChallenge.addEventListener('click', () => dailyChallengeModal.classList.remove('show'));
        shareBtn.addEventListener('click', shareResults);
        darkModeToggle.addEventListener('change', toggleDarkMode);
        coinShopBtn.addEventListener('click', showCoinShop);
        closeCoinShop.addEventListener('click', () => coinShopModal.classList.remove('show'));
        
        coinShopTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                coinShopTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const tabId = tab.dataset.tab;
                document.querySelectorAll('.coin-shop-items').forEach(content => {
                    content.style.display = 'none';
                });
                document.getElementById(`${tabId}Tab`).style.display = 'grid';
            });
        });

        // Load saved data from localStorage
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('mathQuizData');
            if (savedData) {
                const data = JSON.parse(savedData);
                bestStreak = data.bestStreak || 0;
                highestLevel = data.highestLevel || 0;
                dailyChallengeProgress = data.dailyChallengeProgress || 0;
                dailyChallengeCompleted = data.dailyChallengeCompleted || false;
                darkMode = data.darkMode || false;
                coins = data.coins || 0;
                totalQuestionsAnswered = data.totalQuestionsAnswered || 0;
                algebraCorrect = data.algebraCorrect || 0;
                geometryCorrect = data.geometryCorrect || 0;
                arithmeticCorrect = data.arithmeticCorrect || 0;
                currentTheme = data.currentTheme || 'default';
                currentTexture = data.currentTexture || 'grid';
                ownedItems = data.ownedItems || {
                    powerups: {},
                    themes: { default: 1 },
                    textures: { grid: 1 }
                };
                
                achievements.forEach(ach => {
                    const savedAch = data.achievements?.find(a => a.id === ach.id);
                    if (savedAch) ach.earned = savedAch.earned;
                });
                
                if (darkMode) {
                    document.body.classList.add('dark-mode');
                    darkModeToggle.checked = true;
                }
                
                applyTheme(currentTheme);
                applyTexture(currentTexture);
            }
            
            updateStats();
            updateCoinDisplay();
            updateAchievementCount();
            updateSkillProgress();
            initCoinShop();
        }

        // Save data to localStorage
        function saveToLocalStorage() {
            const data = {
                bestStreak,
                highestLevel,
                dailyChallengeProgress,
                dailyChallengeCompleted,
                darkMode,
                coins,
                totalQuestionsAnswered,
                algebraCorrect,
                geometryCorrect,
                arithmeticCorrect,
                currentTheme,
                currentTexture,
                ownedItems,
                achievements: achievements.filter(a => a.earned)
            };
            localStorage.setItem('mathQuizData', JSON.stringify(data));
        }

        // Initialize coin shop
        function initCoinShop() {
            // Add power-ups to shop
            powerupsTab.innerHTML = '';
            powerUps.forEach(powerup => {
                const owned = ownedItems.powerups[powerup.id] || 0;
                const canAfford = coins >= powerup.price;
                
                const item = document.createElement('div');
                item.className = `coin-shop-item ${canAfford ? '' : 'coin-shop-item-disabled'}`;
                item.innerHTML = `
                    <div class="coin-shop-item-icon">${powerup.icon}</div>
                    <div class="coin-shop-item-name">${powerup.name}</div>
                    <div class="coin-shop-item-price">${powerup.price} ü™ô</div>
                    <small>${powerup.description}</small>
                    ${owned > 0 ? `<div class="coin-shop-item-owned">${owned}</div>` : ''}
                `;
                
                if (canAfford) {
                    item.addEventListener('click', () => purchaseItem('powerups', powerup));
                }
                
                powerupsTab.appendChild(item);
            });
            
            // Add themes to shop
            themesTab.innerHTML = '';
            themes.forEach(theme => {
                const owned = ownedItems.themes[theme.id] || 0;
                const canAfford = coins >= theme.price || theme.price === 0;
                const isCurrent = currentTheme === theme.id;
                
                const item = document.createElement('div');
                item.className = `coin-shop-item ${canAfford ? '' : 'coin-shop-item-disabled'} ${isCurrent ? 'active' : ''}`;
                item.innerHTML = `
                    <div class="coin-shop-item-icon">${theme.icon}</div>
                    <div class="coin-shop-item-name">${theme.name}</div>
                    <div class="coin-shop-item-price">${theme.price} ü™ô</div>
                    <small>${theme.description}</small>
                    <div class="theme-preview" style="background: linear-gradient(to right, ${theme.colors.primary}, ${theme.colors.secondary});"></div>
                    ${owned > 0 ? `<div class="coin-shop-item-owned">${owned}</div>` : ''}
                    ${isCurrent ? '<div class="coin-shop-item-owned">‚úì</div>' : ''}
                `;
                
                if (canAfford) {
                    item.addEventListener('click', () => purchaseItem('themes', theme));
                }
                
                themesTab.appendChild(item);
            });
            
            // Add textures to shop
            texturesTab.innerHTML = '';
            textures.forEach(texture => {
                const owned = ownedItems.textures[texture.id] || 0;
                const canAfford = coins >= texture.price || texture.price === 0;
                const isCurrent = currentTexture === texture.id;
                
                const item = document.createElement('div');
                item.className = `coin-shop-item ${canAfford ? '' : 'coin-shop-item-disabled'} ${isCurrent ? 'active' : ''}`;
                item.innerHTML = `
                    <div class="coin-shop-item-icon">${texture.icon}</div>
                    <div class="coin-shop-item-name">${texture.name}</div>
                    <div class="coin-shop-item-price">${texture.price} ü™ô</div>
                    <small>${texture.description}</small>
                    ${owned > 0 ? `<div class="coin-shop-item-owned">${owned}</div>` : ''}
                    ${isCurrent ? '<div class="coin-shop-item-owned">‚úì</div>' : ''}
                `;
                
                if (canAfford) {
                    item.addEventListener('click', () => purchaseItem('textures', texture));
                }
                
                texturesTab.appendChild(item);
            });
            
            shopCoinCount.textContent = coins;
        }

        // Purchase item from coin shop
        function purchaseItem(category, item) {
            if (coins < item.price) return;
            
            coins -= item.price;
            ownedItems[category][item.id] = (ownedItems[category][item.id] || 0) + 1;
            
            if (category === 'themes') {
                currentTheme = item.id;
                applyTheme(item.id);
            } else if (category === 'textures') {
                currentTexture = item.id;
                applyTexture(item.id);
            } else if (category === 'powerups') {
                addPowerUp(item.id);
            }
            
            updateCoinDisplay();
            saveToLocalStorage();
            initCoinShop();
            
            // Show purchase confirmation
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `<h3>Pembelian Berhasil!</h3><p>Anda mendapatkan ${item.name}</p>`;
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 2000);
        }

        // Apply selected theme
        function applyTheme(themeId) {
            const theme = themes.find(t => t.id === themeId);
            if (!theme) return;
            
            document.documentElement.style.setProperty('--primary', theme.colors.primary);
            document.documentElement.style.setProperty('--secondary', theme.colors.secondary);
            document.documentElement.style.setProperty('--accent', theme.colors.accent);
        }

        // Apply selected texture
        function applyTexture(textureId) {
            const texture = textures.find(t => t.id === textureId);
            if (!texture) return;
            
            scratchTexture.className = 'scratch-texture ' + texture.class;
        }

        // Add power-up to active power-ups
        function addPowerUp(powerupId) {
            const powerup = powerUps.find(p => p.id === powerupId);
            if (!powerup) return;
            
            // Initialize if not already owned
            if (!ownedItems.powerups[powerupId]) {
                ownedItems.powerups[powerupId] = {
                    count: powerup.uses,
                    max: powerup.uses
                };
            } else {
                ownedItems.powerups[powerupId].count = Math.min(
                    ownedItems.powerups[powerupId].count + powerup.uses,
                    ownedItems.powerups[powerupId].max
                );
            }
            
            updatePowerUps();
        }

        // Update power-ups display
        function updatePowerUps() {
            powerUpsContainer.innerHTML = '';
            
            Object.keys(ownedItems.powerups).forEach(powerupId => {
                const powerup = powerUps.find(p => p.id === powerupId);
                if (!powerup) return;
                
                const powerupData = ownedItems.powerups[powerupId];
                if (powerupData.count <= 0) return;
                
                const btn = document.createElement('button');
                btn.className = 'power-up-btn';
                btn.innerHTML = `${powerup.icon} ${powerup.name} (${powerupData.count})`;
                btn.title = powerup.description;
                btn.addEventListener('click', () => usePowerUp(powerupId));
                
                powerUpsContainer.appendChild(btn);
            });
        }

        // Use power-up
        function usePowerUp(powerupId) {
            const powerup = powerUps.find(p => p.id === powerupId);
            if (!powerup || !ownedItems.powerups[powerupId] || ownedItems.powerups[powerupId].count <= 0) return;
            
            ownedItems.powerups[powerupId].count--;
            
            switch(powerupId) {
                case 'removeTwo':
                    removeTwoOptions();
                    break;
                case 'showAnswer':
                    showAnswer();
                    break;
                case 'timeFreeze':
                    timeFreeze();
                    break;
                case 'doublePoints':
                    activateDoublePoints();
                    break;
            }
            
            updatePowerUps();
            saveToLocalStorage();
        }

        // Remove two incorrect options
        function removeTwoOptions() {
            if (!useOptions || !currentQuestion.options) return;
            
            const correctAnswer = currentQuestion.answer.toString();
            const incorrectOptions = Array.from(document.querySelectorAll('.option-btn'))
                .filter(btn => btn.dataset.value !== correctAnswer);
            
            if (incorrectOptions.length <= 2) return;
            
            // Shuffle and pick 2 to remove
            const shuffled = [...incorrectOptions].sort(() => 0.5 - Math.random());
            const toRemove = shuffled.slice(0, 2);
            
            toRemove.forEach(btn => {
                btn.style.opacity = '0.3';
                btn.style.pointerEvents = 'none';
            });
            
            // Show message
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = '<h3>Power-up Digunakan!</h3><p>2 opsi salah telah dihilangkan</p>';
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 2000);
        }

        // Show correct answer
        function showAnswer() {
            const correctAnswer = currentQuestion.answer.toString();
            
            if (useOptions && currentQuestion.options) {
                const correctBtn = Array.from(document.querySelectorAll('.option-btn'))
                    .find(btn => btn.dataset.value === correctAnswer);
                
                if (correctBtn) {
                    correctBtn.style.borderColor = 'var(--success)';
                    correctBtn.style.backgroundColor = darkMode ? '#1a3a1a' : '#e6f7e6';
                }
            } else {
                answerInput.value = correctAnswer;
            }
            
            // Show message
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = '<h3>Power-up Digunakan!</h3><p>Jawaban yang benar ditunjukkan</p>';
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 2000);
        }

        // Freeze timer for 10 seconds
        function timeFreeze() {
            if (!timerInterval) return;
            
            clearInterval(timerInterval);
            
            // Show message
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = '<h3>Power-up Digunakan!</h3><p>Waktu dibekukan selama 10 detik</p>';
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 2000);
            
            // Resume timer after 10 seconds
            setTimeout(() => {
                startTimer();
            }, 10000);
        }

        // Activate double points for next correct answer
        function activateDoublePoints() {
            activePowerUps.push('doublePoints');
            
            // Show message
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = '<h3>Power-up Digunakan!</h3><p>Poin ganda aktif untuk jawaban berikutnya</p>';
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 2000);
        }

        // Show coin shop
        function showCoinShop() {
            shopCoinCount.textContent = coins;
            coinShopModal.classList.add('show');
        }

        // Initialize
        loadFromLocalStorage();
        showRandomMathFact();

        function showRandomMathFact() {
            const randomFact = mathFacts[Math.floor(Math.random() * mathFacts.length)];
            const factElement = document.getElementById('funFact');
            
            factElement.style.opacity = '0';
            factElement.style.transition = 'opacity 0.5s ease';
            
            setTimeout(() => {
                factElement.innerHTML = `<div class="fun-fact-content"><strong>Fakta Menarik:</strong> ${randomFact}</div>`;
                factElement.style.opacity = '1';
            }, 500);
            
            // Change fact every 3 seconds
            if (factInterval) clearInterval(factInterval);
            factInterval = setInterval(showRandomMathFact, 3000);
        }

        function clearCanvas() {
            if (ctx && canvas) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }
        
        function initCanvas() {
            scratchPad.innerHTML = '';
            canvas = document.createElement('canvas');
            canvas.width = scratchPad.offsetWidth;
            canvas.height = scratchPad.offsetHeight;
            scratchPad.appendChild(canvas);
            
            const textureDiv = document.createElement('div');
            textureDiv.className = 'scratch-texture ' + (textures.find(t => t.id === currentTexture)?.class || '');
            scratchPad.appendChild(textureDiv);
            
            ctx = canvas.getContext('2d');
            ctx.strokeStyle = darkMode ? 'var(--dark-text)' : 'var(--text)';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd);
            
            function startDrawing(e) {
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function draw(e) {
                if (!isDrawing) return;
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function stopDrawing() {
                isDrawing = false;
            }

            function getTouchPos(canvasDom, touchEvent) {
                const rect = canvasDom.getBoundingClientRect();
                return {
                    x: touchEvent.touches[0].clientX - rect.left,
                    y: touchEvent.touches[0].clientY - rect.top
                };
            }
            
            function handleTouchStart(e) {
                e.preventDefault();
                const touchPos = getTouchPos(canvas, e);
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touchPos.x,
                    clientY: touchPos.y
                });
                canvas.dispatchEvent(mouseEvent);
            }
            
            function handleTouchMove(e) {
                e.preventDefault();
                const touchPos = getTouchPos(canvas, e);
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touchPos.x,
                    clientY: touchPos.y
                });
                canvas.dispatchEvent(mouseEvent);
            }
            
            function handleTouchEnd(e) {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup', {});
                canvas.dispatchEvent(mouseEvent);
            }
        }

        function changeGameMode(e) {
            gameMode = e.target.dataset.mode;
            
            document.querySelectorAll('.game-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            e.target.classList.add('active');
            
            if (quizContainer.style.display === 'block') {
                startQuiz({ target: { dataset: { difficulty: currentDifficulty } } });
            }
        }

        function startQuiz(e) {
            currentDifficulty = e.target.dataset.difficulty;
            currentLevel = 1;
            currentScore = 0;
            hintsUsed = 0;
            failedAttempts = 0;
            levelTimes = [];
            currentStreak = 0;
            speedRunTime = 0;
            activePowerUps = [];
            
            switch(currentDifficulty) {
                case 'easy':
                    difficultyDisplay.textContent = 'Mudah';
                    break;
                case 'medium':
                    difficultyDisplay.textContent = 'Menengah';
                    break;
                case 'hard':
                    difficultyDisplay.textContent = 'Sulit';
                    break;
                case 'extreme':
                    difficultyDisplay.textContent = 'Ekstrem';
                    break;
            }
            
            quizContainer.style.display = 'block';
            statsContainer.style.display = 'block';
            
            initCanvas();
            startTimer();
            startLevel();
            
            if (gameMode === 'speedrun') {
                clearInterval(speedRunInterval);
                speedRunTime = 0;
                speedRunInterval = setInterval(() => {
                    speedRunTime++;
                }, 1000);
            }
            
            updatePowerUps();
        }

        function startTimer() {
            let seconds = 0;
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                seconds++;
                timerDisplay.textContent = seconds;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            if (speedRunInterval) clearInterval(speedRunInterval);
        }

        function startLevel() {
            clearCanvas();
            
            currentLevelDisplay.textContent = currentLevel;
            animateCount(currentScoreDisplay, currentScore);
            streakCount.textContent = currentStreak;
            answerInput.value = '';
            answerInput.className = 'answer-field';
            
            currentQuestion = generateQuestion(currentDifficulty, currentLevel);
            questionText.textContent = currentQuestion.question;
            
            if (useOptions) {
                answerInput.style.display = 'none';
                answerOptions.style.display = 'grid';
                
                answerOptions.innerHTML = '';
                
                currentQuestion.options.forEach((option, index) => {
                    const optionBtn = document.createElement('button');
                    optionBtn.className = 'option-btn';
                    optionBtn.textContent = option;
                    optionBtn.dataset.value = option;
                    optionBtn.addEventListener('click', selectOption);
                    answerOptions.appendChild(optionBtn);
                });
            } else {
                answerInput.style.display = 'block';
                answerOptions.style.display = 'none';
            }
            
            levelStartTime = Date.now();
            updateStats();
        }

        function selectOption(e) {
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.style.borderColor = '#ddd';
                btn.style.backgroundColor = darkMode ? '#16213e' : 'white';
            });
            
            e.target.style.borderColor = 'var(--primary)';
            e.target.style.backgroundColor = darkMode ? '#1a1a2e' : 'var(--secondary)';
            
            answerInput.value = e.target.dataset.value;
        }

        function toggleAnswerOptions() {
            useOptions = useOptionsToggle.checked;
            
            if (quizContainer.style.display === 'block') {
                startLevel();
            }
        }

        function toggleTheme() {
            darkMode = !darkMode;
            document.body.classList.toggle('dark-mode');
            darkModeToggle.checked = darkMode;
            if (ctx) {
                ctx.strokeStyle = darkMode ? 'var(--dark-text)' : 'var(--text)';
            }
            saveToLocalStorage();
        }

        function toggleDarkMode() {
            darkMode = darkModeToggle.checked;
            document.body.classList.toggle('dark-mode', darkMode);
            if (ctx) {
                ctx.strokeStyle = darkMode ? 'var(--dark-text)' : 'var(--text)';
            }
            saveToLocalStorage();
        }

        function checkAnswer() {
            const userAnswer = answerInput.value.trim();
            
            if (!userAnswer) {
                answerInput.style.borderColor = 'var(--accent)';
                return;
            }
            
            const timeSpent = Math.floor((Date.now() - levelStartTime) / 1000);
            levelTimes.push(timeSpent);
            
            let isCorrect = false;

            if (!isNaN(userAnswer) && typeof currentQuestion.answer === 'number') {
                 isCorrect = Math.abs(parseFloat(userAnswer) - currentQuestion.answer) < 0.01;
            } else {
                 isCorrect = userAnswer.toLowerCase() === currentQuestion.answer.toString().toLowerCase();
            }
            
            // Visual feedback
            if (isCorrect) {
                answerInput.classList.add('correct');
            } else {
                answerInput.classList.add('incorrect');
            }
            
            setTimeout(() => showResult(isCorrect, timeSpent), 500);
        }

        function showResult(isCorrect, timeSpent) {
            totalQuestionsAnswered++;
            let message = '';

            if (isCorrect) {
                if (currentQuestion.category === 'algebra') algebraCorrect++;
                else if (currentQuestion.category === 'geometry') geometryCorrect++;
                else if (currentQuestion.category === 'arithmetic') arithmeticCorrect++;
                
                resultIcon.className = 'result-icon correct';
                resultIcon.textContent = '‚úì';
                resultTitle.textContent = 'Jawaban Benar!';
                
                let maxPoints = 10;
                if (currentDifficulty === 'medium') maxPoints = 15;
                else if (currentDifficulty === 'hard') maxPoints = 20;
                else if (currentDifficulty === 'extreme') maxPoints = 25;
                
                maxPoints += Math.floor(currentLevel / 4);
                const timePenalty = Math.floor(timeSpent / 4);
                let pointsEarned = Math.max(1, maxPoints - timePenalty);
                
                // Apply double points if active
                if (activePowerUps.includes('doublePoints')) {
                    pointsEarned *= 2;
                    activePowerUps = activePowerUps.filter(p => p !== 'doublePoints');
                }
                
                message = `Poin dasar: ${maxPoints}<br>Pengurangan waktu: -${timePenalty}`;

                if (currentStreak > 0 && currentStreak % 3 === 0) {
                    const streakBonus = Math.floor(currentStreak / 3) * 5;
                    pointsEarned += streakBonus;
                    message += `<br>Bonus streak: +${streakBonus}`;
                }
                
                if (gameMode === 'speedrun' && timeSpent < 10) {
                    const speedBonus = Math.floor((10 - timeSpent) * 2);
                    pointsEarned += speedBonus;
                    message += `<br>Bonus speed run: +${speedBonus}`;
                }

                message += `<br><b>Poin diperoleh: ${pointsEarned}</b>`;
                
                currentScore += pointsEarned;
                currentStreak++;
                if (currentStreak > bestStreak) {
                    bestStreak = currentStreak;
                }
                
                const coinsEarned = Math.floor(pointsEarned / 2);
                coins += coinsEarned;
                message += `<br><br>ü™ô Koin diperoleh: +${coinsEarned}`;
                animateCount(coinCount, coins);
                animateCount(totalCoinsDisplay, coins);
                
                if (currentQuestion.isDailyChallenge) {
                    dailyChallengeProgress++;
                    if (dailyChallengeProgress >= 5 && !dailyChallengeCompleted) {
                        dailyChallengeCompleted = true;
                        currentScore += 50;
                        coins += 25;
                        message += `<br><br>üéâ Anda menyelesaikan Tantangan Harian! +50 poin dan 25 koin bonus!`;
                        animateCount(coinCount, coins);
                        animateCount(totalCoinsDisplay, coins);
                    }
                    saveToLocalStorage();
                }

                checkAchievements(isCorrect, timeSpent);

            } else {
                resultIcon.className = 'result-icon incorrect';
                resultIcon.textContent = '‚úó';
                resultTitle.textContent = 'Jawaban Salah!';
                
                message = `Jawaban yang benar adalah: <b>${currentQuestion.answer}</b>`;
                
                currentScore = Math.max(0, currentScore - 5);
                failedAttempts++;
                currentStreak = 0;
            }

            // Tambahkan pembahasan ke pesan, baik untuk jawaban benar maupun salah
            if (currentQuestion.explanation) {
                message += `<br><br><div style="text-align: left; border-top: 1px solid #ccc; padding-top: 10px; margin-top: 10px;"><b>Pembahasan:</b><br>${currentQuestion.explanation}</div>`;
            }

            resultMessage.innerHTML = message;
            
            if (currentLevel > highestLevel) {
                highestLevel = currentLevel;
            }
            
            animateCount(currentScoreDisplay, currentScore);
            streakCount.textContent = currentStreak;
            updateStats();
            saveToLocalStorage();
            resultModal.classList.add('show');
            stopTimer();
        }

        function animateCount(element, targetValue) {
            const current = parseInt(element.textContent) || 0;
            const duration = 500; // ms
            const startTime = performance.now();
            
            function updateCount(timestamp) {
                const elapsed = timestamp - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const value = Math.floor(current + (targetValue - current) * progress);
                
                element.textContent = value;
                element.classList.add('animate');
                
                if (progress < 1) {
                    requestAnimationFrame(updateCount);
                } else {
                    setTimeout(() => {
                        element.classList.remove('animate');
                    }, 300);
                }
            }
            
            requestAnimationFrame(updateCount);
        }

        function updateCoinDisplay() {
            coinCount.textContent = coins;
            totalCoinsDisplay.textContent = coins;
            if (shopCoinCount) shopCoinCount.textContent = coins;
        }

        function updateAchievementCount() {
            const earned = achievements.filter(a => a.earned).length;
            achievementCount.textContent = `${earned}/${achievements.length}`;
        }

        function updateSkillProgress() {
            const algebraTotal = totalQuestionsAnswered > 0 ? Math.round((algebraCorrect / totalQuestionsAnswered) * 100) : 0;
            const geometryTotal = totalQuestionsAnswered > 0 ? Math.round((geometryCorrect / totalQuestionsAnswered) * 100) : 0;
            const arithmeticTotal = totalQuestionsAnswered > 0 ? Math.round((arithmeticCorrect / totalQuestionsAnswered) * 100) : 0;
            
            algebraProgress.style.width = `${algebraTotal}%`;
            geometryProgress.style.width = `${geometryTotal}%`;
            arithmeticProgress.style.width = `${arithmeticTotal}%`;
            
            algebraPercent.textContent = `${algebraTotal}%`;
            geometryPercent.textContent = `${geometryTotal}%`;
            arithmeticPercent.textContent = `${arithmeticTotal}%`;
        }

        function checkAchievements(isCorrect, timeSpent) {
            if (currentLevel >= 5 && !achievements[0].earned) {
                achievements[0].earned = true;
                coins += achievements[0].reward;
                showAchievement(0);
            }
            
            if (currentStreak >= 10 && !achievements[1].earned) {
                achievements[1].earned = true;
                coins += achievements[1].reward;
                showAchievement(1);
            }
            
            if (currentQuestion.category === 'algebra' && algebraCorrect >= 5 && !achievements[2].earned) {
                achievements[2].earned = true;
                coins += achievements[2].reward;
                showAchievement(2);
            }
            
            if (gameMode === 'speedrun' && timeSpent < 30 && !achievements[3].earned) {
                achievements[3].earned = true;
                coins += achievements[3].reward;
                showAchievement(3);
            }
            
            if (coins >= 100 && !achievements[5].earned) {
                achievements[5].earned = true;
                coins += achievements[5].reward;
                showAchievement(5);
            }
            
            if (currentLevel >= 20 && !achievements[6].earned) {
                achievements[6].earned = true;
                coins += achievements[6].reward;
                showAchievement(6);
            }
            
            if (hintsUsed === 0 && !achievements[7].earned) {
                achievements[7].earned = true;
                coins += achievements[7].reward;
                showAchievement(7);
            }
            
            updateCoinDisplay();
            updateAchievementCount();
            saveToLocalStorage();
        }

        function showAchievement(index) {
            const achievement = achievements[index];
            const achievementHtml = `
                <div class="achievement-popup">
                    <h3>Achievement Unlocked!</h3>
                    <p>${achievement.name}</p>
                    <small>${achievement.desc}</small>
                    <small>+${achievement.reward} koin</small>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', achievementHtml);
            setTimeout(() => {
                document.querySelector('.achievement-popup').remove();
            }, 3000);
        }

        function showHint() {
            hintText.textContent = currentQuestion.hint;
            hintModal.classList.add('show');
            
            closeHint.onclick = function() {
                hintModal.classList.remove('show');
                
                if (!currentQuestion.hintUsed) {
                    currentScore = Math.max(0, currentScore - 5);
                    animateCount(currentScoreDisplay, currentScore);
                    hintsUsed++;
                    updateStats();
                    currentQuestion.hintUsed = true;
                }
            };
        }

        function nextLevel() {
            resultModal.classList.remove('show');
            
            if (currentLevel < 20) {
                currentLevel++;
                startLevel();
                startTimer();
                
                if (gameMode === 'speedrun') {
                    speedRunInterval = setInterval(() => {
                        speedRunTime++;
                    }, 1000);
                }
            } else {
                quizCompleted();
            }
        }

        function quizCompleted() {
            resultTitle.textContent = 'Kuis Selesai!';
            resultMessage.textContent = `Total poin Anda: ${currentScore}`;
            nextBtn.style.display = 'none';
            resultModal.classList.add('show');
            
            leaderboardData[0].score = currentScore;
            leaderboardData[0].level = currentLevel;
            leaderboardData[0].coins = coins;
            saveToLocalStorage();
        }

        function goHome() {
            resultModal.classList.remove('show');
            quizContainer.style.display = 'none';
            statsContainer.style.display = 'none';
            stopTimer();
        }

        function updateStats() {
            if (levelTimes.length > 0) {
                const lastLevelTime = levelTimes[levelTimes.length - 1];
                timePerLevelDisplay.textContent = `${lastLevelTime} detik`;
            }
            
            failedAttemptsDisplay.textContent = failedAttempts;
            
            hintsUsedDisplay.textContent = hintsUsed;
            
            bestStreakDisplay.textContent = bestStreak;
            highestLevelDisplay.textContent = highestLevel;
            
            if (levelTimes.length > 0) {
                const avgTime = Math.round(levelTimes.reduce((a, b) => a + b, 0) / levelTimes.length);
                speedStatDisplay.textContent = `${avgTime} detik/level`;
            } else {
                 speedStatDisplay.textContent = `-`;
            }
        }

        function showLeaderboard() {
            const sortedLeaderboard = [...leaderboardData].sort((a, b) => b.score - a.score);
            
            leaderboardBody.innerHTML = '';
            
            sortedLeaderboard.forEach((user, index) => {
                const row = document.createElement('tr');
                if (user.name === "Anda") {
                    row.classList.add('user-rank');
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.name}</td>
                    <td>${user.score}</td>
                    <td>${user.level}</td>
                    <td>${user.coins}</td>
                `;
                
                leaderboardBody.appendChild(row);
            });
            
            leaderboardModal.classList.add('show');
        }

        function showDailyChallenge() {
            challengeProgress.style.width = `${(dailyChallengeProgress / 5) * 100}%`;
            challengeProgressText.textContent = dailyChallengeProgress;
            dailyChallengeModal.classList.add('show');
        }

        function shareResults() {
            const shareText = `Saya baru saja mencoba Matematika Kuis dan mendapatkan ${currentScore} poin di level ${currentLevel} (${currentDifficulty})! Coba tantang saya di sini!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Hasil Matematika Kuis',
                    text: shareText,
                    url: window.location.href
                }).catch(err => {
                    console.log('Error sharing:', err);
                    fallbackShare(shareText);
                });
            } else {
                fallbackShare(shareText);
            }
        }

        function fallbackShare(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Teks hasil telah disalin ke clipboard! Anda bisa membagikannya di media sosial.');
            }).catch(err => {
                console.error('Could not copy text: ', err);
                prompt('Salin teks berikut untuk membagikan hasil Anda:', text);
            });
        }

        // --- SISTEM PEMBUATAN SOAL BARU ---

        const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const getGcd = (a, b) => b === 0 ? a : getGcd(b, a % b);
        const getLcm = (a, b) => (a * b) / getGcd(a, b);
        
        function getPrimeFactorization(num) {
            const factors = {};
            let divisor = 2;
            while (num >= 2) {
                if (num % divisor === 0) {
                    factors[divisor] = (factors[divisor] || 0) + 1;
                    num /= divisor;
                } else {
                    divisor++;
                }
            }
            return Object.entries(factors).map(([base, exp]) => exp > 1 ? `${base}^${exp}` : `${base}`).join(' √ó ');
        }

        const easyQuestions = [
            () => ({ question: `Berapakah hasil dari ${randInt(10, 50)} + ${randInt(10, 50)}?`, answer: (a, b) => a + b, hint: "Jumlahkan kedua angka tersebut.", category: 'arithmetic', explanation: (q, a) => `Penjumlahan sederhana: ${q.split(' ')[4]} + ${q.split(' ')[6].replace('?','')} = ${a}. Anda cukup menambahkan kedua bilangan tersebut.` }),
            () => { const a = randInt(5, 15), b = randInt(2, 9); return { question: `Berapakah hasil dari ${a} √ó ${b}?`, answer: a * b, hint: "Kalikan kedua angka tersebut.", category: 'arithmetic', explanation: `Perkalian dasar: ${a} √ó ${b} = ${a * b}. Anda bisa menjumlahkan ${a} sebanyak ${b} kali.` }; },
            () => ({ question: `Berapakah hasil dari 1/2 + 1/4? (jawaban dalam desimal)`, answer: 0.75, hint: "Samakan penyebutnya terlebih dahulu.", category: 'arithmetic', explanation: `Untuk menjumlahkan pecahan, samakan penyebutnya. 1/2 = 2/4, jadi 2/4 + 1/4 = 3/4, yang sama dengan 0.75.` }),
            () => { const numbers = [randInt(1, 5) * 2, randInt(1, 5) * 2 + 1, randInt(6, 10) * 2 + 1]; const answer = numbers[0]; return { question: `Manakah bilangan genap dari: ${shuffleArray(numbers).join(', ')}?`, answer, hint: "Bilangan genap adalah bilangan yang habis dibagi 2.", category: 'arithmetic', explanation: `Bilangan genap adalah bilangan yang bisa dibagi 2 tanpa sisa. Dari pilihan yang ada, hanya ${answer} yang merupakan bilangan genap.` }; },
            () => { const sisi = randInt(4, 10); return { question: `Sebuah persegi memiliki sisi ${sisi} cm. Berapakah kelilingnya (cm)?`, answer: 4 * sisi, hint: "Keliling persegi adalah 4 kali panjang sisinya.", category: 'geometry', explanation: `Rumus keliling persegi adalah 4 √ó sisi. Dengan sisi ${sisi} cm, kelilingnya adalah 4 √ó ${sisi} = ${4 * sisi} cm.` }; },
            () => { const a = randInt(10, 20), b = randInt(5, 15); return { question: `Budi memiliki ${a} permen dan memberikan ${b} permen kepada adiknya. Berapa permen yang tersisa?`, answer: a - b, hint: "Kurangi jumlah permen yang diberikan dari total.", category: 'arithmetic', explanation: `Total permen awal adalah ${a}, setelah diberikan ${b}, sisa permen adalah ${a} - ${b} = ${a - b}.` }; },
            () => { const price = randInt(5, 10) * 1000, quantity = randInt(2, 5); return { question: `Harga satu buku adalah Rp${price.toLocaleString('id-ID')}. Jika Andi membeli ${quantity} buku, berapa total yang harus dibayar?`, answer: price * quantity, hint: "Kalikan harga per buku dengan jumlah buku.", category: 'arithmetic', explanation: `Total harga = harga per buku √ó jumlah buku = Rp${price.toLocaleString('id-ID')} √ó ${quantity} = Rp${(price * quantity).toLocaleString('id-ID')}.` }; }
        ];
        const mediumQuestions = [
            () => { const a = randInt(5, 15), b = randInt(2, 5), c = randInt(3, 10); return { question: `Berapakah hasil dari ${a} + ${b} √ó ${c}?`, answer: a + b * c, hint: "Kerjakan perkalian terlebih dahulu (aturan BODMAS/PEMDAS).", category: 'arithmetic', explanation: `Menurut aturan operasi matematika, perkalian dikerjakan sebelum penjumlahan. Jadi, ${b} √ó ${c} = ${b * c}, lalu ${a} + ${b * c} = ${a + b * c}.` }; },
            () => { const a = randInt(20, 50), b = randInt(100, 200); return { question: `${a}% dari ${b} adalah?`, answer: (a / 100) * b, hint: "Ubah persentase menjadi desimal (bagi 100), lalu kalikan.", category: 'arithmetic', explanation: `Untuk menghitung persentase, ubah % menjadi desimal (${a}% = ${a/100}) lalu kalikan dengan bilangan: ${a/100} √ó ${b} = ${(a/100)*b}.` }; },
            () => { const x = randInt(2, 10), b = randInt(5, 15); const c = x + b; return { question: `Jika x + ${b} = ${c}, berapakah nilai x?`, answer: x, hint: "Pindahkan angka ke sisi lain untuk menemukan nilai x.", category: 'algebra', explanation: `Untuk mencari x, kurangi kedua sisi dengan ${b}: x + ${b} - ${b} = ${c} - ${b}, sehingga x = ${x}.` }; },
            () => ({ question: `Sudut yang besarnya kurang dari 90 derajat disebut sudut...?`, answer: "lancip", hint: "Lawan dari sudut tumpul.", category: 'geometry', explanation: `Sudut diklasifikasikan berdasarkan besarnya: lancip (<90¬∞), siku-siku (90¬∞), tumpul (>90¬∞), dan lurus (180¬∞).` }),
            () => { const base = randInt(5, 10), height = randInt(5, 10); return { question: `Sebuah segitiga memiliki alas ${base} cm dan tinggi ${height} cm. Berapakah luasnya? (cm¬≤)`, answer: (base * height) / 2, hint: "Rumus luas segitiga adalah (alas √ó tinggi) / 2.", category: 'geometry', explanation: `Luas segitiga = (alas √ó tinggi) / 2 = (${base} √ó ${height}) / 2 = ${(base * height) / 2} cm¬≤.` }; },
            () => { const a = randInt(2, 5), b = randInt(2, 5); return { question: `FPB dari ${a} dan ${b} adalah?`, answer: getGcd(a, b), hint: "Cari bilangan terbesar yang dapat membagi kedua angka.", category: 'arithmetic', explanation: `Faktor Persekutuan Terbesar (FPB) dari ${a} dan ${b} adalah ${getGcd(a, b)}.` }; },
            () => { const a = randInt(2, 5), b = randInt(2, 5); return { question: `KPK dari ${a} dan ${b} adalah?`, answer: getLcm(a, b), hint: "Cari bilangan terkecil yang dapat dibagi oleh kedua angka.", category: 'arithmetic', explanation: `Kelipatan Persekutuan Terkecil (KPK) dari ${a} dan ${b} adalah ${getLcm(a, b)}.` }; },
            () => { const num = randInt(10, 30); return { question: `Faktorisasi prima dari ${num} adalah?`, answer: getPrimeFactorization(num), hint: "Bagi bilangan dengan bilangan prima terkecil hingga hasilnya 1.", category: 'arithmetic', explanation: `Faktorisasi prima dari ${num} adalah ${getPrimeFactorization(num)}.` }; }
        ];
        const hardQuestions = [
             () => { const x = randInt(2, 10), a = randInt(2, 5), b = randInt(1, 10); const c = a * x + b; return { question: `Jika ${a}x + ${b} = ${c}, berapakah nilai x?`, answer: x, hint: "Isolasi variabel x untuk menemukan nilainya.", isDailyChallenge: true, category: 'algebra', explanation: `Pertama, kurangi kedua sisi dengan ${b}: ${a}x = ${c} - ${b} ‚Üí ${a}x = ${a*x}. Lalu bagi kedua sisi dengan ${a}: x = ${a*x / a} ‚Üí x = ${x}.` }; },
            () => { const sisi = randInt(3, 7); return { question: `Volume sebuah kubus dengan panjang rusuk ${sisi} cm adalah? (cm¬≥)?`, answer: sisi * sisi * sisi, hint: "Volume kubus adalah rusuk pangkat tiga.", category: 'geometry', explanation: `Rumus volume kubus adalah sisi √ó sisi √ó sisi atau sisi¬≥. Dengan rusuk ${sisi} cm, volumenya adalah ${sisi}¬≥ = ${sisi*sisi*sisi} cm¬≥.` }; },
            () => { return { question: `Berapakah peluang munculnya angka genap pada lemparan sebuah dadu? (jawaban dalam desimal)`, answer: 0.5, hint: "Jumlah sisi genap dibagi total sisi.", category: 'arithmetic', explanation: `Dadu memiliki 6 sisi (1,2,3,4,5,6). Sisi genap ada 3 (2,4,6). Peluang = (jumlah sisi genap) / (total sisi) = 3/6 = 0.5.` }; },
            () => { const x = randInt(2, 5), c = randInt(1, 5); return { question: `Jika f(x) = x¬≤ - ${c}, berapakah nilai f(${x})?`, answer: x * x - c, hint: "Ganti semua x dalam fungsi dengan angka yang diberikan.", isDailyChallenge: true, category: 'algebra', explanation: `Untuk mencari f(${x}), ganti setiap 'x' dalam fungsi f(x) = x¬≤ - ${c} dengan ${x}. Maka, f(${x}) = (${x})¬≤ - ${c} = ${x*x} - ${c} = ${x*x - c}.` }; },
            () => { const a = randInt(3, 6), b = randInt(3, 6); return { question: `Dalam segitiga siku-siku, jika sisi siku-sikunya ${a} cm dan ${b} cm, berapakah sisi miringnya? (cm)`, answer: Math.sqrt(a*a + b*b).toFixed(2), hint: "Gunakan teorema Pythagoras.", category: 'geometry', explanation: `Menurut teorema Pythagoras, sisi miring = ‚àö(sisi1¬≤ + sisi2¬≤) = ‚àö(${a}¬≤ + ${b}¬≤) = ‚àö(${a*a} + ${b*b}) = ‚àö${a*a + b*b} ‚âà ${Math.sqrt(a*a + b*b).toFixed(2)} cm.` }; },
            () => { const a = randInt(1, 5), b = randInt(1, 5); return { question: `Jika 2x + ${a} = ${b}, berapakah nilai x?`, answer: (b - a) / 2, hint: "Isolasi variabel x.", category: 'algebra', explanation: `Pertama, kurangi kedua sisi dengan ${a}: 2x = ${b} - ${a} ‚Üí 2x = ${b - a}. Lalu bagi kedua sisi dengan 2: x = ${b - a} / 2 ‚Üí x = ${(b - a) / 2}.` }; },
            () => { const num = randInt(10, 20); return { question: `Berapakah hasil dari ‚àö${num * num}?`, answer: num, hint: "Akar kuadrat dari bilangan kuadrat sempurna adalah bilangan bulat.", category: 'arithmetic', explanation: `Karena ${num} √ó ${num} = ${num * num}, maka ‚àö${num * num} = ${num}.` }; },
            () => { const a = randInt(2, 5), b = randInt(2, 5); return { question: `Jika ${a}x = ${b}x + ${a*b}, berapakah nilai x?`, answer: b, hint: "Kumpulkan semua suku x di satu sisi.", category: 'algebra', explanation: `Pertama, kurangi kedua sisi dengan ${b}x: ${a}x - ${b}x = ${a*b} ‚Üí ${a - b}x = ${a*b}. Lalu bagi kedua sisi dengan ${a - b}: x = ${a*b} / ${a - b} ‚Üí x = ${b}.` }; }
        ];
        const extremeQuestions = [
            () => ({ question: "Berapakah hasil dari sin(30¬∞) + cos(60¬∞)? (dalam desimal)", answer: 1, hint: "Gunakan nilai dari sudut-sudut istimewa trigonometri.", category: 'geometry', explanation: `Nilai sudut istimewa trigonometri adalah sin(30¬∞) = 0.5 dan cos(60¬∞) = 0.5. Jadi, 0.5 + 0.5 = 1.` }),
            () => { const a = randInt(2, 5), b = randInt(2, 5); return { question: `Turunan dari f(x) = ${a}x¬≤ + ${b}x adalah? (format: 4x+2)`, answer: `${2 * a}x+${b}`, hint: "Gunakan aturan pangkat: d/dx(ax^n) = n*ax^(n-1).", category: 'algebra', explanation: `Menggunakan aturan turunan pangkat, turunan dari ${a}x¬≤ adalah 2 √ó ${a}x¬π = ${2*a}x. Turunan dari ${b}x adalah ${b}. Jadi, turunannya adalah ${2*a}x + ${b}.` }; },
            () => { const a = randInt(2, 4), b = randInt(3, 5); return { question: `Jika 2^${a} √ó 2^${b} = 2^x, maka nilai x adalah?`, answer: a + b, hint: "Jika basisnya sama, pangkatnya dijumlahkan.", category: 'algebra', explanation: `Menurut aturan eksponen, a^m √ó a^n = a^(m+n). Jadi, 2^${a} √ó 2^${b} = 2^(${a}+${b}). Maka, nilai x adalah ${a+b}.` }; },
            () => { const a = randInt(1, 5), b = randInt(1, 5); const sum = a + b, prod = a * b; return { question: `Jika a + b = ${sum} dan ab = ${prod}, maka a¬≤ + b¬≤ = ?`, answer: a * a + b * b, hint: "Ingat bahwa (a+b)¬≤ = a¬≤ + b¬≤ + 2ab.", isDailyChallenge: true, category: 'algebra', explanation: `Kita bisa menggunakan identitas aljabar (a+b)¬≤ = a¬≤ + b¬≤ + 2ab. Dengan mengubah urutannya, kita dapatkan a¬≤ + b¬≤ = (a+b)¬≤ - 2ab. Maka, a¬≤ + b¬≤ = (${sum})¬≤ - 2(${prod}) = ${sum*sum} - ${2*prod} = ${sum*sum - 2*prod}.` }; },
            () => { const a = randInt(3, 6), b = randInt(3, 6), c = randInt(1, 3); return { question: `Selesaikan persamaan kuadrat: x¬≤ - ${a + b}x + ${a * b} = 0`, answer: `${a},${b}`, hint: "Faktorkan persamaan kuadrat.", category: 'algebra', explanation: `Persamaan x¬≤ - ${a + b}x + ${a * b} = 0 dapat difaktorkan menjadi (x - ${a})(x - ${b}) = 0. Jadi solusinya adalah x = ${a} atau x = ${b}.` }; },
            () => { const a = randInt(2, 5), b = randInt(2, 5); return { question: `Integral dari ${a}x + ${b} terhadap x adalah? (format: 2x^2+3x+C)`, answer: `${a/2}x^2+${b}x+C`, hint: "Gunakan aturan pangkat untuk integral.", category: 'algebra', explanation: `Integral dari ${a}x adalah ${a/2}x¬≤ dan integral dari ${b} adalah ${b}x. Jangan lupa tambahkan konstanta integrasi C.` }; },
            () => { const a = randInt(2, 5), b = randInt(2, 5); return { question: `Logaritma basis ${a} dari ${Math.pow(a, b)} adalah?`, answer: b, hint: "Ingat definisi logaritma.", category: 'arithmetic', explanation: `Logaritma basis ${a} dari ${Math.pow(a, b)} adalah eksponen yang membuat ${a}^x = ${Math.pow(a, b)}, yaitu ${b}.` }; },
            () => { const a = randInt(1, 3), b = randInt(1, 3); return { question: `Berapakah determinan dari matriks [[${a}, ${b}], [${b}, ${a}]]?`, answer: a*a - b*b, hint: "Determinan matriks 2x2 [[a,b],[c,d]] adalah ad - bc.", category: 'algebra', explanation: `Determinan dari [[${a}, ${b}], [${b}, ${a}]] adalah (${a} √ó ${a}) - (${b} √ó ${b}) = ${a*a} - ${b*b} = ${a*a - b*b}.` }; }
        ];

        function generateQuestion(difficulty) {
            let questionBank;
            switch(difficulty) {
                case 'easy': questionBank = easyQuestions; break;
                case 'medium': questionBank = mediumQuestions; break;
                case 'hard': questionBank = hardQuestions; break;
                case 'extreme': questionBank = extremeQuestions; break;
                default: questionBank = easyQuestions;
            }

            let availableIndices = Array.from({length: questionBank.length}, (_, i) => i)
                .filter(i => !usedQuestions.has(`${difficulty}-${i}`));

            if (availableIndices.length === 0) {
                usedQuestions.clear();
                availableIndices = Array.from({length: questionBank.length}, (_, i) => i);
            }

            const randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
            usedQuestions.add(`${difficulty}-${randomIndex}`);
            
            const questionGenerator = questionBank[randomIndex];
            const generated = questionGenerator();
            
            // Re-engineer the explanation if it's a function
            if (typeof generated.explanation === 'function') {
                const q = generated.question;
                const a = generated.answer;
                const p = q.match(/-?\d+(\.\d+)?/g) || []; // Extract numbers from question
                generated.explanation = generated.explanation(q, a, p);
            }

            if (useOptions) {
                generated.options = generateOptions(generated.answer);
            }

            return generated;
        }

        function generateOptions(correctAnswer) {
            const options = [correctAnswer];
            const answerType = typeof correctAnswer;

            if (answerType === 'number') {
                const num = parseFloat(correctAnswer);
                let range = Math.max(5, Math.abs(num * 0.3));
    
                while (options.length < 4) {
                    let option = (Math.random() > 0.5) ? num + ((Math.random() * range) + 1) : num - ((Math.random() * range) + 1);
                    option = Math.max(0, Math.round(option * 100) / 100);
                    if (!options.includes(option)) options.push(option);
                }
            } else { 
                 const similarOptions = [correctAnswer.toString().split('').reverse().join(''), correctAnswer.toString().toUpperCase(), "salah"];
                 similarOptions.forEach(opt => { if(options.length < 4 && !options.includes(opt)) options.push(opt); });
                 while(options.length < 4) options.push(`opsi ${options.length + 1}`);
            }
            return shuffleArray(options);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    </script>
</body>
</html>
