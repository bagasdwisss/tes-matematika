<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matematika Kuis</title>
    <style>
        :root {
            --primary: #4a6bff;
            --secondary: #f5f7ff;
            --accent: #ff6b6b;
            --text: #333;
            --light-text: #666;
            --background: #fff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --dark-bg: #1a1a2e;
            --dark-text: #f0f0f0;
            --dark-secondary: #16213e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--secondary);
            color: var(--text);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background-color: var(--background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .dark-mode header {
            background-color: var(--dark-secondary);
            color: var(--dark-text);
        }

        h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .difficulty-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .difficulty-btn:hover {
            transform: translateY(-3px);
        }

        .easy {
            background-color: #6bce70;
            color: white;
        }

        .medium {
            background-color: #f0ad4e;
            color: white;
        }

        .hard {
            background-color: #d9534f;
            color: white;
        }

        .extreme {
            background-color: #5d3a9b;
            color: white;
        }

        .settings-panel {
            background-color: var(--background);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .dark-mode .settings-panel {
            background-color: var(--dark-secondary);
        }

        .settings-title {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .settings-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .quiz-container {
            display: none;
            background-color: var(--background);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .dark-mode .quiz-container {
            background-color: var(--dark-secondary);
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .dark-mode .quiz-header {
            border-bottom-color: #444;
        }

        .level-info {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .score-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .score {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .question-container {
            margin-bottom: 30px;
        }

        .question {
            font-size: 1.3rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .answer-field {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            margin-bottom: 15px;
            transition: border 0.3s;
            background-color: var(--background);
            color: var(--text);
        }

        .dark-mode .answer-field {
            background-color: #16213e;
            border-color: #444;
            color: var(--dark-text);
        }

        .answer-field:focus {
            border-color: var(--primary);
            outline: none;
        }

        .answer-options {
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .option-btn {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            background-color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .dark-mode .option-btn {
            background-color: #16213e;
            border-color: #444;
            color: var(--dark-text);
        }

        .option-btn:hover {
            border-color: var(--primary);
            background-color: var(--secondary);
        }

        .dark-mode .option-btn:hover {
            background-color: #1a1a2e;
        }

        .quiz-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .hint-btn {
            background-color: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--light-text);
            transition: color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dark-mode .hint-btn {
            color: #aaa;
        }

        .hint-btn:hover {
            color: var(--primary);
        }

        .submit-btn {
            padding: 12px 25px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .submit-btn:hover {
            background-color: #3a5bed;
        }
        
        .clear-btn {
            background-color: #6c757d;
        }
        .clear-btn:hover {
            background-color: #5a6268;
        }

        .scratch-pad {
            margin-top: 30px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            height: 200px;
            width: 100%;
            background-color: white;
        }

        .dark-mode .scratch-pad {
            border-color: #444;
            background-color: #16213e;
        }

        .stats-container {
            background-color: var(--background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: none;
            transition: all 0.3s ease;
        }

        .dark-mode .stats-container {
            background-color: var(--dark-secondary);
        }

        .stats-title {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background-color: var(--secondary);
            padding: 15px;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
        }

        .dark-mode .stat-item {
            background-color: #1a1a2e;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--light-text);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .hint-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .hint-content {
            background-color: var(--background);
            padding: 25px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .dark-mode .hint-content {
            background-color: var(--dark-secondary);
        }

        .hint-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .hint-title {
            color: var(--primary);
            font-size: 1.3rem;
        }

        .close-hint {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
        }

        .hint-text {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .hint-points {
            color: var(--accent);
            font-weight: bold;
        }

        .result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .result-content {
            background-color: var(--background);
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .dark-mode .result-content {
            background-color: var(--dark-secondary);
        }

        .result-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .correct {
            color: #6bce70;
        }

        .incorrect {
            color: #d9534f;
        }

        .result-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .result-message {
            margin-bottom: 20px;
            color: var(--light-text);
            line-height: 1.5;
        }

        .result-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .next-btn {
            background-color: var(--primary);
            color: white;
        }

        .next-btn:hover {
            background-color: #3a5bed;
        }

        .home-btn {
            background-color: #eee;
            color: var(--text);
        }

        .dark-mode .home-btn {
            background-color: #444;
            color: var(--dark-text);
        }

        .home-btn:hover {
            background-color: #ddd;
        }

        .dark-mode .home-btn:hover {
            background-color: #555;
        }

        /* New styles for additional features */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        .timer-container {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 1.1rem;
        }

        .timer {
            font-weight: bold;
            color: var(--primary);
        }

        .streak-container {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 15px;
        }

        .streak-count {
            font-weight: bold;
            color: #ff9500;
        }

        .leaderboard-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background-color: #5d3a9b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        .daily-challenge-btn {
            position: fixed;
            bottom: 140px;
            right: 20px;
            background-color: #6bce70;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        .leaderboard-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .leaderboard-content {
            background-color: var(--background);
            padding: 25px;
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 90%;
            box-shadow: var(--shadow);
            max-height: 80vh;
            overflow-y: auto;
        }

        .dark-mode .leaderboard-content {
            background-color: var(--dark-secondary);
        }

        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .leaderboard-title {
            color: var(--primary);
            font-size: 1.5rem;
        }

        .close-leaderboard {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th, 
        .leaderboard-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .dark-mode .leaderboard-table th,
        .dark-mode .leaderboard-table td {
            border-bottom-color: #444;
        }

        .leaderboard-table th {
            background-color: var(--secondary);
            font-weight: bold;
        }

        .dark-mode .leaderboard-table th {
            background-color: #1a1a2e;
        }

        .leaderboard-table tr:nth-child(even) {
            background-color: var(--secondary);
        }

        .dark-mode .leaderboard-table tr:nth-child(even) {
            background-color: #1a1a2e;
        }

        .user-rank {
            font-weight: bold;
            color: var(--primary);
        }

        .share-btn {
            background-color: #4a6bff;
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .share-btn:hover {
            background-color: #3a5bed;
        }

        .daily-challenge-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .daily-challenge-content {
            background-color: var(--background);
            padding: 25px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow);
        }

        .dark-mode .daily-challenge-content {
            background-color: var(--dark-secondary);
        }

        .daily-challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .daily-challenge-title {
            color: var(--primary);
            font-size: 1.5rem;
        }

        .close-daily-challenge {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
        }

        .daily-challenge-badge {
            display: inline-block;
            background-color: #6bce70;
            color: white;
            padding: 5px 10px;
            border-radius: var(--border-radius);
            font-weight: bold;
            margin-bottom: 15px;
        }

        .progress-container {
            width: 100%;
            background-color: #eee;
            border-radius: var(--border-radius);
            margin: 15px 0;
            height: 20px;
        }

        .dark-mode .progress-container {
            background-color: #444;
        }

        .progress-bar {
            height: 100%;
            border-radius: var(--border-radius);
            background-color: var(--primary);
            width: 0%;
            transition: width 0.3s;
        }

        .fun-fact {
            background-color: var(--secondary);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            font-style: italic;
        }

        .dark-mode .fun-fact {
            background-color: #1a1a2e;
        }

        .streak-fire {
            color: #ff9500;
            animation: pulse 1.5s infinite;
        }

        .fun-fact {
            background-color: var(--secondary);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            font-style: italic;
            position: relative;
            overflow: hidden;
            min-height: 60px; /* Sesuaikan tinggi minimum */
        }

        .dark-mode .fun-fact {
            background-color: #1a1a2e;
        }

        .fun-fact-content {
            position: relative;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fun-fact strong {
            display: block;
            margin-bottom: 5px;
            color: var(--primary);
        }

        /* Tambahkan ini di CSS */
.fun-fact::before {
    content: "💡";
    position: absolute;
    left: 10px;
    top: 10px;
    opacity: 0.2;
    font-size: 2rem;
    z-index: 0;
}

.fun-fact:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.dark-mode .fun-fact:hover {
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @media (max-width: 768px) {
            .difficulty-selector {
                flex-direction: column;
                align-items: center;
            }

            .difficulty-btn {
                width: 100%;
            }

            .answer-options {
                grid-template-columns: 1fr;
            }

            .quiz-controls {
                flex-direction: column;
                gap: 15px;
            }
            .action-buttons {
                width: 100%;
                justify-content: space-between;
            }
            .hint-btn {
                order: -1;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .theme-toggle, 
            .leaderboard-btn,
            .daily-challenge-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .leaderboard-btn {
                bottom: 70px;
            }

            .daily-challenge-btn {
                bottom: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Matematika Kuis</h1>
            <p>Uji kemampuan matematika Anda dengan berbagai tingkat kesulitan!</p>
        </header>

        <div class="settings-panel">
            <h2 class="settings-title">Pengaturan</h2>
            <div class="settings-options">
                <label>
                    <span>Gunakan Opsi Jawaban:</span>
                    <label class="switch">
                        <input type="checkbox" id="useOptionsToggle">
                        <span class="slider"></span>
                    </label>
                </label>
                <label>
                    <span>Mode Gelap:</span>
                    <label class="switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </label>
            </div>
        </div>

        <div class="difficulty-selector">
            <button class="difficulty-btn easy" data-difficulty="easy">Mudah</button>
            <button class="difficulty-btn medium" data-difficulty="medium">Menengah</button>
            <button class="difficulty-btn hard" data-difficulty="hard">Sulit</button>
            <button class="difficulty-btn extreme" data-difficulty="extreme">Ekstrem</button>
        </div>

        <div class="quiz-container" id="quizContainer">
            <div class="quiz-header">
                <div class="level-info">
                    Level <span id="currentLevel">1</span>/20 - 
                    <span id="difficultyDisplay">Mudah</span>
                    <div class="streak-container">
                        <span class="streak-fire">🔥</span>
                        <span class="streak-count" id="streakCount">0</span>
                    </div>
                </div>
                <div class="score-container">
                    <span>Poin:</span>
                    <span class="score" id="currentScore">0</span>
                    <div class="timer-container">
                        <span>⏱️</span>
                        <span class="timer" id="timer">0</span>
                    </div>
                </div>
            </div>

            <div class="question-container">
                <div class="question" id="questionText"></div>
                
                <input type="text" class="answer-field" id="answerInput" placeholder="Masukkan jawaban Anda...">
                
                <div class="answer-options" id="answerOptions">
                    </div>
            </div>

            <div class="quiz-controls">
                <button class="hint-btn" id="hintBtn">
                    <span>💡</span> Tips (-5 poin)
                </button>
                <div class="action-buttons">
                    <button class="submit-btn clear-btn" id="clearCanvasBtn">Bersihkan</button>
                    <button class="submit-btn" id="submitBtn">Submit</button>
                </div>
            </div>

            <div class="scratch-pad" id="scratchPad"></div>
        </div>

        <div class="stats-container" id="statsContainer">
            <h2 class="stats-title">Statistik Permainan</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Waktu per Level</div>
                    <div class="stat-value" id="timePerLevel">0 detik</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Percobaan Gagal</div>
                    <div class="stat-value" id="failedAttempts">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Kecepatan</div>
                    <div class="stat-value" id="speedStat">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Tips Digunakan</div>
                    <div class="stat-value" id="hintsUsed">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Streak Terbaik</div>
                    <div class="stat-value" id="bestStreak">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Level Tertinggi</div>
                    <div class="stat-value" id="highestLevel">0</div>
                </div>
            </div>
            <button class="share-btn" id="shareBtn">
                <span>📤</span> Bagikan Hasil
            </button>
        </div>

        <div class="fun-fact" id="funFact">
            <strong>Fakta Menarik:</strong> Tahukah Anda bahwa angka 0.999... (angka 9 berulang tak terbatas) sebenarnya sama dengan 1?
        </div>
    </div>

    <div class="hint-modal" id="hintModal">
        <div class="hint-content">
            <div class="hint-header">
                <h3 class="hint-title">Tips Penyelesaian</h3>
                <button class="close-hint" id="closeHint">&times;</button>
            </div>
            <div class="hint-text" id="hintText"></div>
            <p>Anda akan kehilangan <span class="hint-points">5 poin</span> untuk melihat tips ini.</p>
        </div>
    </div>

    <div class="result-modal" id="resultModal">
        <div class="result-content">
            <div class="result-icon correct" id="resultIcon">✓</div>
            <h3 class="result-title" id="resultTitle">Jawaban Benar!</h3>
            <p class="result-message" id="resultMessage"></p>
            <div class="result-actions">
                <button class="modal-btn home-btn" id="homeBtn">Beranda</button>
                <button class="modal-btn next-btn" id="nextBtn">Level Berikutnya</button>
            </div>
        </div>
    </div>

    <div class="leaderboard-modal" id="leaderboardModal">
        <div class="leaderboard-content">
            <div class="leaderboard-header">
                <h3 class="leaderboard-title">Papan Peringkat</h3>
                <button class="close-leaderboard" id="closeLeaderboard">&times;</button>
            </div>
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>Peringkat</th>
                        <th>Nama</th>
                        <th>Skor</th>
                        <th>Level</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    <!-- Leaderboard data will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="daily-challenge-modal" id="dailyChallengeModal">
        <div class="daily-challenge-content">
            <div class="daily-challenge-header">
                <h3 class="daily-challenge-title">Tantangan Harian</h3>
                <button class="close-daily-challenge" id="closeDailyChallenge">&times;</button>
            </div>
            <div class="daily-challenge-badge">Hari Ini: Aljabar Dasar</div>
            <p>Selesaikan 5 soal aljabar untuk mendapatkan poin bonus!</p>
            <div class="progress-container">
                <div class="progress-bar" id="challengeProgress" style="width: 0%"></div>
            </div>
            <p>Progress: <span id="challengeProgressText">0</span>/5</p>
            <div class="fun-fact">
                <strong>Fakta Menarik:</strong> Kata "aljabar" berasal dari bahasa Arab "al-jabr" yang berarti "penyatuan bagian yang rusak".
            </div>
        </div>
    </div>

    <!-- Floating action buttons -->
    <button class="theme-toggle" id="themeToggle">🌓</button>
    <button class="leaderboard-btn" id="leaderboardBtn">🏆</button>
    <button class="daily-challenge-btn" id="dailyChallengeBtn">📅</button>

    <script>
        // Variabel global
        let currentDifficulty = '';
        let currentLevel = 1;
        let currentScore = 0;
        let useOptions = false;
        let hintsUsed = 0;
        let failedAttempts = 0;
        let levelStartTime = 0;
        let levelTimes = [];
        let currentQuestion = {};
        let canvas;
        let ctx;
        let timerInterval;
        let currentStreak = 0;
        let bestStreak = 0;
        let highestLevel = 0;
        let dailyChallengeProgress = 0;
        let dailyChallengeCompleted = false;
        let darkMode = false;

        // Data leaderboard dummy (bisa diganti dengan data dari localStorage atau backend)
        let leaderboardData = [
            { name: "Anda", score: 0, level: 0 },
            { name: "Matematikus", score: 450, level: 20 },
            { name: "Pecinta Angka", score: 380, level: 18 },
            { name: "Ahli Aljabar", score: 320, level: 16 },
            { name: "Raja Geometri", score: 290, level: 15 }
        ];

        // Fakta matematika acak
        const mathFacts = [
            // --- Fakta Angka & Teori Bilangan ---
            "Konstanta Kaprekar: Pilih angka 4 digit dengan setidaknya dua digit berbeda, urutkan menurun dan menaik, kurangi hasilnya. Ulangi prosesnya, dan Anda akan selalu berakhir di angka 6174.",
            "Bilangan Vampir adalah bilangan yang 'dapat dihidupkan kembali' oleh dua 'taring' (faktor) yang diambil dari digitnya sendiri. Contoh: 2187 = 27 × 81.",
            "Dalam sekelompok 23 orang, peluang dua orang memiliki tanggal ulang tahun yang sama lebih dari 50%. Ini dikenal sebagai Paradoks Ulang Tahun.",
            "Angka 7 adalah angka yang paling mungkin muncul saat Anda melempar dua dadu (peluang 1/6).",
            "Hukum Benford menyatakan bahwa dalam banyak kumpulan data di dunia nyata, angka 1 cenderung muncul sebagai digit pertama sekitar 30% dari waktu.",
            "Bilangan Armstrong (atau Narsisistik) adalah bilangan yang sama dengan jumlah digit-digitnya yang dipangkatkan dengan jumlah digit. Contoh: 153 = 1³ + 5³ + 3³.",
            "Tidak ada satu pun bilangan prima yang berakhiran 5, kecuali angka 5 itu sendiri.",
            "Jumlah dari semua bilangan dari 1 hingga 100 (yaitu 1+2+...+100) adalah 5050.",
            "Teorema Terakhir Fermat, yang menyatakan tidak ada bilangan bulat positif a, b, dan c yang dapat memenuhi persamaan aⁿ + bⁿ = cⁿ untuk n > 2, baru terbukti setelah 358 tahun.",
            "Persamaan Euler, e^(iπ) + 1 = 0, dianggap sebagai salah satu persamaan terindah karena menghubungkan lima konstanta matematika paling fundamental.",
            "Ada 'bilangan aneh' (weird numbers), yaitu bilangan yang berlimpah tetapi tidak semi-sempurna. Angka 70 adalah yang terkecil.",
            "Setiap bilangan bulat ganjil dapat ditulis sebagai selisih dari dua bilangan kuadrat sempurna.",
            "Bilangan 'sociable' adalah generalisasi dari bilangan akrab dan sempurna, di mana jumlah pembaginya membentuk siklus. Siklus terpanjang yang diketahui memiliki 28 anggota.",
            "Jumlah dari kebalikan semua bilangan kuadrat (1/1² + 1/2² + 1/3² + ...) secara mengejutkan konvergen ke π²/6.",
            "Meskipun ada tak terhingga bilangan prima, 'celah' di antara mereka bisa menjadi sangat besar secara acak.",
            "Angka 'googolplex' adalah 10 pangkat googol (10^10^100), sebuah angka yang begitu besar sehingga tidak mungkin untuk menuliskannya di alam semesta yang teramati.",
            "Bilangan Palindromik adalah bilangan yang dibaca sama dari depan maupun belakang, seperti 12321.",
            "Nol (0) adalah satu-satunya bilangan yang memiliki sifat aditif (x+0=x) dan multiplikatif (x*0=0).",
            "Angka 13 dianggap sial di banyak budaya (triskaidekaphobia) sebagian karena ada 13 orang pada Perjamuan Terakhir.",
            "Sistem bilangan Babilionia Kuno menggunakan basis 60, yang merupakan alasan kita memiliki 60 detik dalam satu menit dan 360 derajat dalam satu lingkaran.",

            // --- Fakta Geometri & Topologi ---
            "Bentuk penutup lubang got (manhole) biasanya bulat karena itu adalah satu-satunya bentuk yang tidak bisa jatuh ke dalam lubang itu sendiri dari sudut mana pun.",
            "Sebuah Pita Möbius adalah permukaan dengan hanya satu sisi dan satu tepi. Jika Anda berjalan di sepanjang permukaannya, Anda akan kembali ke titik awal di sisi yang 'berlawanan'.",
            "Teorema Empat Warna menyatakan bahwa Anda hanya memerlukan empat warna untuk mewarnai peta apa pun sehingga tidak ada dua wilayah yang berdekatan memiliki warna yang sama.",
            "Masalah Jembatan Königsberg adalah teka-teki terkenal yang melahirkan bidang matematika baru yang disebut Teori Graf.",
            "Fraktal adalah pola tak berujung yang kompleks dan berulang pada skala yang berbeda. Contohnya termasuk kepingan salju dan pakis.",
            "Botol Klein adalah objek 4-dimensi yang tidak memiliki 'dalam' atau 'luar' yang dapat dibedakan.",
            "Dalam geometri non-Euklides, jumlah sudut dalam sebuah segitiga bisa lebih atau kurang dari 180 derajat.",
            "Turunan dari rumus volume bola (4/3πr³) terhadap jari-jarinya (r) adalah rumus luas permukaannya (4πr²).",
            "Ada lebih banyak persimpangan dalam simpul tali sepatu Anda daripada yang Anda kira; studi tentang ini disebut Teori Simpul.",
            "Anda tidak dapat menyisir rambut di bola berbulu tanpa menciptakan setidaknya satu 'pusaran' (cowlick). Ini adalah ilustrasi dari Teorema Bola Berbulu.",
            "Bentuk heksagon adalah cara paling efisien untuk mengisi bidang datar dengan bentuk yang sama, itulah sebabnya sarang lebah berbentuk heksagon.",
            "Golden Ratio (sekitar 1.618) sering muncul di alam, seni, dan arsitektur, dari Parthenon hingga cangkang nautilus.",
            "Sebuah 'tesseract' adalah analogi empat dimensi dari sebuah kubus.",
            "Geometri fraktal digunakan untuk membuat grafis komputer yang realistis untuk pemandangan alam seperti pegunungan dan pantai.",
            "Lingkaran memiliki rasio keliling terhadap diameter yang konstan (π), tetapi bentuk lain tidak.",
            "Luas segitiga dengan simpul pada koordinat bilangan bulat selalu merupakan kelipatan dari 1/2.",
            "Objek dengan dimensi fraktal dapat memiliki panjang tak terhingga dalam area yang terbatas.",
            "Pola Voronoi, yang membagi ruang menjadi wilayah berdasarkan kedekatan titik, ditemukan pada kulit jerapah dan sayap capung.",
            "Proyeksi stereografis memungkinkan pemetaan permukaan bola ke bidang datar, yang penting dalam kartografi dan matematika kompleks.",
            "Topologi sering disebut 'geometri lembaran karet' karena mempelajari sifat-sifat bentuk yang tidak berubah di bawah peregangan atau pembengkokan.",

            // --- Fakta Probabilitas & Logika ---
            "Paradoks Monty Hall menunjukkan bahwa pilihan intuitif dalam probabilitas seringkali salah. Peluang menang meningkat jika Anda mengubah pilihan Anda.",
            "Teorema Monyet Tak Terhingga menyatakan bahwa monyet yang mengetik secara acak di mesin tik untuk waktu tak terbatas pada akhirnya hampir pasti akan menghasilkan karya lengkap William Shakespeare.",
            "Paradoks Banach-Tarski secara kontroversial menyatakan bahwa sebuah bola dapat dipecah menjadi sejumlah bagian terbatas dan disusun kembali menjadi dua bola yang identik dengan aslinya.",
            "Teorema Ketidaklengkapan Gödel menunjukkan bahwa dalam sistem matematika formal apa pun, akan selalu ada pernyataan yang benar tetapi tidak dapat dibuktikan dalam sistem itu sendiri.",
            "Hukum Bilangan Besar yang Sesungguhnya menyatakan bahwa dengan ukuran sampel yang cukup besar, hal-hal yang paling aneh dan tidak mungkin pun bisa terjadi.",
            "Dalam permainan 'Rock, Paper, Scissors', strategi terbaik secara matematis adalah bermain secara acak.",
            "Peluang Anda memenangkan lotre utama seringkali lebih rendah daripada peluang Anda tersambar petir dalam hidup Anda.",
            "Sebuah setumpuk 52 kartu memiliki 52! (52 faktorial) kemungkinan urutan, sebuah angka yang lebih besar dari jumlah atom di Bumi.",
            "Rantai Markov adalah model matematika yang menggambarkan urutan peristiwa di mana probabilitas setiap peristiwa hanya bergantung pada keadaan peristiwa sebelumnya.",
            "Paradoks Simpson terjadi ketika sebuah tren muncul dalam beberapa kelompok data yang berbeda tetapi menghilang atau berbalik ketika kelompok-kelompok ini digabungkan.",
            "Jika Anda mengocok setumpuk kartu dengan benar, kemungkinan besar urutan kartu yang Anda dapatkan belum pernah ada sebelumnya dalam sejarah dunia.",
            "Peluang dua orang di kelas dengan 30 siswa tidak memiliki hari ulang tahun yang sama sangatlah kecil, hanya sekitar 29%.",
            "Sebuah 'langkah acak' (random walk) adalah jalur yang terdiri dari serangkaian langkah acak, sebuah konsep kunci dalam fisika dan pasar saham.",
            "Masalah Penjatahan Sekretaris adalah teka-teki probabilitas untuk menemukan strategi optimal untuk memilih kandidat terbaik dari sekelompok pelamar.",
            "Meskipun kelihatannya berlawanan dengan intuisi, rata-rata jumlah teman dari teman Anda hampir selalu lebih besar dari jumlah teman Anda sendiri (Paradoks Persahabatan).",

            // --- Fakta Sejarah & Lain-lain ---
            "Tanda sama dengan (=) diciptakan oleh matematikawan Robert Recorde pada tahun 1557 karena ia 'bosan menulis 'is equal to' berulang kali'.",
            "Kata 'aljabar' berasal dari bahasa Arab 'al-jabr', yang berarti 'penyatuan kembali bagian-bagian yang rusak', dari judul buku matematikawan Persia, Al-Khwarizmi.",
            "Kata 'algoritma' adalah latinisasi dari nama Al-Khwarizmi.",
            "Sophie Germain adalah seorang matematikawan wanita yang menggunakan nama samaran pria, 'Monsieur Le Blanc', untuk dapat berpartisipasi dalam komunitas matematika yang didominasi pria.",
            "Simbol tak terhingga (∞) disebut 'lemniscate'.",
            "Kata 'calculus' berasal dari bahasa Latin untuk 'kerikil kecil', yang digunakan untuk menghitung pada zaman kuno.",
            "Pythagoras, yang terkenal dengan teoremanya, juga memimpin sebuah kultus yang memuja angka dan percaya bahwa makan kacang adalah dosa.",
            "Sistem penulisan angka Romawi tidak memiliki konsep angka nol.",
            "René Descartes konon mendapatkan ide untuk sistem koordinat Kartesius saat melihat seekor lalat merayap di langit-langit kamarnya.",
            "Évariste Galois mengembangkan dasar-dasar teori grup dan teori Galois malam sebelum ia tewas dalam duel pada usia 20 tahun.",
            "Jari-jari kita dapat digunakan untuk sistem bilangan berbasis 10 (desimal), tetapi juga dapat digunakan untuk sistem berbasis 12 (duodesimal) dengan menggunakan ibu jari untuk menghitung ruas jari lainnya.",
            "Istilah 'hundred' berasal dari kata Norse kuno 'hundrath', yang sebenarnya berarti 120 (10 x 12).",
            "Matematika adalah satu-satunya 'sains' yang tidak memerlukan eksperimen untuk membuktikan kebenarannya; hanya logika dan pembuktian.",
            "Banyak arsitektur kuno, seperti Piramida Giza, dibangun dengan prinsip-prinsip matematika yang sangat canggih.",
            "Tanda plus (+) dan minus (-) pertama kali muncul dalam cetakan di Jerman pada akhir abad ke-15.",
            "Di Taiwan, angka 4 sering dihindari di gedung-gedung (seperti lantai 4) karena pengucapannya mirip dengan kata 'mati'.",
            "Dalam bahasa Inggris, 'forty' adalah satu-satunya angka yang hurufnya diurutkan secara alfabetis.",
            "Emmy Noether adalah seorang matematikawan revolusioner yang karyanya dalam aljabar abstrak menjadi dasar bagi banyak fisika modern.",
            "Sistem matriks dalam matematika dikembangkan secara luas oleh Arthur Cayley pada abad ke-19.",
            "John Napier, penemu logaritma, juga merancang berbagai 'tulang' (Napier's Bones) untuk mempermudah perkalian.",
            "Ada sekitar 1.771.47 cara berbeda untuk mengikat dasi, menurut ahli matematika Swedia.",
            "Jika sebuah pizza memiliki jari-jari 'z' dan ketebalan 'a', volumenya adalah Pi × z × z × a.",
            "Angka 1 diikuti oleh 100 angka nol disebut 'googol'.",
            "Notasi modern untuk π baru digunakan secara luas setelah diperkenalkan oleh Leonhard Euler pada tahun 1737.",
            "Matematika sering disebut sebagai 'Ratu Ilmu Pengetahuan' oleh Carl Friedrich Gauss.",
            "Kata 'trigonometri' berasal dari bahasa Yunani yang berarti 'pengukuran segitiga'.",
            "Orang Babilonia memecahkan persamaan kuadrat lebih dari 3000 tahun yang lalu.",
            "Hypatia dari Alexandria adalah salah satu matematikawan wanita pertama yang tercatat dalam sejarah.",
            "Konsep fungsi (y = f(x)) merupakan perkembangan penting dalam sejarah matematika yang memungkinkan pemodelan hubungan antar variabel.",
            "Bilangan imajiner (i, akar kuadrat dari -1) awalnya dianggap 'tidak mungkin' tetapi sekarang sangat penting dalam bidang teknik dan fisika.",
            "Sistem desimal modern (basis 10) berasal dari sistem angka Hindu-Arab.",
            "Teori Permainan (Game Theory) adalah cabang matematika yang digunakan dalam ekonomi, ilmu politik, dan biologi untuk memodelkan pengambilan keputusan strategis.",
            "Dalam bahasa Prancis, angka 90 disebut 'quatre-vingt-dix' yang secara harfiah berarti 'empat-dua puluh-sepuluh' (4 x 20 + 10).",
            "Selembar kertas yang sangat besar secara teoretis bisa dilipat hingga ke bulan, jika Anda bisa melipatnya 42 kali.",
            "Ada lebih banyak cara untuk mengatur catur di papan daripada jumlah elektron di alam semesta yang teramati (Nomor Shannon)."
        ];

        // Elemen DOM
        const quizContainer = document.getElementById('quizContainer');
        const difficultyDisplay = document.getElementById('difficultyDisplay');
        const currentLevelDisplay = document.getElementById('currentLevel');
        const currentScoreDisplay = document.getElementById('currentScore');
        const questionText = document.getElementById('questionText');
        const answerInput = document.getElementById('answerInput');
        const answerOptions = document.getElementById('answerOptions');
        const submitBtn = document.getElementById('submitBtn');
        const hintBtn = document.getElementById('hintBtn');
        const hintModal = document.getElementById('hintModal');
        const hintText = document.getElementById('hintText');
        const closeHint = document.getElementById('closeHint');
        const resultModal = document.getElementById('resultModal');
        const resultIcon = document.getElementById('resultIcon');
        const resultTitle = document.getElementById('resultTitle');
        const resultMessage = document.getElementById('resultMessage');
        const homeBtn = document.getElementById('homeBtn');
        const nextBtn = document.getElementById('nextBtn');
        const statsContainer = document.getElementById('statsContainer');
        const timePerLevelDisplay = document.getElementById('timePerLevel');
        const failedAttemptsDisplay = document.getElementById('failedAttempts');
        const speedStatDisplay = document.getElementById('speedStat');
        const hintsUsedDisplay = document.getElementById('hintsUsed');
        const scratchPad = document.getElementById('scratchPad');
        const useOptionsToggle = document.getElementById('useOptionsToggle');
        const clearCanvasBtn = document.getElementById('clearCanvasBtn');
        const themeToggle = document.getElementById('themeToggle');
        const timerDisplay = document.getElementById('timer');
        const streakCount = document.getElementById('streakCount');
        const bestStreakDisplay = document.getElementById('bestStreak');
        const highestLevelDisplay = document.getElementById('highestLevel');
        const leaderboardBtn = document.getElementById('leaderboardBtn');
        const leaderboardModal = document.getElementById('leaderboardModal');
        const leaderboardBody = document.getElementById('leaderboardBody');
        const closeLeaderboard = document.getElementById('closeLeaderboard');
        const dailyChallengeBtn = document.getElementById('dailyChallengeBtn');
        const dailyChallengeModal = document.getElementById('dailyChallengeModal');
        const closeDailyChallenge = document.getElementById('closeDailyChallenge');
        const challengeProgress = document.getElementById('challengeProgress');
        const challengeProgressText = document.getElementById('challengeProgressText');
        const funFact = document.getElementById('funFact');
        const shareBtn = document.getElementById('shareBtn');
        const darkModeToggle = document.getElementById('darkModeToggle');

        // Event Listeners
        document.querySelectorAll('.difficulty-btn').forEach(btn => {
            btn.addEventListener('click', startQuiz);
        });

        submitBtn.addEventListener('click', checkAnswer);
        hintBtn.addEventListener('click', showHint);
        closeHint.addEventListener('click', () => hintModal.style.display = 'none');
        homeBtn.addEventListener('click', goHome);
        nextBtn.addEventListener('click', nextLevel);
        useOptionsToggle.addEventListener('change', toggleAnswerOptions);
        clearCanvasBtn.addEventListener('click', clearCanvas);
        themeToggle.addEventListener('click', toggleTheme);
        leaderboardBtn.addEventListener('click', showLeaderboard);
        closeLeaderboard.addEventListener('click', () => leaderboardModal.style.display = 'none');
        dailyChallengeBtn.addEventListener('click', showDailyChallenge);
        closeDailyChallenge.addEventListener('click', () => dailyChallengeModal.style.display = 'none');
        shareBtn.addEventListener('click', shareResults);
        darkModeToggle.addEventListener('change', toggleDarkMode);

        // Load saved data from localStorage
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('mathQuizData');
            if (savedData) {
                const data = JSON.parse(savedData);
                bestStreak = data.bestStreak || 0;
                highestLevel = data.highestLevel || 0;
                dailyChallengeProgress = data.dailyChallengeProgress || 0;
                dailyChallengeCompleted = data.dailyChallengeCompleted || false;
                darkMode = data.darkMode || false;
                
                if (darkMode) {
                    document.body.classList.add('dark-mode');
                    darkModeToggle.checked = true;
                }
            }
            
            updateStats();
        }

        // Save data to localStorage
        function saveToLocalStorage() {
            const data = {
                bestStreak,
                highestLevel,
                dailyChallengeProgress,
                dailyChallengeCompleted,
                darkMode
            };
            localStorage.setItem('mathQuizData', JSON.stringify(data));
        }

        // Initialize
        loadFromLocalStorage();
        showRandomMathFact();

        // Fungsi untuk menampilkan fakta matematika acak
function showRandomMathFact() {
    const randomFact = mathFacts[Math.floor(Math.random() * mathFacts.length)];
    const factElement = document.getElementById('funFact');
    
    // Tambahkan animasi fade out
    factElement.style.opacity = '0';
    factElement.style.transition = 'opacity 0.5s ease';
    
    setTimeout(() => {
        factElement.innerHTML = `<div class="fun-fact-content"><strong>Fakta Menarik:</strong> ${randomFact}</div>`;
        factElement.style.opacity = '1';
    }, 500);
}

// Jalankan fungsi pertama kali saat halaman dimuat
showRandomMathFact();

// Set interval untuk mengganti fakta setiap 5 detik
let factInterval = setInterval(showRandomMathFact, 5000);

// Tambahkan juga ke bagian inisialisasi
function initCanvas() {
    // ... kode yang sudah ada ...
    
    // Hentikan interval sebelumnya jika ada
    if (factInterval) clearInterval(factInterval);
    // Mulai interval baru
    factInterval = setInterval(showRandomMathFact, 5000);
}

        function clearCanvas() {
            if (ctx && canvas) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }
        
        function initCanvas() {
            scratchPad.innerHTML = '';
            canvas = document.createElement('canvas');
            canvas.width = scratchPad.offsetWidth;
            canvas.height = scratchPad.offsetHeight;
            scratchPad.appendChild(canvas);
            
            ctx = canvas.getContext('2d');
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd);
            
            function startDrawing(e) {
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function draw(e) {
                if (!isDrawing) return;
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function stopDrawing() {
                isDrawing = false;
            }

            function getTouchPos(canvasDom, touchEvent) {
                const rect = canvasDom.getBoundingClientRect();
                return {
                    x: touchEvent.touches[0].clientX - rect.left,
                    y: touchEvent.touches[0].clientY - rect.top
                };
            }
            
            function handleTouchStart(e) {
                e.preventDefault();
                const touchPos = getTouchPos(canvas, e);
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touchPos.x,
                    clientY: touchPos.y
                });
                canvas.dispatchEvent(mouseEvent);
            }
            
            function handleTouchMove(e) {
                e.preventDefault();
                const touchPos = getTouchPos(canvas, e);
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touchPos.x,
                    clientY: touchPos.y
                });
                canvas.dispatchEvent(mouseEvent);
            }
            
            function handleTouchEnd(e) {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup', {});
                canvas.dispatchEvent(mouseEvent);
            }
        }

        // Fungsi untuk memulai kuis
        function startQuiz(e) {
            currentDifficulty = e.target.dataset.difficulty;
            currentLevel = 1;
            currentScore = 0;
            hintsUsed = 0;
            failedAttempts = 0;
            levelTimes = [];
            currentStreak = 0;
            
            switch(currentDifficulty) {
                case 'easy':
                    difficultyDisplay.textContent = 'Mudah';
                    break;
                case 'medium':
                    difficultyDisplay.textContent = 'Menengah';
                    break;
                case 'hard':
                    difficultyDisplay.textContent = 'Sulit';
                    break;
                case 'extreme':
                    difficultyDisplay.textContent = 'Ekstrem';
                    break;
            }
            
            quizContainer.style.display = 'block';
            statsContainer.style.display = 'block';
            
            initCanvas();
            startTimer();
            startLevel();
        }

        function startTimer() {
            let seconds = 0;
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                seconds++;
                timerDisplay.textContent = seconds;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // Fungsi untuk memulai level
        function startLevel() {
            clearCanvas();
            
            currentLevelDisplay.textContent = currentLevel;
            currentScoreDisplay.textContent = currentScore;
            streakCount.textContent = currentStreak;
            answerInput.value = '';
            answerInput.style.borderColor = '#ddd';
            
            currentQuestion = generateQuestion(currentDifficulty, currentLevel);
            questionText.textContent = currentQuestion.question;
            
            if (useOptions) {
                answerInput.style.display = 'none';
                answerOptions.style.display = 'grid';
                
                answerOptions.innerHTML = '';
                
                currentQuestion.options.forEach((option, index) => {
                    const optionBtn = document.createElement('button');
                    optionBtn.className = 'option-btn';
                    optionBtn.textContent = option;
                    optionBtn.dataset.value = option;
                    optionBtn.addEventListener('click', selectOption);
                    answerOptions.appendChild(optionBtn);
                });
            } else {
                answerInput.style.display = 'block';
                answerOptions.style.display = 'none';
            }
            
            levelStartTime = Date.now();
            
            updateStats();
        }

        function selectOption(e) {
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.style.borderColor = '#ddd';
                btn.style.backgroundColor = darkMode ? '#16213e' : 'white';
            });
            
            e.target.style.borderColor = 'var(--primary)';
            e.target.style.backgroundColor = darkMode ? '#1a1a2e' : 'var(--secondary)';
            
            answerInput.value = e.target.dataset.value;
        }

        function toggleAnswerOptions() {
            useOptions = useOptionsToggle.checked;
            
            if (quizContainer.style.display === 'block') {
                startLevel();
            }
        }

        function toggleTheme() {
            darkMode = !darkMode;
            document.body.classList.toggle('dark-mode');
            darkModeToggle.checked = darkMode;
            saveToLocalStorage();
        }

        function toggleDarkMode() {
            darkMode = darkModeToggle.checked;
            document.body.classList.toggle('dark-mode', darkMode);
            saveToLocalStorage();
        }

        function checkAnswer() {
            const userAnswer = answerInput.value.trim();
            
            if (!userAnswer) {
                answerInput.style.borderColor = 'var(--accent)';
                return;
            }
            
            const timeSpent = Math.floor((Date.now() - levelStartTime) / 1000);
            levelTimes.push(timeSpent);
            
            let isCorrect = false;

            // Toleransi untuk jawaban desimal
            if (!isNaN(userAnswer) && typeof currentQuestion.answer === 'number') {
                 isCorrect = Math.abs(parseFloat(userAnswer) - currentQuestion.answer) < 0.01;
            } else {
                 isCorrect = userAnswer.toLowerCase() === currentQuestion.answer.toString().toLowerCase();
            }
            
            showResult(isCorrect, timeSpent);
        }

        function showResult(isCorrect, timeSpent) {
            if (isCorrect) {
                resultIcon.className = 'result-icon correct';
                resultIcon.textContent = '✓';
                resultTitle.textContent = 'Jawaban Benar!';
                
                let maxPoints = 10;
                if (currentDifficulty === 'medium') maxPoints = 15;
                else if (currentDifficulty === 'hard') maxPoints = 20;
                else if (currentDifficulty === 'extreme') maxPoints = 25;
                
                maxPoints += Math.floor(currentLevel / 4);

                const timePenalty = Math.floor(timeSpent / 4);

                let pointsEarned = Math.max(1, maxPoints - timePenalty);
                
                // Bonus streak
                if (currentStreak > 0 && currentStreak % 3 === 0) {
                    const streakBonus = Math.floor(currentStreak / 3) * 5;
                    pointsEarned += streakBonus;
                    resultMessage.innerHTML = `Poin dasar: ${maxPoints}<br>Pengurangan waktu: -${timePenalty}<br>Bonus streak: +${streakBonus}<br><b>Poin diperoleh: ${pointsEarned}</b>`;
                } else {
                    resultMessage.innerHTML = `Poin dasar: ${maxPoints}<br>Pengurangan waktu: -${timePenalty}<br><b>Poin diperoleh: ${pointsEarned}</b>`;
                }
                
                currentScore += pointsEarned;
                currentStreak++;
                if (currentStreak > bestStreak) {
                    bestStreak = currentStreak;
                }
                
                // Update daily challenge progress if applicable
                if (currentQuestion.isDailyChallenge) {
                    dailyChallengeProgress++;
                    if (dailyChallengeProgress >= 5 && !dailyChallengeCompleted) {
                        dailyChallengeCompleted = true;
                        currentScore += 50; // Bonus for completing daily challenge
                        resultMessage.innerHTML += `<br><br>🎉 Anda menyelesaikan Tantangan Harian! +50 poin bonus!`;
                    }
                    saveToLocalStorage();
                }

            } else {
                resultIcon.className = 'result-icon incorrect';
                resultIcon.textContent = '✗';
                resultTitle.textContent = 'Jawaban Salah!';
                resultMessage.innerHTML = `Jawaban yang benar adalah: <b>${currentQuestion.answer}</b>`;
                
                currentScore = Math.max(0, currentScore - 5);
                failedAttempts++;
                currentStreak = 0;
            }
            
            // Update highest level
            if (currentLevel > highestLevel) {
                highestLevel = currentLevel;
            }
            
            currentScoreDisplay.textContent = currentScore;
            streakCount.textContent = currentStreak;
            updateStats();
            saveToLocalStorage();
            resultModal.style.display = 'flex';
            stopTimer();
        }

        function showHint() {
            hintText.textContent = currentQuestion.hint;
            hintModal.style.display = 'flex';
            
            closeHint.onclick = function() {
                hintModal.style.display = 'none';
                
                if (!currentQuestion.hintUsed) {
                    currentScore = Math.max(0, currentScore - 5);
                    currentScoreDisplay.textContent = currentScore;
                    hintsUsed++;
                    updateStats();
                    currentQuestion.hintUsed = true;
                }
            };
        }

        function nextLevel() {
            resultModal.style.display = 'none';
            
            if (currentLevel < 20) {
                currentLevel++;
                startLevel();
                startTimer();
            } else {
                quizCompleted();
            }
        }

        function quizCompleted() {
            resultTitle.textContent = 'Kuis Selesai!';
            resultMessage.textContent = `Total poin Anda: ${currentScore}`;
            nextBtn.style.display = 'none';
            resultModal.style.display = 'flex';
            
            // Update leaderboard with user's score
            leaderboardData[0].score = currentScore;
            leaderboardData[0].level = currentLevel;
            saveToLocalStorage();
        }

        function goHome() {
            resultModal.style.display = 'none';
            quizContainer.style.display = 'none';
            statsContainer.style.display = 'none';
            stopTimer();
        }

        function updateStats() {
            if (levelTimes.length > 0) {
                const lastLevelTime = levelTimes[levelTimes.length - 1];
                timePerLevelDisplay.textContent = `${lastLevelTime} detik`;
            }
            
            failedAttemptsDisplay.textContent = failedAttempts;
            
            hintsUsedDisplay.textContent = hintsUsed;
            
            bestStreakDisplay.textContent = bestStreak;
            highestLevelDisplay.textContent = highestLevel;
            
            if (levelTimes.length > 0) {
                const avgTime = Math.round(levelTimes.reduce((a, b) => a + b, 0) / levelTimes.length);
                speedStatDisplay.textContent = `${avgTime} detik/level`;
            } else {
                 speedStatDisplay.textContent = `-`;
            }
        }

        function showLeaderboard() {
            // Sort leaderboard by score (descending)
            const sortedLeaderboard = [...leaderboardData].sort((a, b) => b.score - a.score);
            
            leaderboardBody.innerHTML = '';
            
            sortedLeaderboard.forEach((user, index) => {
                const row = document.createElement('tr');
                if (user.name === "Anda") {
                    row.classList.add('user-rank');
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.name}</td>
                    <td>${user.score}</td>
                    <td>${user.level}</td>
                `;
                
                leaderboardBody.appendChild(row);
            });
            
            leaderboardModal.style.display = 'flex';
        }

        function showDailyChallenge() {
            challengeProgress.style.width = `${(dailyChallengeProgress / 5) * 100}%`;
            challengeProgressText.textContent = dailyChallengeProgress;
            dailyChallengeModal.style.display = 'flex';
        }

        function shareResults() {
            const shareText = `Saya baru saja mencoba Matematika Kuis dan mendapatkan ${currentScore} poin di level ${currentLevel} (${currentDifficulty})! Coba tantang saya di sini!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Hasil Matematika Kuis',
                    text: shareText,
                    url: window.location.href
                }).catch(err => {
                    console.log('Error sharing:', err);
                    fallbackShare(shareText);
                });
            } else {
                fallbackShare(shareText);
            }
        }

        function fallbackShare(text) {
            // Copy to clipboard
            navigator.clipboard.writeText(text).then(() => {
                alert('Teks hasil telah disalin ke clipboard! Anda bisa membagikannya di media sosial.');
            }).catch(err => {
                console.error('Could not copy text: ', err);
                prompt('Salin teks berikut untuk membagikan hasil Anda:', text);
            });
        }

        // --- SISTEM PEMBUATAN SOAL BARU ---

        // Fungsi pembantu
        const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const getGcd = (a, b) => b === 0 ? a : getGcd(b, a % b);
        const getLcm = (a, b) => (a * b) / getGcd(a, b);
        
        function getPrimeFactorization(num) {
            const factors = {};
            let divisor = 2;
            while (num >= 2) {
                if (num % divisor === 0) {
                    factors[divisor] = (factors[divisor] || 0) + 1;
                    num /= divisor;
                } else {
                    divisor++;
                }
            }
            return Object.entries(factors).map(([base, exp]) => exp > 1 ? `${base}^${exp}` : `${base}`).join(' × ');
        }

        // BANK SOAL TINGKAT MUDAH (EASY)
        const easyQuestions = [
            () => {
                const a = randInt(10, 50);
                const b = randInt(10, 50);
                return { question: `Berapakah hasil dari ${a} + ${b}?`, answer: a + b, hint: "Jumlahkan kedua angka tersebut." };
            },
            () => {
                const a = randInt(5, 15);
                const b = randInt(2, 9);
                return { question: `Berapakah hasil dari ${a} × ${b}?`, answer: a * b, hint: "Kalikan kedua angka tersebut." };
            },
            () => {
                const den1 = 2, den2 = 4, num1 = 1, num2 = 1;
                return { question: `Berapakah hasil dari 1/${den1} + 1/${den2}? (jawaban dalam desimal)`, answer: 0.75, hint: "Samakan penyebutnya terlebih dahulu." };
            },
            () => {
                const numbers = [randInt(1, 5) * 2, randInt(1, 5) * 2 + 1, randInt(6, 10) * 2 + 1];
                const answer = numbers[0];
                return { question: `Manakah bilangan genap dari: ${shuffleArray(numbers).join(', ')}?`, answer, hint: "Bilangan genap adalah bilangan yang habis dibagi 2." };
            },
            () => {
                const jam = randInt(1, 12);
                const tambahan = randInt(2, 6);
                const answer = (jam + tambahan) % 12 || 12;
                return { question: `Jika sekarang jam ${jam}, jam berapakah ${tambahan} jam lagi?`, answer, hint: "Tambahkan jam sekarang dengan durasi waktu." };
            },
            () => ({ question: `1 kilometer sama dengan berapa meter?`, answer: 1000, hint: "Kilo berarti seribu." }),
            () => {
                const sisi = randInt(4, 10);
                return { question: `Sebuah persegi memiliki sisi ${sisi} cm. Berapakah kelilingnya (cm)?`, answer: 4 * sisi, hint: "Keliling persegi adalah 4 kali panjang sisinya." };
            },
             () => {
                const romanMap = {1:'I', 4:'IV', 5:'V', 9:'IX', 10:'X'};
                const num = [1,4,5,9,10][randInt(0,4)];
                return { question: `Angka romawi dari ${num} adalah?`, answer: romanMap[num], hint: 'Ingat kembali simbol dasar angka romawi.' };
            }
        ];

        // BANK SOAL TINGKAT SEDANG (MEDIUM)
        const mediumQuestions = [
            () => {
                const a = randInt(5, 15), b = randInt(2, 5), c = randInt(3, 10);
                return { question: `Berapakah hasil dari ${a} + ${b} × ${c}?`, answer: a + b * c, hint: "Kerjakan perkalian terlebih dahulu (aturan BODMAS/PEMDAS)." };
            },
            () => {
                const a = randInt(20, 50), b = randInt(100, 200);
                return { question: `${a}% dari ${b} adalah?`, answer: (a / 100) * b, hint: "Ubah persentase menjadi desimal (bagi 100), lalu kalikan." };
            },
            () => {
                const a = randInt(4, 10), b = randInt(11, 20);
                return { question: `KPK dari ${a} dan ${b} adalah?`, answer: getLcm(a, b), hint: "Kelipatan Persekutuan Terkecil." };
            },
            () => {
                const x = randInt(2, 10), b = randInt(5, 15);
                const c = x + b;
                return { question: `Jika x + ${b} = ${c}, berapakah nilai x?`, answer: x, hint: "Pindahkan angka ke sisi lain untuk menemukan nilai x." };
            },
            () => {
                const a = randInt(-15, -5), b = randInt(6, 20);
                return { question: `Berapakah hasil dari ${a} + ${b}?`, answer: a + b, hint: "Angka negatif ditambah positif sama dengan pengurangan." };
            },
            () => {
                const arr = [randInt(2, 5), randInt(6, 10), randInt(11, 15)];
                const answer = arr.reduce((sum, val) => sum + val, 0) / arr.length;
                return { question: `Berapakah rata-rata dari ${arr.join(', ')}?`, answer: parseFloat(answer.toFixed(2)), hint: "Jumlahkan semua angka lalu bagi dengan banyaknya angka." };
            },
            () => {
                const a = randInt(2, 6);
                const b = randInt(2, 5);
                return { question: `Berapakah hasil dari ${a}² + √${b*b}?`, answer: a * a + b, hint: "Hitung pangkat dan akar terlebih dahulu, baru jumlahkan." };
            },
            () => ({ question: `Sudut yang besarnya kurang dari 90 derajat disebut sudut...?`, answer: "lancip", hint: "Lawan dari sudut tumpul." })
        ];

        // BANK SOAL TINGKAT SULIT (HARD)
        const hardQuestions = [
             () => {
                const x = randInt(2, 10);
                const a = randInt(2, 5), b = randInt(1, 10);
                const c = a * x + b;
                return { question: `Jika ${a}x + ${b} = ${c}, berapakah nilai x?`, answer: x, hint: "Isolasi variabel x untuk menemukan nilainya.", isDailyChallenge: true };
            },
            () => {
                const num = randInt(20, 50);
                return { question: `Faktor prima dari ${num} adalah? (contoh: 2 x 3^2)`, answer: getPrimeFactorization(num), hint: "Bagi terus bilangan dengan bilangan prima terkecil." };
            },
            () => {
                const sisi = randInt(3, 7);
                return { question: `Volume sebuah kubus dengan panjang rusuk ${sisi} cm adalah? (cm³)?`, answer: sisi * sisi * sisi, hint: "Volume kubus adalah rusuk pangkat tiga." };
            },
            () => {
                return { question: `Berapakah peluang munculnya angka genap pada lemparan sebuah dadu? (jawaban dalam desimal)`, answer: 0.5, hint: "Jumlah sisi genap dibagi total sisi." };
            },
            () => {
                const x = randInt(2, 5);
                const c = randInt(1, 5);
                return { question: `Jika f(x) = x² - ${c}, berapakah nilai f(${x})?`, answer: x * x - c, hint: "Ganti semua x dalam fungsi dengan angka yang diberikan.", isDailyChallenge: true };
            },
            () => {
                const base = randInt(2, 3);
                const start = base * randInt(1, 3);
                const sequence = [start, start * base, start * base * base, start * base * base * base];
                return { question: `Lanjutkan deret berikut: ${sequence.slice(0,3).join(', ')}, ...`, answer: sequence[3], hint: "Perhatikan rasio perkalian antar suku." };
            }
        ];

        // BANK SOAL TINGKAT EKSTREM (EXTREME)
        const extremeQuestions = [
            () => ({ question: "Berapakah hasil dari sin(30°) + cos(60°)? (dalam desimal)", answer: 1, hint: "Gunakan nilai dari sudut-sudut istimewa trigonometri." }),
            () => {
                const a = randInt(2, 5), b = randInt(2, 5);
                return { question: `Turunan dari f(x) = ${a}x² + ${b}x adalah? (format: 12x+3)`, answer: `${2 * a}x+${b}`, hint: "Gunakan aturan pangkat: d/dx(ax^n) = n*ax^(n-1)." };
            },
            () => {
                const a = randInt(2, 4), b = randInt(3, 5);
                return { question: `Jika 2^${a} × 2^${b} = 2^x, maka nilai x adalah?`, answer: a + b, hint: "Jika basisnya sama, pangkatnya dijumlahkan." };
            },
            () => {
                const a = randInt(1, 5), b = randInt(1, 5), c = randInt(1, 5), d = randInt(1, 5);
                const real = a + c;
                const imag = b - d;
                return { question: `Berapakah hasil dari (${a} + ${b}i) + (${c} - ${d}i)? (format: 5+3i)`, answer: `${real}+${imag}i`, hint: "Jumlahkan bagian riil dengan riil, dan imajiner dengan imajiner." };
            },
            () => {
                const a = randInt(1, 5), b = randInt(1, 5);
                const sum = a + b, prod = a * b;
                return { question: `Jika a + b = ${sum} dan ab = ${prod}, maka a² + b² = ?`, answer: a * a + b * b, hint: "Ingat bahwa (a+b)² = a² + b² + 2ab.", isDailyChallenge: true };
            },
            () => ({ question: `Berapakah hasil dari integral ∫(2x) dx? (format: x^2+C)`, answer: "x^2+C", hint: "Gunakan aturan integral pangkat: ∫ax^n dx = (a/(n+1))x^(n+1) + C." })
        ];

        // Fungsi utama untuk generate soal
        function generateQuestion(difficulty) {
            let questionBank;
            switch(difficulty) {
                case 'easy':
                    questionBank = easyQuestions;
                    break;
                case 'medium':
                    questionBank = mediumQuestions;
                    break;
                case 'hard':
                    questionBank = hardQuestions;
                    break;
                case 'extreme':
                    questionBank = extremeQuestions;
                    break;
                default:
                    questionBank = easyQuestions;
            }

            // Pilih fungsi pembuat soal secara acak dari bank soal
            const questionGenerator = questionBank[Math.floor(Math.random() * questionBank.length)];
            const generated = questionGenerator();
            
            // Generate opsi jawaban jika diperlukan
            if (useOptions) {
                generated.options = generateOptions(generated.answer);
            }

            return generated;
        }

        function generateOptions(correctAnswer) {
            const options = [correctAnswer];
            const answerType = typeof correctAnswer;

            if (answerType === 'number') {
                const num = parseFloat(correctAnswer);
                let range = Math.max(5, Math.abs(num * 0.3));

                while (options.length < 4) {
                    let option;
                    const variation = (Math.random() * range) + 1;
                    
                    if (Math.random() > 0.5) {
                        option = num + variation;
                    } else {
                        option = num - variation;
                    }

                    option = Math.max(0, option); // Opsi tidak negatif
                    // Pembulatan agar opsi terlihat lebih rapi
                    option = Math.round(option * 100) / 100;
                    
                    if (!options.includes(option)) {
                        options.push(option);
                    }
                }
            } else { // Untuk jawaban teks
                 const similarOptions = [
                    correctAnswer.toString().split('').reverse().join(''), // Dibalik
                    correctAnswer.toString().toUpperCase(), // Huruf besar semua
                    "salah", // Opsi salah umum
                 ];
                 // Filter duplikat dan tambahkan ke opsi utama
                 similarOptions.forEach(opt => {
                    if(options.length < 4 && !options.includes(opt)){
                        options.push(opt);
                    }
                 });
                 // Jika masih kurang, tambahkan opsi acak
                 while(options.length < 4){
                    options.push(`opsi ${options.length +1}`);
                 }
            }
            
            return shuffleArray(options);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    </script>
</body>
</html>
